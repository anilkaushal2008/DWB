@model DWB.Models.DoctorAssessmentVM
@{ 
    ViewData["Title"] = "DoctorAssessment";
    string formAction = Model.DoctorAssessment.IntId == 0 ? "Create" : "Edit";
}
<style>
    .scale-radio {
        transform: scale(1.2); /* increase radio button size */
        margin-right: 2.9px; /* space between button and label text */
        cursor: pointer;
    }</style>
<main class="main-wrapper py-4">  
   <div class="container-fluid">
        <h4 class="mb-4 fw-bold text-primary">
            @(Model.DoctorAssessment.IntId > 0 ? "Edit Doctor Assessment" : "New Doctor Assessment")
        </h4>
        <div class="card p-2 border-0 shadow-sm rounded-3 mb-2 bg-light">
            <div class="d-flex flex-wrap align-items-center small text-dark fw-semibold">
                <span class="me-3 text-primary">Selected Patient|UHID: <span class="text-white">@Model.NursingAssessment.VchUhidNo</span></span>
                <span class="me-3 text-primary">Name: <span class="text-white">@Model.NursingAssessment.VchHmsname</span></span>
                <span class="me-3 text-primary">Visit No: <span class="text-white">@Model.NursingAssessment.IntIhmsvisit</span></span>
                <span><a class="btn btn-sm btn-grd-primary">View History</a> </span>&nbsp;
                <span><a class="btn btn-sm btn-grd-danger">Use last history</a> </span>&nbsp;
                <span><a class="btn btn-sm btn-grd-success" data-bs-toggle="modal" data-bs-target="#templateModal">Use Template</a> </span>
            </div>
        </div>
        <div class="card shadow-sm rounded-4">           
            <div class="card-body">
                
                <form method="post" id="DAssessment" enctype="multipart/form-data"
                      asp-action="@(Model.DoctorAssessment.IntId > 0 ? "DocAssmntEdit" : "DocAssmntCreate")" asp-controller="Assessment">
                    @Html.HiddenFor(m=>m.DoctorAssessment.DtStartTime)
                    @Html.HiddenFor(m => m.DoctorAssessment.FkUhid, new { id = "PatientId"})
                    @Html.HiddenFor(m => m.DoctorAssessment.FkAssessmentId)
                    @Html.HiddenFor(m => m.DoctorAssessment.FkVisitNo, new { id = "VisitNo"})
                    @Html.HiddenFor(m => m.DoctorAssessment.DtHmsentry)
                      @Html.HiddenFor(m => m.NursingAssessment.IntAssessmentId)
                    @* for edit assessment *@
                    @if(Model.DoctorAssessment.IntId != 0)
                    {
                        @Html.HiddenFor(mbox=>Model.DoctorAssessment.IntId)
                    }

                    <!-- Submit -->                   
                    <div align="right" class="text-end mt-1 my-1">
                        <button type="button" id="btnSaveTemplate" class="btn btn-warning btn-sm shadow-sm " data-bs-toggle="modal" data-bs-target="#saveTemplateModal">
                            💾 Save as Template
                        </button> &nbsp;
                        <button type="submit" class="btn btn-primary btn-sm shadow-sm">
                            @(Model.DoctorAssessment.IntId > 0 ? " 💾 Update Assessment" : " 💾 Save Assessment")
                        </button>
                    </div>
                    <!-- Nav Tabs -->
                    <ul class="nav nav-pills mb-3 justify-content-center" id="docAssessmentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patient" type="button" role="tab">
                                👤 Initial Assessment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clinical-tab" data-bs-toggle="tab" data-bs-target="#clinical" type="button" role="tab">
                                🩺 Clinical
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medicine-tab" data-bs-toggle="tab" data-bs-target="#medicine" type="button" role="tab">
                                💊 Medicines
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="lab-tab" data-bs-toggle="tab" data-bs-target="#lab" type="button" role="tab">
                                🧪 Lab
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="radiology-tab" data-bs-toggle="tab" data-bs-target="#radiology" type="button" role="tab">
                                🩻 Radiology
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="procedure-tab" data-bs-toggle="tab" data-bs-target="#procedure" type="button" role="tab">
                                💉 Procedure
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="followup-tab" data-bs-toggle="tab" data-bs-target="#followup" type="button" role="tab">
                                📅 Follow Up
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                                📂 Documents
                            </button>
                        </li>
                    </ul>
                   
                        <!-- Tab Content -->
                        <div class="tab-content" id="docAssessmentContent">
                        <!-- Patient -->
                        <hr />
                        <div class="tab-pane fade show active" id="patient" role="tabpanel">                         
                           <div class="row g-3">
                                <!-- VITAL SIGNS -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm  border-top border-primary rounded-3 text-white bg-light h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-primary d-flex align-items-center">
                                                💓 VITAL SIGNS
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">BP (MMHG):</strong> <span>@Model.NursingAssessment.VchBloodPressure</span></div>
                                                <div class="col-6"><strong class="text-secondary">PULSE:</strong> <span>@Model.NursingAssessment.VchPulse</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">TEMP (°F):</strong> <span>@Model.NursingAssessment.DecTemperature</span></div>
                                                <div class="col-6"><strong class="text-secondary">SPO₂ (%):</strong> <span>@Model.NursingAssessment.DecSpO2</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">WEIGHT (KG):</strong> <span>@Model.NursingAssessment.DecWeight</span></div>
                                                <div class="col-6"><strong class="text-secondary">HEIGHT (CM):</strong> <span>@Model.NursingAssessment.DecHeight</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">RESP RATE:</strong> <span>@Model.NursingAssessment.DecRespiratoryRate</span></div>
                                                <div class="col-6"><strong class="text-secondary">O₂ FLOW:</strong> <span>@Model.NursingAssessment.DecOxygenFlowRate</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAST HISTORY -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-danger bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-danger flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>🩺 PAST HISTORY
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">DIABETES:</strong> <span>@(Model.NursingAssessment.BitDiabetes ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">HEART DISEASE:</strong> <span>@(Model.NursingAssessment.BitHeartDisease ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">HYPERTENSION:</strong> <span>@(Model.NursingAssessment.BitHypertension ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">ASTHMA:</strong> <span>@(Model.NursingAssessment.BitAsthma ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">HIGH CHOLESTEROL:</strong> <span>@(Model.NursingAssessment.BitCholesterol ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">TUBERCULOSIS:</strong> <span>@(Model.NursingAssessment.BitTuberculosis ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">SURGERY:</strong> <span>@(Model.NursingAssessment.BitSurgery ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">HOSPITALIZED (LAST 3 MO):</strong> <span>@(Model.NursingAssessment.BitHospitalization ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2">
                                                <div class="col-12"><strong class="text-secondary">OTHER HISTORY:</strong> <span>@Model.NursingAssessment.VchOtherHistory</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div class="row g-3">
                                <!-- PERSONAL HISTORY -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-success bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-success d-flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>🧬 PERSONAL HISTORY
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2">
                                                <div class="col-6"><strong class="text-secondary">ALLERGIES:</strong> <span>@(Model.NursingAssessment.BitIsAllergical? Model.NursingAssessment.VchAllergicalDrugs : "N/A")</span></div>
                                                <div class="col-6"><strong class="text-secondary">ALCOHOL:</strong> <span>@(Model.NursingAssessment.BitIsAlcoholic ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">SMOKING:</strong> <span>@(Model.NursingAssessment.BitIsSmoking ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">LMP (FEMALES):</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchLmpForFemale) ? "N/A" : Model.NursingAssessment.VchLmpForFemale)</span></div>
                                                <div class="col-6"><strong class="text-secondary">OCCUPATION:</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchOccupation) ? "N/A" : Model.NursingAssessment.VchOccupation)</span></div>
                                                <div class="col-6"><strong class="text-secondary">PSYCHOLOGICAL STATUS:</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchSocialEconomicStatus) ? "N/A" : Model.NursingAssessment.VchSocialEconomicStatus)</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Support Document -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-info bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-info d-flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>📂 SUPPORTING DOCUMENTS
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2">
                                        <!-- Supporting Documents -->
                                        @if (Model.NursingAssessment.TblNassessmentDoc != null && Model.NursingAssessment.TblNassessmentDoc.Any())
                                            {
                                                @foreach (var document in Model.NursingAssessment.TblNassessmentDoc)
                                                {
                                                    <div class="col-auto text-center">
                                                        <a href="@Url.Content("~/uploads/NAssessment/" + document.VchFileName)" target="_blank" title="@document.VchFileName">
                                                            <div class="border rounded bg-white p-2 shadow-sm" style="width:70px; height:70px; display:flex; align-items:center; justify-content:center;">
                                                                <i class="fas fa-file-alt fa-2x text-info"></i>
                                                            </div>
                                                            <small class="d-block text-truncate" style="max-width:70px;">@document.VchFileName</small>
                                                        </a>
                                                    </div>
                                                }
                                            }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> 

                        <!-- Clinical -->
                        <div class="tab-pane fade" id="clinical" role="tabpanel">
                        <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                            <div class="row g-3">
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Chief Complaints<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchChiefcomplaints" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Medical History<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchMedicalHistory" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Systemic Examination<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchSystemicexam" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Diagnosis<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchDiagnosis" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Remarks</label>
                                    <textarea asp-for="DoctorAssessment.VchRemarks" class="form-control" rows="3"></textarea>                                       
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- Medicines -->
                        <div class="tab-pane fade" id="medicine" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 25%;">Medicine</th>
                                            <th style="width: 10%;">Quantity</th>
                                            <th style="width: 10%;">Frequency</th>
                                            <th style="width: 10%;">Duration</th>
                                            <th class="text-center" style="width: 25%;">Timings</th>
                                            <th style="width: 10%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicine-list">
                                        @if (Model.Medicines != null && Model.Medicines.Any())
                                        {
                                            for (int i = 0; i < Model.Medicines.Count; i++)
                                            {
                                                <tr class="medicine-item">
                                                    <!-- Medicine -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                               class="form-control form-control-sm medicine-autocomplete"
                                                               name="Medicines[@i].VchMedicineName"
                                                               value="@Model.Medicines[i].VchMedicineName"
                                                               placeholder="Search Medicine" autocomplete="off" />
                                                        <input type="hidden"
                                                               name="Medicines[@i].VchMedicineCode"
                                                               class="medicine-code"
                                                               value="@Model.Medicines[i].VchMedicineCode" />
                                                        <div class="list-group position-absolute w-100 medicine-suggestions"
                                                             style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Dosage -->
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm"
                                                               name="Medicines[@i].IntQuantity"
                                                               value="@Model.Medicines[i].IntQuantity"
                                                               placeholder="Quantity" min="0" step="1" />
                                                    </td>

                                                    <!-- Frequency -->
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchFrequency"
                                                               value="@Model.Medicines[i].VchFrequency"
                                                               placeholder="Frequency" />
                                                    </td>

                                                    <!-- Duration -->
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchDuration"
                                                               value="@Model.Medicines[i].VchDuration"
                                                               placeholder="Duration" />
                                                    </td>

                                                    <!-- Timings -->
                                                    <td>
                                                        <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                            <!-- Breakfast -->
                                                                <label>
                                                                    <input type="radio" class="form-check-input"
                                                                           name="Medicines[@i].BreakfastTiming" value="BBF"
                                                                           @(Model.Medicines[i].BitBbf == true ? "checked" : "") /> BBF
                                                                </label>
                                                                <label>
                                                                    <input type="radio" class="form-check-input scale-radio"
                                                                           name="Medicines[@i].BreakfastTiming" value="ABF"
                                                                           @(Model.Medicines[i].BitAbf == true ? "checked" : "") /> ABF
                                                                </label>

                                                            <!-- Lunch -->
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="BL"
                                                                       @(Model.Medicines[i].BitBl == true ? "checked" : "") /> BL
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="AL"
                                                                       @(Model.Medicines[i].BitAl == true ? "checked" : "") /> AL
                                                            </label>

                                                            <!-- Dinner -->
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="BD"
                                                                       @(Model.Medicines[i].BitBd == true ? "checked" : "") /> BD
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="AD"
                                                                       @(Model.Medicines[i].BitAd == true ? "checked" : "") /> AD
                                                            </label>
                                                        </div>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="medicine-item">
                                                <!-- Medicine -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                           class="form-control form-control-sm medicine-autocomplete"
                                                           name="Medicines[0].VchMedicineName"
                                                           placeholder="Search Medicine" autocomplete="off">
                                                    <input type="hidden"
                                                           name="Medicines[0].VchMedicineCode"
                                                           class="medicine-code">
                                                    <div class="list-group position-absolute w-100 medicine-suggestions"
                                                         style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Dosage -->
                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                           name="Medicines[0].IntQuantity" placeholder="Quantity" min="0" step="1">
                                                </td>

                                                <!-- Frequency -->
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchFrequency" placeholder="Frequency">
                                                </td>

                                                <!-- Duration -->
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchDuration" placeholder="Duration">
                                                </td>

                                                <!-- Timings -->
                                                <td>
                                                    <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                        <!-- Breakfast -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="BBF"> BBF
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="ABF"> ABF
                                                        </label>
                                                        <!-- Lunch -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="BL"> BL
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="AL"> AL
                                                        </label>
                                                        <!-- Dinner -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="BD"> BD
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="AD"> AD
                                                        </label>
                                                    </div>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <!-- Note -->
                                <div class="form-text mt-1" style="font-size: 0.7rem;color:orangered">
                                    <b style="color:red">NOTE:</b> BBF = Before Breakfast, ABF = After Breakfast, BL = Before Lunch,
                                    AL = After Lunch, BD = Before Dinner, AD = After Dinner
                                </div>
                            </div>

                          
                        </div>

                        <!-- Lab -->
                        <div class="tab-pane fade" id="lab" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Lab Test</th>
                                            <th style="width: 30%;">Priority</th>                                            
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lab-list">
                                     @if (Model.Labs != null && Model.Labs.Any())
                                        {
                                            for (int i = 0; i < Model.Labs.Count; i++)
                                            {
                                                <tr class="lab-item">
                                                    <!-- Lab Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm lab-autocomplete"
                                                        name="Labs[@i].VchTestName"
                                                        placeholder="Search Lab Test"
                                                        autocomplete="off"
                                                        value="@Model.Labs[i].VchTestName">
                                                        <input type="hidden"
                                                        name="Labs[@i].VchTestCode"
                                                        class="lab-code"
                                                        value="@Model.Labs[i].VchTestCode">
                                                        <div class="list-group position-absolute w-100 lab-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Labs[@i].VchPriority">
                                                            <option value="">-- Priority --</option>
                                                            <option value="Normal" selected="@(Model.Labs[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Labs[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="lab-item">
                                                <!-- Lab Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm lab-autocomplete"
                                                    name="Labs[0].VchTestName"
                                                    placeholder="Search Lab Test" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Labs[0].VchTestCode"
                                                    class="lab-code">
                                                    <div class="list-group position-absolute w-100 lab-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Labs[0].VchPriority">
                                                        <option value="">-- Priority --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>
                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                       
                        <!-- Radiology -->
                        <div class="tab-pane fade" id="radiology" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Radiology Test</th>
                                            <th style="width: 30%;">Priority</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="radio-list">
                                          @if (Model.Radiology != null && Model.Radiology.Any())
                                        {
                                            for (int i = 0; i < Model.Radiology.Count; i++)
                                            {
                                                <tr class="radio-item">
                                                    <!-- Radiology Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm radio-autocomplete"
                                                        name="Radiology[@i].VchRadiologyName"
                                                        placeholder="Search Radiology Test"
                                                        autocomplete="off"
                                                        value="@Model.Radiology[i].VchRadiologyName">
                                                        <input type="hidden"
                                                        name="Radiology[@i].VchRadiologyCode"
                                                        class="radio-code"
                                                        value="@Model.Radiology[i].VchRadiologyCode">
                                                        <div class="list-group position-absolute w-100 radio-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Radiology[@i].VchPriority">
                                                            <option value="">-- Select --</option>
                                                            
                                                            <option value="Normal" selected="@(Model.Radiology[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Radiology[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="radio-item">
                                                <!-- Radiology Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm radio-autocomplete"
                                                    name="Radiology[0].VchRadiologyName"
                                                    placeholder="Search Radiology Test" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Radiology[0].VchRadiologyCode"
                                                    class="radio-code">
                                                    <div class="list-group position-absolute w-100 radio-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Radiology[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!--Procedure-->
                        <div class="tab-pane fade" id="procedure" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Procedure</th>
                                            <th style="width: 30%;">Priority</th>                                          
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="procedure-list">
                                         @if (Model.Procedures != null && Model.Procedures.Any())
                                        {
                                            for (int i = 0; i < Model.Procedures.Count; i++)
                                            {
                                                <tr class="procedure-item">
                                                    <!-- Procedure Name -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm procedure-autocomplete"
                                                        name="Procedures[@i].VchProcedureName"
                                                        placeholder="Search Procedure"
                                                        autocomplete="off"
                                                        value="@Model.Procedures[i].VchProcedureName">
                                                        <input type="hidden"
                                                        name="Procedures[@i].VchProcedureCode"
                                                        class="procedure-code"
                                                        value="@Model.Procedures[i].VchProcedureCode">
                                                        <div class="list-group position-absolute w-100 procedure-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Procedures[@i].VchPriority">
                                                            <option value="">-- Select --</option>                                                            
                                                            <option value="Normal" selected="@(Model.Procedures[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Procedures[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>                                          

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="procedure-item">
                                                <!-- Procedure Name -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm procedure-autocomplete"
                                                    name="Procedures[0].VchProcedureName"
                                                    placeholder="Search Procedure" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Procedures[0].VchProcedureCode"
                                                    class="procedure-code">
                                                    <div class="list-group position-absolute w-100 procedure-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Procedures[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>                                          

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Follow Up -->
                        <div class="tab-pane fade" id="followup" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Follow-up Date</label>
                                        <input asp-for="DoctorAssessment.DtFollowUpDate" value="@(Model.DoctorAssessment.DtFollowUpDate.HasValue
                                       ? Model.DoctorAssessment.DtFollowUpDate.Value.ToString("yyyy-MM-dd"):"")" class="form-control required-field" type="date" />
                                        <span class="text-danger small validation-msg"></span>
                                    </div>
                                   @* value="@Model.DoctorAssessment.DtFollowUpDate" *@
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Follow-up Time</label>
                                        <input asp-for="DoctorAssessment.FollowUpTime" value="@(Model.DoctorAssessment.FollowUpTime.HasValue
                                      ? Model.DoctorAssessment.FollowUpTime.Value.ToString(@"hh\:mm"): "")" type="time" class="form-control required-field" />
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                            </div>
                        </div>  
                        </div>  

                        <!--File upload supporting document-->
                        <div class="tab-pane fade" id="files" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <label class="form-label fw-bold fs-5 text-primary mb-3">
                                    <i class="fas fa-paperclip me-2"></i>Upload Supporting Documents
                                </label>

                                <!-- Drop Zone -->
                                <div id="doctor-drop-zone"
                                     class="border border-3 border-dashed border-info p-5 text-center bg-light rounded-4 shadow-sm"
                                     style="cursor: pointer; transition: all 0.2s ease-in-out;">
                                    <p class="mb-3 text-info"><i class="fas fa-cloud-upload-alt fa-4x"></i></p>
                                    <p class="mb-1 fw-bold text-info fs-5">Drag & drop your files here</p>
                                    <p class="small text-info mb-0">or click to browse</p>

                                    <!-- Hidden file input -->
                                    <input type="file"
                                           name="doctorDocs"
                                           id="doctorDocsInput"
                                           class="form-control d-none"
                                           accept=".jpg,.jpeg,.png,.pdf"
                                           multiple />
                                </div>

                                <!-- Info -->
                                <div class="mt-3 text-muted text-center text-white-50" style="font-size: 0.875rem;">
                                    Supported file types: JPG, PNG, PDF. Maximum: 5 documents.
                                </div>

                                <!-- Preview File List -->
                                <div id="doctor-file-list" class="mt-4">
                                    @* Edit mode: show already uploaded files *@
                                    @if (Model.Documents != null && Model.Documents.Any())
                                    {
                                        <ul class="list-group list-group-flush">
                                            @foreach (var file in Model.Documents)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <a href="@Url.Content("~/Uploads/DoctorDocs/" + file.VchFileName)" target="_blank">
                                                        @file.VchFileName
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-danger remove-existing-file" data-file-id="@file.IntId">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>
                        </div>                       
                    </div>
                    
                </form>
            </div>
        </div>
     </div>
     @* modal for templete loading *@
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <!-- 🔹 Changed from modal-sm to modal-md -->
            <div class="modal-content shadow-lg border-0 rounded-4">

                <!-- Header -->
                <div class="modal-header bg-primary bg-gradient text-white py-2 px-3">
                    <h6 class="modal-title fw-semibold" id="templateModalLabel" style="font-size: 0.95rem;">
                        <i class="bi bi-layout-text-sidebar-reverse me-1"></i> Choose Template
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body py-3">
                    <label for="templateDropdown" class="form-label fw-semibold small text-secondary">Available Templates</label>
                    <select id="templateDropdown" class="form-select form-select-sm rounded-3 shadow-sm border-primary-subtle">
                        <option value="">-- Select Template --</option>
                    </select>
                </div>

                <!-- Footer -->
                <div class="modal-footer py-2 border-0 d-flex justify-content-between">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary btn-sm px-3" id="applyTemplate">
                        <i class="bi bi-check2-circle me-1"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>


@section scripts{
    <script src="/assets/js/dashboard1.js"></script>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    @* <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script> *@
    <script>
        //get cheif complaints
        $(function() {
            $("#ChiefComplaintInput").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: '@Url.Action("GetChiefComplaints", "Assessment")',
                        type: 'GET',
                        data: { term: request.term },
                        success: function(data) {
                            response(data);
                        }
                    });
                },
                minLength: 2
            });
        });

        //function for validation follow ups and bye pass it on save as template
        $(document).ready(function () {
            let bypassValidation = false;

            // When Save as Template button is clicked, set the flag
            $("#btnSaveTemplate").on("click", function () {
                bypassValidation = true;
            });

            $("form").on("submit", function (e) {
                // If bypass flag is set, allow submission
                if (bypassValidation) {
                    bypassValidation = false; // reset flag for next submit
                    return true;
                }
                let isValid = true;

                // Clear previous messages
                $(".validation-msg").text("");

                // Check required textareas
                $(".required-field").each(function () {
                    if ($(this).val().trim() === "") {
                        isValid = false;
                        $(this).siblings(".validation-msg").text("This field is required.");
                    }
                });

                if (!isValid) {
                    e.preventDefault(); // stop form submission
                    alert("⚠️ Please fill all required fields, check all tabs.");
                }
            });
        });

        //Save as template modal post method
        $(document).ready(function () {
              $("#btnSaveTemplateModal").on("click", function (e) {
                e.preventDefault();

                // 1. Get template name from modal
                let templateName = $("#TemplateName").val();

                if (!templateName || templateName.trim() === "") {
                    alert("⚠️ Please enter a template name.");
                    return;
                }

                // 2. Serialize the main assessment form
                let formData = $("#DAssessment").serializeArray();

                // Convert form data to key-value object
                let assessmentObj = {};
                $.each(formData, function (i, field) {
                    assessmentObj[field.name] = field.value;
                });

                // 3. Prepare final payload
                let payload = {
                    TemplateName: templateName,
                    Assessment: assessmentObj
                };

                console.log("🚀 Payload to server: ", payload);

                // 4. Send AJAX to your SaveTemplate action
                $.ajax({
                    url: '/Assessment/SaveAsTemplate',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        $("#saveTemplateModal").modal("hide");
                        alert("✅ Template saved successfully!");                       
                    },
                    error: function (xhr) {
                        alert("❌ Failed to save template.");
                        console.error(xhr.responseText);
                    }
                });
            });
        });

        //Function for load existing template in current assessment(use template button)
        // $(function () {
        //     // Bind only once globally
        //     const modal = $('#templateModal');
        //     const dropdown = $("#templateDropdown");

        //     // If already bound, skip
        //     if (!modal.data('bound')) {

        //         modal.on('show.bs.modal', function () {
        //             console.log("Template modal opened...");

        //             dropdown.empty().append('<option value="">-- Select Template --</option>');

        //             $.ajax({
        //                 url: "/Assessment/GetAllTemplates",
        //                 type: "GET",
        //                 dataType: "json",
        //                 cache: false,
        //                 success: function (data) {
        //                     console.log("Data received:", data);

        //                     if (data && data.success && data.templates && data.templates.$values) {
        //                         dropdown.empty().append('<option value="">-- Select Template --</option>');
        //                         data.templates.$values.forEach(item => {
        //                             if (item && item.value && item.text) {
        //                                 dropdown.append(`<option value="${item.value}">${item.text}</option>`);
        //                             }
        //                         });
        //                     } else {
        //                         dropdown.append('<option value="">No templates found</option>');
        //                     }
        //                 },
        //                 error: function (xhr, status, error) {
        //                     console.error("Error fetching templates:", error);
        //                     dropdown.append('<option value="">Error loading templates</option>');
        //                 }
        //             });
        //         });

        //         // Mark as bound so this event never attaches again
        //         modal.data('bound', true);
        //     }
        // });       

        //Medicine searching / adding
        $(document).ready(function () {
             let medIndex = 1; // start from 1 since 0 already exists

             // Function to generate new row
             function getNewRow(index) {
                         return `
             <tr class="medicine-item">
                 <!-- Medicine -->
                 <td class="position-relative">
                     <input type="text"
                            class="form-control form-control-sm medicine-autocomplete"
                            name="Medicines[${index}].VchMedicineName"
                            placeholder="Search Medicine" autocomplete="off">
                     <input type="hidden"
                            name="Medicines[${index}].VchMedicineCode"
                            class="medicine-code">
                     <div class="list-group position-absolute w-100 medicine-suggestions"
                          style="z-index:999; display:none;"></div>
                 </td>

                 <!-- Dosage -->
                 <td>
                     <input type="number" class="form-control form-control-sm"
                                name="Medicines[${index}].IntQuantity" placeholder="Quantity" min="0" step="1">
                 </td>

                 <!-- Frequency -->
                 <td>
                     <input type="text" class="form-control form-control-sm"
                            name="Medicines[${index}].VchFrequency" placeholder="Frequency">
                 </td>

                 <!-- Duration -->
                 <td>
                     <input type="text" class="form-control form-control-sm"
                            name="Medicines[${index}].VchDuration" placeholder="Duration">
                 </td>

                 <!-- Timings -->
                 <td>
                     <div class="d-flex flex-wrap justify-content-center gap-2 small">
                         <!-- Breakfast -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].BreakfastTiming" value="BBF"> BBF
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].BreakfastTiming" value="ABF"> ABF
                         </label>
                         <!-- Lunch -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].LunchTiming" value="BL"> BL
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].LunchTiming" value="AL"> AL
                         </label>
                         <!-- Dinner -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].DinnerTiming" value="BD"> BD
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].DinnerTiming" value="AD"> AD
                         </label>
                     </div>
                 </td>

                 <!-- Action -->
                 <td class="text-center">
                     <button type="button" class="btn btn-danger btn-sm remove-medicine">
                         <i class="bi bi-x-lg text-white"></i>
                     </button>
                     <button type="button" class="btn btn-success btn-sm add-medicine-row">
                         <i class="bi bi-plus-lg"></i>
                     </button>
                 </td>
             </tr>`;
             }

             // Global add button
             $("#addMedicine").click(function () {
                 $("#medicine-list").append(getNewRow(medIndex));
                 reIndexMedicineRows();
             });
             // Add row beside
             $(document).on("click", ".add-medicine-row", function () {
                 $(this).closest(".medicine-item").after(getNewRow(medIndex));
                 reIndexMedicineRows();
             });
             // Remove row
             $(document).on("click", ".remove-medicine", function () {
                  if ($(".medicine-item").length > 1) {
                 $(this).closest(".medicine-item").remove();
                 reIndexMedicineRows();
                 }
             });
             //renumbering of row after deletion and addations
             function reIndexMedicineRows() {
             $("#medicine-list tr.medicine-item").each(function (i, row) {
                 $(row).find("input").each(function () {
                     let name = $(this).attr("name");
                     if (name) {
                         let newName = name.replace(/\[\d+\]/, `[${i}]`);
                         $(this).attr("name", newName);
                     }
                 });
             });
             medIndex = $("#medicine-list tr.medicine-item").length; // reset counter
         }

             // Autocomplete search medicine (same as before, with keyboard support)
             $(document).on("keyup", ".medicine-autocomplete", function (e) {
             let input = $(this);
             let query = input.val().trim();
             let suggestionBox = input.siblings(".medicine-suggestions");
             let hidden = input.siblings(".medicine-code");

             // Reset hidden only if typing (not Enter/Arrow keys)
             if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                 hidden.val("");
             }

             if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

             if (query.length >= 1) {
                 $.ajax({
                     url: "/Assessment/SearchMedicine",
                     type: "GET",
                     data: { term: query },
                     success: function (data) {
                             let list = data?.$values || data; // 👈 Use $values if present, else fallback
                         suggestionBox.empty();
                             if (data.$values && data.$values.length > 0) {
                                 data.$values.forEach(item => {
                                 suggestionBox.append(
                                     `<a href="#" class="list-group-item list-group-item-action"
                                         data-name="${item.descript}"
                                         data-code="${item.icode}">
                                         ${item.descript} <small class="text-muted">(${item.icode})</small>
                                     </a>`
                                 );
                             });
                             suggestionBox.show();
                         } else {
                             suggestionBox.hide();
                         }
                     }
                 });
             } else {
                 suggestionBox.hide();
             }
         });

             // Keyboard navigation
             $(document).on("keydown", ".medicine-autocomplete", function (e) {
             let $input = $(this);
             let $box = $input.siblings(".medicine-suggestions");
             let $items = $box.find(".list-group-item-action");
             let $active = $items.filter(".active");

             if (e.key === "ArrowDown") {
                 e.preventDefault();
                 if ($active.length === 0) $items.first().addClass("active");
                 else {
                     let $next = $active.removeClass("active").next();
                     ($next.length ? $next : $items.first()).addClass("active");
                 }
             }
             else if (e.key === "ArrowUp") {
                 e.preventDefault();
                 if ($active.length === 0) $items.last().addClass("active");
                 else {
                     let $prev = $active.removeClass("active").prev();
                     ($prev.length ? $prev : $items.last()).addClass("active");
                 }
             }
             else if (e.key === "Enter") {
                 e.preventDefault(); // stop form submit
                 e.stopPropagation();

                 if ($active.length) {
                     // ✅ Directly set the text + hidden field
                     let name = $active.data("name");
                     let code = $active.data("code");

                     $input.val(name);
                     $input.siblings(".medicine-code").val(code);

                     $box.hide();
                 }
             }
         });
             // Select medicine
             $(document).on("click", ".medicine-suggestions a", function (e) {
                 e.preventDefault();
                 let name = $(this).data("name");
                 let code = $(this).data("code");

                 let $container = $(this).closest(".position-relative");
                 let $input = $container.find(".medicine-autocomplete");
                 let $hidden = $container.find(".medicine-code");

                 // Prevent duplicate
                 let isDuplicate = false;
                 $(".medicine-autocomplete").each(function () {
                     let n = $(this).val();
                     let c = $(this).closest(".position-relative").find(".medicine-code").val();
                     if (n === name || c === code) {
                         isDuplicate = true;
                         return false;
                     }
                 });

                 if (isDuplicate) {
                     alert("⚠️ This medicine is already selected.");
                     return;
                 }

                 $input.val(name);
                 $hidden.val(code);
                 $(this).closest(".medicine-suggestions").hide();
             });

             // Hide suggestions if click outside
             $(document).click(function (e) {
                 if (!$(e.target).closest(".medicine-autocomplete, .medicine-suggestions").length) {
                     $(".medicine-suggestions").hide();
                 }
             });
         });

        //for medicine check boxes select unselect
        $(document).on("click", "input[type=radio]", function () {
             let $radio = $(this);

             // If already checked, uncheck it
             if ($radio.data("waschecked") === true) {
                 $radio.prop("checked", false);
                 $radio.data("waschecked", false);
             } else {
                 // Unset all in group, set this one
                 $("input[name='" + $radio.attr("name") + "']").data("waschecked", false);
                 $radio.data("waschecked", true);
             }
         });

        //Code for Lab
        $(document).ready(function () {
                let labIndex = 1; // start from 1 since [0] already exists

                // Generate new Lab row
                function getNewLabRow(index) {
                    return `
                <tr class="lab-item">
                <td class="position-relative">
                <input type="text"
                       class="form-control form-control-sm lab-autocomplete"
                       name="Labs[${index}].VchTestName"
                       placeholder="Search Lab Test" autocomplete="off">
                <input type="hidden"
                       name="Labs[${index}].VchTestCode"
                       class="lab-code">
                <div class="list-group position-absolute w-100 lab-suggestions"
                     style="z-index:999; display:none;"></div>
                </td>
                <td>
                <select class="form-select form-select-sm"
                        name="Labs[${index}].VchPriority">
                    <option value="">-- Select --</option>
                    <option value="Normal">Normal</option>
                    <option value="Urgent">Urgent</option>
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm remove-lab">
                    <i class="bi bi-x-lg text-white"></i>
                </button>
                <button type="button" class="btn btn-success btn-sm add-lab-row">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </td>
        </tr>`;
                }

                // Add row beside
                $(document).on("click", ".add-lab-row", function () {
                    $(this).closest(".lab-item").after(getNewLabRow(labIndex));
                    reIndexLabRows();
                });

                // Remove row
                $(document).on("click", ".remove-lab", function () {
                    if ($(".lab-item").length > 1) {
                        $(this).closest(".lab-item").remove();
                        reIndexLabRows();
                    }
                });

                // Re-index rows
                function reIndexLabRows() {
                    $("#lab-list tr.lab-item").each(function (i, row) {
                        $(row).find("input, select").each(function () {
                            let name = $(this).attr("name");
                            if (name) {
                                $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                            }
                        });
                    });
                    labIndex = $("#lab-list tr.lab-item").length;
                }

                // Prevent duplicates
                function isLabDuplicate(code, name, currentRow) {
                    let duplicate = false;
                    $("#lab-list tr.lab-item").not(currentRow).each(function () {
                        let lCode = $(this).find(".lab-code").val();
                        let lName = $(this).find(".lab-autocomplete").val();
                        if (lCode === code || lName === name) {
                            duplicate = true;
                            return false;
                        }
                    });
                    return duplicate;
                }

                // Autocomplete (search Lab tests)
                $(document).on("keyup", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let query = $input.val().trim();
                    let $box = $input.siblings(".lab-suggestions");
                    let $hidden = $input.siblings(".lab-code");

                    if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");
                    if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                    if (query.length >= 1) {
                        $.ajax({
                            url: "/Assessment/SearchLab",
                            type: "GET",
                            data: { term: query },
                            success: function (data) {
                                let list = data?.$values || data; // 👈 Use $values if present, else fallback                            
                                $box.empty();
                                    if (data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                        $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                     data-name="${item.descript}" data-code="${item.tcode}">
                                                     ${item.descript} <small class="text-muted">(${item.tcode})</small>
                                                     </a>`);
                                    });
                                    $box.show();
                                } else $box.hide();
                            }
                        });
                    } else $box.hide();
                });

                // Keyboard navigation
                $(document).on("keydown", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let $items = $input.siblings(".lab-suggestions").find(".list-group-item-action");
                    let $active = $items.filter(".active");

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        if ($active.length === 0) $items.first().addClass("active");
                        else { $active.removeClass("active").next().addClass("active"); }
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        if ($active.length === 0) $items.last().addClass("active");
                        else { $active.removeClass("active").prev().addClass("active"); }
                    } else if (e.key === "Enter") {
                        if ($active.length) {
                            e.preventDefault();
                            let name = $active.data("name");
                            let code = $active.data("code");
                            let $row = $input.closest("tr");

                            if (isLabDuplicate(code, name, $row)) {
                                alert("⚠️ This lab test is already selected!");
                                return;
                            }

                            $input.val(name);
                            $input.siblings(".lab-code").val(code);
                            $input.siblings(".lab-suggestions").hide();
                        }
                    }
                });

                // Select from mouse click
                $(document).on("click", ".lab-suggestions a", function (e) {
                    e.preventDefault();
                    let $input = $(this).closest(".position-relative").find(".lab-autocomplete");
                    let name = $(this).data("name");
                    let code = $(this).data("code");
                    let $row = $input.closest("tr");

                    if (isLabDuplicate(code, name, $row)) {
                        alert("⚠️ This lab test is already selected!");
                        return;
                    }

                    $input.val(name);
                    $input.siblings(".lab-code").val(code);
                    $(this).parent().hide();
                });

                // Hide suggestions on outside click
                $(document).click(function (e) {
                    if (!$(e.target).closest(".lab-autocomplete, .lab-suggestions").length) {
                        $(".lab-suggestions").hide();
                    }
                });

                // On blur clear invalid text
                $(document).on("blur", ".lab-autocomplete", function () {
                    let $input = $(this);
                    let $hidden = $input.siblings(".lab-code");
                    if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
                });              
            });

        //Radiology code
        $(document).ready(function () {
            let radioIndex = 1; // start from 1 since 0 already exists

            function getNewRadioRow(index) {
                return `
                <tr class="radio-item">
                    <td class="position-relative">
                        <input type="text"
                               class="form-control form-control-sm radio-autocomplete"
                               name="Radiology[${index}].VchRadiologyName"
                               placeholder="Search Radiology Test" autocomplete="off">
                        <input type="hidden"
                               name="Radiology[${index}].VchRadiologyCode"
                               class="radio-code">
                        <div class="list-group position-absolute w-100 radio-suggestions"
                             style="z-index:999; display:none;"></div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm"
                                name="Radiology[${index}].VchPriority">
                            <option value="">-- Select --</option>
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                            <i class="bi bi-x-lg text-white"></i>
                        </button>
                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </td>
                </tr>`;
            }

            $(document).on("click", ".add-radio-row", function () {
                $(this).closest(".radio-item").after(getNewRadioRow(radioIndex));
                reIndexRadioRows();
            });

            $(document).on("click", ".remove-radio", function () {
                if ($(".radio-item").length > 1) {
                    $(this).closest(".radio-item").remove();
                    reIndexRadioRows();
                }
            });

            function reIndexRadioRows() {
                $("#radio-list tr.radio-item").each(function (i, row) {
                    $(row).find("input, select").each(function () {
                        let name = $(this).attr("name");
                        if (name) {
                            $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                        }
                    });
                });
                radioIndex = $("#radio-list tr.radio-item").length;
            }

            function isRadiologyDuplicate(code, name, currentRow) {
                let duplicate = false;
                $("#radio-list tr.radio-item").not(currentRow).each(function () {
                    let rCode = $(this).find(".radio-code").val();
                    let rName = $(this).find(".radio-autocomplete").val();
                    if (rCode === code || rName === name) {
                        duplicate = true;
                        return false;
                    }
                });
                return duplicate;
            }

            $(document).on("keyup", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let query = $input.val().trim();
                let $box = $input.siblings(".radio-suggestions");
                let $hidden = $input.siblings(".radio-code");

                if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");

                if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                if (query.length >= 1) {
                    $.ajax({
                        url: "/Assessment/SearchRadiology",
                        type: "GET",
                        data: { term: query, type: "Radio" },
                        success: function (data) {
                           let list = data?.$values || data; // 👈 Use $values if present, else fallback
                            $box.empty();
                                if(data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                    $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                 data-name="${item.service}" data-code="${item.scode}">
                                                 ${item.service} <small class="text-muted">(${item.scode})</small>
                                                 </a>`);
                                });
                                $box.show();
                            } else $box.hide();
                        }
                    });
                } else $box.hide();
            });

            $(document).on("keydown", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let $items = $input.siblings(".radio-suggestions").find(".list-group-item-action");
                let $active = $items.filter(".active");

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if ($active.length === 0) $items.first().addClass("active");
                    else { $active.removeClass("active").next().addClass("active"); }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if ($active.length === 0) $items.last().addClass("active");
                    else { $active.removeClass("active").prev().addClass("active"); }
                } else if (e.key === "Enter") {
                    if ($active.length) {
                        e.preventDefault();
                        let name = $active.data("name");
                        let code = $active.data("code");
                        let $row = $input.closest("tr");

                        if (isRadiologyDuplicate(code, name, $row)) {
                            alert("⚠️ This radiology is already selected!");
                            return;
                        }

                        $input.val(name);
                        $input.siblings(".radio-code").val(code);
                        $input.siblings(".radio-suggestions").hide();
                    }
                }
            });

            $(document).on("click", ".radio-suggestions a", function (e) {
                e.preventDefault();
                let $input = $(this).closest(".position-relative").find(".radio-autocomplete");
                let name = $(this).data("name");
                let code = $(this).data("code");
                let $row = $input.closest("tr");

                if (isRadiologyDuplicate(code, name, $row)) {
                    alert("⚠️ This radiology is already selected!");
                    return;
                }

                $input.val(name);
                $input.siblings(".radio-code").val(code);
                $(this).parent().hide();
            });

            $(document).click(function (e) {
                if (!$(e.target).closest(".radio-autocomplete, .radio-suggestions").length) {
                    $(".radio-suggestions").hide();
                }
            });

            $(document).on("blur", ".radio-autocomplete", function () {
                let $input = $(this);
                let $hidden = $input.siblings(".radio-code");
                if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
            });
                
            if (!isValid) {
                e.preventDefault(); // stop form submission
                return;
        }

          //Remove empty rows before submit (to set count 0 on post if empty)
           $("form").on("submit", function () {
            // Remove empty radiology rows
            $("#radio-list tr.radio-item").filter(function () {
                let code = $(this).find(".radio-code").val();
                return !code || code.trim() === "";
              }).remove();

            // Reindex remaining rows
               reIndexRadioRows();
           });
    });

        //Procedure
        $(document).ready(function () {
             let procIndex = 1; // start from 1 since [0] already exists

             // Function to generate new Procedure row
             function getNewProcedureRow(index) {
                 return `
                 <tr class="procedure-item">
                     <!-- Procedure -->
                     <td class="position-relative">
                         <input type="text"
                                class="form-control form-control-sm procedure-autocomplete"
                                name="Procedures[${index}].VchProcedureName"
                                placeholder="Search Procedure" autocomplete="off">
                         <input type="hidden"
                                name="Procedures[${index}].VchProcedureCode"
                                class="procedure-code">
                         <div class="list-group position-absolute w-100 procedure-suggestions"
                              style="z-index:999; display:none;"></div>
                     </td>

                     <!-- Priority -->
                     <td>
                         <select class="form-select form-select-sm" name="Procedures[${index}].VchPriority">
                             <option value="">-- Select --</option>
                             <option value="Normal">Normal</option>
                             <option value="Urgent">Urgent</option>
                         </select>
                     </td>
                     <!-- Action -->
                     <td class="text-center">
                         <button type="button" class="btn btn-danger btn-sm remove-procedure">
                             <i class="bi bi-x-lg text-white"></i>
                         </button>
                         <button type="button" class="btn btn-success btn-sm add-procedure-row">
                             <i class="bi bi-plus-lg"></i>
                         </button>
                     </td>
                 </tr>`;
             }

             // Add row beside
             $(document).on("click", ".add-procedure-row", function () {
                 $(this).closest(".procedure-item").after(getNewProcedureRow(procIndex));
                 reIndexProcedureRows();
             });

             // Remove row (keep at least 1 row)
             $(document).on("click", ".remove-procedure", function () {
                 if ($(".procedure-item").length > 1) {
                     $(this).closest(".procedure-item").remove();
                     reIndexProcedureRows();
                 }
             });

             // Re-index rows after add/remove
             function reIndexProcedureRows() {
                 $("#procedure-list tr.procedure-item").each(function (i, row) {
                     $(row).find("input, select").each(function () {
                         let name = $(this).attr("name");
                         if (name) {
                             let newName = name.replace(/\[\d+\]/, `[${i}]`);
                             $(this).attr("name", newName);
                         }
                     });
                 });
                 procIndex = $("#procedure-list tr.procedure-item").length;
             }

             // Autocomplete Procedure search
             $(document).on("keyup", ".procedure-autocomplete", function (e) {
                 let input = $(this);
                 let query = input.val().trim();
                 let suggestionBox = input.siblings(".procedure-suggestions");
                 let hidden = input.siblings(".procedure-code");

                 if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                     hidden.val(""); // reset hidden if typing
                 }

                 if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                 if (query.length >= 1) {
                     $.ajax({
                         url: "/Assessment/SearchRadiology", // 🔹 your controller method
                         type: "GET",
                         data: { term: query, type:"Procedure" },
                         success: function (data) {
                             let list = data?.$values || data; // 👈 Use $values if present, else fallback
                                 suggestionBox.empty();
                                if(data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                     suggestionBox.append(
                                         `<a href="#" class="list-group-item list-group-item-action"
                                             data-name="${item.service}"
                                             data-code="${item.scode}">
                                             ${item.service} <small class="text-muted">(${item.scode})</small>
                                         </a>`
                                     );
                                 });
                                 suggestionBox.show();
                             } else {
                                 suggestionBox.hide();
                             }
                         }
                     });
                 } else {
                     suggestionBox.hide();
                 }
             });

             // Keyboard navigation
             $(document).on("keydown", ".procedure-autocomplete", function (e) {
                 let $input = $(this);
                 let $box = $input.siblings(".procedure-suggestions");
                 let $items = $box.find(".list-group-item-action");
                 let $active = $items.filter(".active");

                 if (e.key === "ArrowDown") {
                     e.preventDefault();
                     if ($active.length === 0) $items.first().addClass("active");
                     else {
                         let $next = $active.removeClass("active").next();
                         ($next.length ? $next : $items.first()).addClass("active");
                     }
                 }
                 else if (e.key === "ArrowUp") {
                     e.preventDefault();
                     if ($active.length === 0) $items.last().addClass("active");
                     else {
                         let $prev = $active.removeClass("active").prev();
                         ($prev.length ? $prev : $items.last()).addClass("active");
                     }
                 }
                 else if (e.key === "Enter") {
                     e.preventDefault();
                     e.stopPropagation();

                     if ($active.length) {
                         let name = $active.data("name");
                         let code = $active.data("code");

                         $input.val(name);
                         $input.siblings(".procedure-code").val(code);
                         $box.hide();
                     }
                 }
             });

             // Select from mouse click
             $(document).on("click", ".procedure-suggestions a", function (e) {
                 e.preventDefault();
                 let name = $(this).data("name");
                 let code = $(this).data("code");

                 let $container = $(this).closest(".position-relative");
                 let $input = $container.find(".procedure-autocomplete");
                 let $hidden = $container.find(".procedure-code");

                 // Prevent duplicate
                 let isDuplicate = false;
                 $(".procedure-autocomplete").each(function () {
                     let n = $(this).val();
                     let c = $(this).closest(".position-relative").find(".procedure-code").val();
                     if (n === name || c === code) {
                         isDuplicate = true;
                         return false;
                     }
                 });

                 if (isDuplicate) {
                     alert("⚠️ This procedure is already selected.");
                     return;
                 }

                 $input.val(name);
                 $hidden.val(code);
                 $(this).closest(".procedure-suggestions").hide();
             });

             // Hide suggestions if clicked outside
             $(document).click(function (e) {
                 if (!$(e.target).closest(".procedure-autocomplete, .procedure-suggestions").length) {
                     $(".procedure-suggestions").hide();
                 }
             });
         });


         //For supporting document
         const doctorDropZone = document.getElementById("doctor-drop-zone");
         const doctorFileInput = document.getElementById("doctorDocsInput");
         const doctorFileList = document.getElementById("doctor-file-list");

         doctorDropZone.addEventListener("click", () => doctorFileInput.click());

         doctorDropZone.addEventListener("dragover", (e) => {
             e.preventDefault();
             doctorDropZone.classList.add("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("dragleave", () => {
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("drop", (e) => {
             e.preventDefault();
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
             doctorFileInput.files = e.dataTransfer.files;
             displayDoctorFiles();
         });

         doctorFileInput.addEventListener("change", displayDoctorFiles);

         function displayDoctorFiles() {
             doctorFileList.innerHTML = "";
             let files = Array.from(doctorFileInput.files);

             if (files.length > 5) {
                 alert("❌ Maximum 5 files allowed.");
                 doctorFileInput.value = "";
                 return;
             }

             files.forEach((file, index) => {
                 const div = document.createElement("div");
                 div.className = "d-flex align-items-center mb-2 border p-2 rounded bg-light shadow-sm";
                 div.innerHTML = `
                     <i class="fas fa-file-alt text-primary me-2"></i>
                     <span class="text-truncate" style="max-width: 160px;">${file.name}</span>
                     <span class="badge bg-secondary ms-auto">${(file.size / 1024).toFixed(1)} KB</span>
                     <button type="button" class="btn btn-sm btn-outline-danger ms-auto remove-file" data-index="${index}">❌</button>
                 `;
                 doctorFileList.appendChild(div);
             });
         }

         doctorFileList.addEventListener("click", function(e){
             if(e.target.classList.contains("remove-file")){
                 const idx = e.target.getAttribute("data-index");
                 const dt = new DataTransfer();
                 Array.from(doctorFileInput.files).forEach((file, i) => {
                     if(i != idx) dt.items.add(file);
                 });
                 doctorFileInput.files = dt.files;
                 displayDoctorFiles();
             }
         });



              // --- FUNCTION: Safe modal open (always works from any tab) ---
        function openTemplateModal(e) {
            e.preventDefault();

            // 1️⃣ Blur any active field (avoids focus trap bug)
            document.activeElement?.blur();

            // 2️⃣ Remove any old backdrops or stuck states
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', 'auto');

            // 3️⃣ Fully dispose previous Bootstrap modal instance
            let oldInstance = bootstrap.Modal.getInstance(modalEl);
            if (oldInstance) oldInstance.dispose();

            // 4️⃣ Recreate fresh instance and open
            const modalInstance = new bootstrap.Modal(modalEl);
            modalInstance.show();

            // 5️⃣ Reload dropdown content every time modal opens
            loadTemplatesDropdown();
        }
                // ✅ UNIVERSAL MODAL MANAGER for "Use Template" in Assessment
        $(function () {

            const modalEl = document.getElementById('templateModal');
            const useTemplateBtn = $('[data-bs-target="#templateModal"]');

            // --- CORE FUNCTION: Load dropdown each time modal opens ---
            function loadTemplatesDropdown() {
                const dropdown = $("#templateDropdown");
                dropdown.empty().append('<option value="">-- Loading Templates... --</option>');

                $.ajax({
                    url: "/Assessment/GetAllTemplates",
                    type: "GET",
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        dropdown.empty().append('<option value="">-- Select Template --</option>');
                        if (data && data.success && data.templates && data.templates.$values) {
                            data.templates.$values.forEach(item => {
                                if (item && item.value && item.text) {
                                    dropdown.append(`<option value="${item.value}">${item.text}</option>`);
                                }
                            });
                        } else {
                            dropdown.append('<option value="">No templates found</option>');
                        }
                    },
                    error: function () {
                        dropdown.empty().append('<option value="">⚠️ Error loading templates</option>');
                    }
                });
            }

            // --- FUNCTION: Safe modal open (always works from any tab) ---
                    function openTemplateModal(e) {
            e.preventDefault();

            // 1️⃣ Blur any active input
            document.activeElement?.blur();

            // 2️⃣ Clean up any old Bootstrap state
            const modalEl = document.getElementById('templateModal');
            const existingInstance = bootstrap.Modal.getInstance(modalEl);
            if (existingInstance) {
                // Hide & fully reset old modal safely
                existingInstance.hide();
                modalEl.removeEventListener('hidden.bs.modal', handleHiddenListener);
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('overflow', 'auto');
            }

            // 3️⃣ Define a named listener for reuse
            function handleHiddenListener() {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('overflow', 'auto');
                modalEl.removeEventListener('hidden.bs.modal', handleHiddenListener);
            }

            // 4️⃣ Create or reuse modal instance cleanly
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalEl.addEventListener('hidden.bs.modal', handleHiddenListener);

            // 5️⃣ Always reload dropdown before showing
            loadTemplatesDropdown();

            // 6️⃣ Show modal safely
            modalInstance.show();
        }


            // --- FUNCTION: Close modal safely after Apply ---
            function closeTemplateModalWithSuccess() {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) modalInstance.hide();

                modalEl.addEventListener('hidden.bs.modal', function handleHidden() {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('overflow', 'auto');
                    modalEl.removeEventListener('hidden.bs.modal', handleHidden);

                    // Delay alert slightly (avoids Bootstrap freeze)
                    setTimeout(() => alert("✅ Template loaded successfully!"), 200);
                });
            }

            // --- EVENT: Always handle modal open using safe click ---
            $(document).off('click.useTemplate').on('click.useTemplate', '[data-bs-target="#templateModal"]', openTemplateModal);

            // --- EVENT: Apply Template button inside modal ---
            $("#applyTemplate").on("click", function () {
                const templateId = $("#templateDropdown").val();
                if (!templateId) {
                    alert("⚠️ Please select a template first!");
                    return;
                }

                $.getJSON(`/Assessment/LoadTemplateData?id=${templateId}`, function (data) {
                    if (data.success) {
                        const t = data.template;

                        // 🧹 Clear old data first
                        $("textarea[name^='DoctorAssessment.']").val("");
                        $("#medicine-list, #lab-list, #radio-list, #procedure-list").empty();

                        // --- Clinical Text Fields ---
                        const setOrClearField = (selector, value) => {
                            $(selector).val(value && value.trim() !== "" ? value : "");
                        };

                        setOrClearField("textarea[name='DoctorAssessment.VchChiefcomplaints']", t.vchChiefcomplaints);
                        setOrClearField("textarea[name='DoctorAssessment.VchMedicalHistory']", t.vchMedicalHistory);
                        setOrClearField("textarea[name='DoctorAssessment.VchSystemicexam']", t.vchSystemicexam);
                        setOrClearField("textarea[name='DoctorAssessment.VchDiagnosis']", t.vchDiagnosis);
                        setOrClearField("textarea[name='DoctorAssessment.VchRemarks']", t.vchRemarks);

                        // --- Medicines ---
                        const meds = t.medicines?.$values || t.medicines || [];
                        meds.forEach((m, i) => {
                            $("#medicine-list").append(`
                                <tr class="medicine-item">
                                    <td class="position-relative">
                                        <input type="text" class="form-control form-control-sm medicine-autocomplete"
                                            name="Medicines[${i}].VchMedicineName"
                                            value="${m.vchMedicineName || ''}" autocomplete="off">
                                        <input type="hidden" name="Medicines[${i}].VchMedicineCode"
                                            class="medicine-code" value="${m.vchMedicineCode || ''}">
                                        <div class="list-group position-absolute w-100 medicine-suggestions"
                                            style="z-index:999; display:none;"></div>
                                    </td>
                                    <td><input type="number" class="form-control form-control-sm"
                                        name="Medicines[${i}].IntQuantity" value="${m.intQuantity || ''}"></td>
                                    <td><input type="text" class="form-control form-control-sm"
                                        name="Medicines[${i}].VchFrequency" value="${m.vchFrequency || ''}"></td>
                                    <td><input type="text" class="form-control form-control-sm"
                                        name="Medicines[${i}].VchDuration" value="${m.vchDuration || ''}"></td>
                                            <td>
                                    <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="BBF" ${m.bitBbf ? 'checked' : ''}> BBF</label>
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="ABF" ${m.bitAbf ? 'checked' : ''}> ABF</label>
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="BL" ${m.bitBl ? 'checked' : ''}> BL</label>
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="AL" ${m.bitAl ? 'checked' : ''}> AL</label>
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="BD" ${m.bitBd ? 'checked' : ''}> BD</label>
                                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="AD" ${m.bitAd ? 'checked' : ''}> AD</label>
                                    </div>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm remove-medicine"><i class="bi bi-x-lg text-white"></i></button>
                                        <button type="button" class="btn btn-success btn-sm add-medicine-row"><i class="bi bi-plus-lg"></i></button>
                                    </td>
                                         <!-- Timings -->
                            
                                </tr>
                            `);
                        });

                        // --- Labs ---
                        const labs = t.labs?.$values || t.labs || [];
                        labs.forEach((l, i) => {
                            $("#lab-list").append(`
                                <tr class="lab-item">
                                    <td class="position-relative">
                                        <input type="text" class="form-control form-control-sm lab-autocomplete"
                                            name="Labs[${i}].VchTestName" value="${l.vchTestName || ''}" autocomplete="off">
                                        <input type="hidden" class="lab-code" name="Labs[${i}].VchTestCode"
                                            value="${l.vchTestCode || ''}">
                                        <div class="list-group position-absolute w-100 lab-suggestions" style="z-index:999;display:none;"></div>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" name="Labs[${i}].VchPriority">
                                            <option value="">-- Priority --</option>
                                            <option value="Normal" ${l.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                            <option value="Urgent" ${l.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm remove-lab"><i class="bi bi-x-lg text-white"></i></button>
                                        <button type="button" class="btn btn-success btn-sm add-lab-row"><i class="bi bi-plus-lg"></i></button>
                                    </td>
                                </tr>
                            `);
                        });

                        // --- Radiology ---
                        const radios = t.radiology?.$values || t.radiology || [];
                        radios.forEach((r, i) => {
                            $("#radio-list").append(`
                                <tr class="radio-item">
                                    <td class="position-relative">
                                        <input type="text" class="form-control form-control-sm radio-autocomplete"
                                            name="Radiology[${i}].VchRadiologyName" value="${r.vchRadiologyName || ''}" autocomplete="off">
                                        <input type="hidden" class="radio-code" name="Radiology[${i}].VchRadiologyCode"
                                            value="${r.vchRadiologyCode || ''}">
                                        <div class="list-group position-absolute w-100 radio-suggestions" style="z-index:999;display:none;"></div>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" name="Radiology[${i}].VchPriority">
                                            <option value="">-- Priority --</option>
                                            <option value="Normal" ${r.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                            <option value="Urgent" ${r.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm remove-radio"><i class="bi bi-x-lg text-white"></i></button>
                                        <button type="button" class="btn btn-success btn-sm add-radio-row"><i class="bi bi-plus-lg"></i></button>
                                    </td>
                                </tr>
                            `);
                        });

                        // --- Procedures ---
                        const procs = t.procedures?.$values || t.procedures || [];
                        procs.forEach((p, i) => {
                            $("#procedure-list").append(`
                                <tr class="procedure-item">
                                    <td class="position-relative">
                                        <input type="text" class="form-control form-control-sm procedure-autocomplete"
                                            name="Procedures[${i}].VchProcedureName" value="${p.vchProcedureName || ''}" autocomplete="off">
                                        <input type="hidden" class="procedure-code" name="Procedures[${i}].VchProcedureCode"
                                            value="${p.vchProcedureCode || ''}">
                                        <div class="list-group position-absolute w-100 procedure-suggestions" style="z-index:999;display:none;"></div>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" name="Procedures[${i}].VchPriority">
                                            <option value="">-- Priority --</option>
                                            <option value="Normal" ${p.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                            <option value="Urgent" ${p.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm remove-procedure"><i class="bi bi-x-lg text-white"></i></button>
                                        <button type="button" class="btn btn-success btn-sm add-procedure-row"><i class="bi bi-plus-lg"></i></button>
                                    </td>
                                </tr>
                            `);
                        });

                        // ✅ Close modal safely
                        closeTemplateModalWithSuccess();
                    } else {
                        alert("⚠️ Template data not found!");
                    }
                });
            });
        });




        //On click button, Load template to current assessment               
        // $(document).on("click", "#applyTemplate", function () {
        //     const templateId = $("#templateDropdown").val();
        //     if (!templateId) {
        //         alert("⚠️ Please select a template first.");
        //         return;
        //     }

        //     $.ajax({
        //         url: `/Assessment/LoadTemplateData?id=${templateId}`,
        //         type: "GET",
        //         success: function (data) {
        //             if (!data.success) {
        //                 alert("❌ Template not found!");
        //                 return;
        //             }

        //             const t = data.template;

        //             //Clear existing rows
        //             $("#medicine-list").empty();
        //             $("#lab-list").empty();
        //             $("#radio-list").empty();
        //             $("#procedure-list").empty();

        // //Clinical fields
        // if (t.vchChiefcomplaints) {
        //     $("textarea[name='DoctorAssessment.VchChiefcomplaints']").val(t.vchChiefcomplaints);
        // }       
        // if (t.vchMedicalHistory) {
        //     $("textarea[name='DoctorAssessment.VchMedicalHistory']").val(t.vchMedicalHistory);
        // }
        // if (t.vchSystemicexam) {
        //     $("textarea[name='DoctorAssessment.VchSystemicexam']").val(t.vchSystemicexam);
        // }
        // if (t.vchDiagnosis) {
        //     $("textarea[name='DoctorAssessment.VchDiagnosis']").val(t.vchDiagnosis);
        // }
        // if (t.vchRemarks) {
        //     $("textarea[name='DoctorAssessment.VchRemarks']").val(t.vchRemarks);
        // }
        //     //Medicines                          
        //     if (t.medicines && ((t.medicines.$values && t.medicines.$values.length > 0) || t.medicines.length > 0)){
        //     $("#medicine-list").empty(); // clear tbody
        //     t.medicines.$values.forEach((m, i) => {
        //         $("#medicine-list").append(`
        //             <tr class="medicine-item">
        //                 <!-- Medicine -->
        //                 <td class="position-relative">
        //                     <input type="text"
        //                            class="form-control form-control-sm medicine-autocomplete"
        //                            name="Medicines[${i}].VchMedicineName"
        //                            value="${m.vchMedicineName ?? ''}"
        //                            placeholder="Search Medicine" autocomplete="off" />
        //                     <input type="hidden"
        //                            name="Medicines[${i}].VchMedicineCode"
        //                            class="medicine-code"
        //                            value="${m.vchMedicineCode ?? ''}" />
        //                     <div class="list-group position-absolute w-100 medicine-suggestions"
        //                          style="z-index:999; display:none;"></div>
        //                 </td>

        //                 <!-- Quantity -->
        //                 <td>
        //                     <input type="number" class="form-control form-control-sm"
        //                            name="Medicines[${i}].IntQuantity"
        //                            value="${m.intQuantity ?? ''}" min="0" step="1">
        //                 </td>

        //                 <!-- Frequency -->
        //                 <td>
        //                     <input type="text" class="form-control form-control-sm"
        //                            name="Medicines[${i}].VchFrequency"
        //                            value="${m.vchFrequency ?? ''}">
        //                 </td>

        //                 <!-- Duration -->
        //                 <td>
        //                     <input type="text" class="form-control form-control-sm"
        //                            name="Medicines[${i}].VchDuration"
        //                            value="${m.vchDuration ?? ''}">
        //                 </td>

        //                 <!-- Timings -->
        //                 <td>
        //                     <div class="d-flex flex-wrap justify-content-center gap-2 small">
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="BBF" ${m.bitBbf ? 'checked' : ''}> BBF</label>
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="ABF" ${m.bitAbf ? 'checked' : ''}> ABF</label>
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="BL" ${m.bitBl ? 'checked' : ''}> BL</label>
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="AL" ${m.bitAl ? 'checked' : ''}> AL</label>
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="BD" ${m.bitBd ? 'checked' : ''}> BD</label>
        //                         <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="AD" ${m.bitAd ? 'checked' : ''}> AD</label>
        //                     </div>
        //                 </td>

        //                 <!-- Action -->
        //                 <td class="text-center">
        //                     <button type="button" class="btn btn-danger btn-sm remove-medicine">
        //                         <i class="bi bi-x-lg text-white"></i>
        //                     </button>
        //                     <button type="button" class="btn btn-success btn-sm add-medicine-row">
        //                         <i class="bi bi-plus-lg"></i>
        //                     </button>
        //                 </td>
        //             </tr>
        //         `);
        //     });
        // } else {
        //     $("#medicine-list").html(`<tr><td colspan="6" class="text-center text-muted">No medicines in this template</td></tr>`);
        //     }


        //    // Labs
        //    const labs = (t.labs?.$values || t.labs || []);
        //    $("#lab-list").empty();
        //     if (labs.length > 0) {
        //     labs.forEach((l, i) => {
        //         $("#lab-list").append(`
        //             <tr class="lab-item">
        //                 <!-- Lab Test -->
        //                 <td class="position-relative">
        //                     <input type="text"
        //                            class="form-control form-control-sm lab-autocomplete"
        //                            name="Labs[${i}].VchTestName"
        //                            placeholder="Search Lab Test"
        //                            autocomplete="off"
        //                            value="${l.vchTestName || ''}">
        //                     <input type="hidden"
        //                            name="Labs[${i}].VchTestCode"
        //                            class="lab-code"
        //                            value="${l.vchTestCode || ''}">
        //                     <div class="list-group position-absolute w-100 lab-suggestions"
        //                          style="z-index:999; display:none;"></div>
        //                 </td>

        //                 <!-- Priority -->
        //                 <td>
        //                     <select class="form-select form-select-sm" name="Labs[${i}].vchPriority">
        //                         <option value="">-- Priority --</option>
        //                         <option value="Normal" ${l.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
        //                         <option value="Urgent" ${l.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
        //                     </select>
        //                 </td>

        //                 <!-- Action -->
        //                 <td class="text-center">
        //                     <button type="button" class="btn btn-danger btn-sm remove-lab">
        //                         <i class="bi bi-x-lg text-white"></i>
        //                     </button>
        //                     <button type="button" class="btn btn-success btn-sm add-lab-row">
        //                         <i class="bi bi-plus-lg"></i>
        //                     </button>
        //                 </td>
        //             </tr>
        //         `);
        //     });
        // } else {
        //     $("#lab-list").append(`
        //         <tr><td colspan="3" class="text-center text-muted">No lab tests in this template</td></tr>
        //     `);
        // }

        // //Radiology
        // const radios = (t.radiology?.$values || t.radiology || []);
        // $("#radio-list").empty();

        // if (radios.length > 0) {
        //     radios.forEach((r, i) => {
        //         $("#radio-list").append(`
        //             <tr class="radio-item">
        //                 <!-- Radiology Test -->
        //                 <td class="position-relative">
        //                     <input type="text"
        //                            class="form-control form-control-sm radio-autocomplete"
        //                            name="Radiology[${i}].VchRadiologyName"
        //                            placeholder="Search Radiology Test"
        //                            autocomplete="off"
        //                            value="${r.vchRadiologyName || ''}">
        //                     <input type="hidden"
        //                            name="Radiology[${i}].VchRadiologyCode"
        //                            class="radio-code"
        //                            value="${r.vchRadiologyCode || ''}">
        //                     <div class="list-group position-absolute w-100 radio-suggestions"
        //                          style="z-index:999; display:none;"></div>
        //                 </td>

        //                 <!-- Priority -->
        //                 <td>
        //                     <select class="form-select form-select-sm" name="Radiology[${i}].VchPriority">
        //                         <option value="">-- Priority --</option>
        //                         <option value="Normal" ${r.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
        //                         <option value="Urgent" ${r.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
        //                     </select>
        //                 </td>

        //                 <!-- Action -->
        //                 <td class="text-center">
        //                     <button type="button" class="btn btn-danger btn-sm remove-radio">
        //                         <i class="bi bi-x-lg text-white"></i>
        //                     </button>
        //                     <button type="button" class="btn btn-success btn-sm add-radio-row">
        //                         <i class="bi bi-plus-lg"></i>
        //                     </button>
        //                 </td>
        //             </tr>
        //         `);
        //     });
        // } 
        // else {
        //     $("#radio-list").append(`
        //         <tr><td colspan="3" class="text-center text-muted">No radiology tests in this template</td></tr>
        //     `);
        // }


        // //Procedures
        // const procs = (t.procedures?.$values || t.procedures || []);
        // $("#procedure-list").empty();

        // if (procs.length > 0) {
        //     procs.forEach((p, i) => {
        //         $("#procedure-list").append(`
        //             <tr class="procedure-item">
        //                 <!-- Procedure Name -->
        //                 <td class="position-relative">
        //                     <input type="text"
        //                            class="form-control form-control-sm procedure-autocomplete"
        //                            name="Procedures[${i}].VchProcedureName"
        //                            placeholder="Search Procedure"
        //                            autocomplete="off"
        //                            value="${p.vchProcedureName || ''}">
        //                     <input type="hidden"
        //                            name="Procedures[${i}].VchProcedureCode"
        //                            class="procedure-code"
        //                            value="${p.vchProcedureCode || ''}">
        //                     <div class="list-group position-absolute w-100 procedure-suggestions"
        //                          style="z-index:999; display:none;"></div>
        //                 </td>

        //                 <!-- Priority -->
        //                 <td>
        //                     <select class="form-select form-select-sm" name="Procedures[${i}].VchPriority">
        //                         <option value="">-- Select --</option>
        //                         <option value="Normal" ${p.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
        //                         <option value="Urgent" ${p.vhPriority === "Urgent" ? "selected" : ""}>Urgent</option>
        //                     </select>
        //                 </td>

        //                 <!-- Action -->
        //                 <td class="text-center">
        //                     <button type="button" class="btn btn-danger btn-sm remove-procedure">
        //                         <i class="bi bi-x-lg text-white"></i>
        //                     </button>
        //                     <button type="button" class="btn btn-success btn-sm add-procedure-row">
        //                         <i class="bi bi-plus-lg"></i>
        //                     </button>
        //                 </td>
        //             </tr>
        //         `);
        //     });
        // } 
        // else {
        //     $("#procedure-list").append(`
        //         <tr><td colspan="3" class="text-center text-muted">No procedures in this template</td></tr>
        //     `);
        // }
        //         //  Hide modal properly after template loaded
        // const modalEl = document.getElementById('templateModal');
        // const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);

        // // Hide the modal using Bootstrap
        // modalInstance.hide();

        // //Wait for it to fully close before cleaning up
        //  modalEl.addEventListener('hidden.bs.modal', function handleHidden() {
        // //Make sure backdrop is removed
        //     $('.modal-backdrop').remove();

        //     //Restore page scroll and UI
        //     $('body').removeClass('modal-open').css('overflow', 'auto');

        //     //Ensure button reopens modal next time (re-initialize)
        //     const useTemplateBtn = document.querySelector('[data-bs-target="#templateModal"]');
        //     if (useTemplateBtn) {
        //         useTemplateBtn.addEventListener('click', function () {
        //             const newInstance = new bootstrap.Modal(modalEl);
        //             newInstance.show();
        //         }, { once: true }); // ensures it only binds once per close
        //     }

        //     // Remove this event handler after one use
        //     modalEl.removeEventListener('hidden.bs.modal', handleHidden);
        // });
        //         //  Let user know template was loaded
        // setTimeout(() => {
        //     alert("✅ Template loaded successfully!");
        // }, 300);
        // },
        //                 error: function (xhr, status, error) {
        //                 console.error("Error loading template:", error);
        //                 alert("❌ Failed to load template.");
        //         }
        //     });
        // });

        
  </script>
}
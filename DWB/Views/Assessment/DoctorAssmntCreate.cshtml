@model DWB.Models.DoctorAssessmentVM
@{ 
    ViewData["Title"] = "DoctorAssessment";
    string formAction = Model.DoctorAssessment.IntId == 0 ? "Create" : "Edit";
}
<style>
    .scale-radio {
        transform: scale(1.2); /* increase radio button size */
        margin-right: 2.9px; /* space between button and label text */
        cursor: pointer;
    }</style>
<main class="main-wrapper py-4">

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center justify-content-between small shadow-sm rounded-3 py-2 px-3" role="alert" style="max-width: 600px; margin: 0 auto;">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-circle-fill me-2 fs-6"></i>
                <span>@ViewBag.Error</span>
            </div>
            <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (ViewBag.Success != null)
    {
        <div class="alert alert-success alert-dismissible fade show d-flex align-items-center justify-content-between small shadow-sm rounded-3 py-2 px-3" role="alert" style="max-width: 600px; margin: 0 auto;">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2 fs-6"></i>
                <span>@ViewBag.Success</span>
            </div>
            <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="container-fluid">
        <h4 class="mb-4 fw-bold text-primary">
            @(Model.DoctorAssessment.IntId > 0 ? "Edit Doctor Assessment" : "New Doctor Assessment")
        </h4>
        @* <div class="card p-2 border-0 shadow-sm rounded-3 mb-2 bg-light">
            <div class="d-flex flex-wrap align-items-center small text-dark fw-semibold">
                <span class="me-3 text-primary">Selected Patient|UHID: <span class="text-dark fw-bold">@Model.NursingAssessment.VchUhidNo</span></span>
                <span class="me-3 text-primary">Name: <span class="text-dark fw-bold">@Model.NursingAssessment.VchHmsname</span></span>
                <span class="me-3 text-primary">Visit No: <span class="text-dark fw-bold">@Model.NursingAssessment.IntIhmsvisit</span></span>           
                <span><a class="btn btn-sm btn-primary" id="btnViewHistory">View History</a> </span>&nbsp;
                <span><a class="btn btn-sm btn-danger" id="btnLoadHistory">Use last history</a> </span>&nbsp;
                <span><a class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#templateModal">Use Template</a> </span>
            </div>
        </div> *@
        <div class="card p-2 border-0 shadow-sm rounded-4 mb-1">
            <div class="d-flex flex-wrap align-items-center gap-3 small fw-medium">
                <span class="text-primary">
                    <i class="bi bi-person-badge me-1"></i>UHID:
                    <span class="text-body fw-bold">@Model.NursingAssessment.VchUhidNo</span>
                </span>
                <div class="vr opacity-25"></div>
                <span class="text-primary">
                    <i class="bi bi-person me-1"></i>Name:
                    <span class="text-body fw-bold">@Model.NursingAssessment.VchHmsname</span>
                </span>
                <div class="vr opacity-25"></div>
                <span class="text-primary">
                    <i class="bi bi-calendar-event me-1"></i>Visit No:
                    <span class="text-body fw-bold">@Model.NursingAssessment.IntIhmsvisit</span>
                </span>

                <div class="ms-auto d-flex gap-2">
                    <a class="btn btn-sm btn-outline-primary rounded-pill" id="btnViewHistory">
                        <i class="bi bi-clock-history me-1"></i>History
                    </a>
                    <a class="btn btn-sm btn-outline-danger rounded-pill" id="btnLoadHistory">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Load Last history
                    </a>
                    <a class="btn btn-sm btn-outline-success rounded-pill" id="btnOpenTemplate" style="cursor: pointer;">
                        <i class="bi bi-file-earmark-text me-1"></i>Template
                    </a>
                </div>
            </div>
        </div>
       

        <div class="card shadow-sm rounded-4">
            <div class="card-body">
                <form method="post" id="DAssessment" enctype="multipart/form-data" asp-action="@(Model.DoctorAssessment.IntId > 0 ? "DocAssmntEdit" : "DoctorAssmntCreate")" asp-controller="Assessment">
                    @Html.HiddenFor(m => m.DoctorAssessment.DtStartTime)
                    @Html.HiddenFor(m => m.DoctorAssessment.FkUhid, new { id="PatientId" })
                    @Html.HiddenFor(m => m.DoctorAssessment.FkAssessmentId)
                    @Html.HiddenFor(m => m.DoctorAssessment.FkVisitNo, new { id = "VisitNo" })
                    @Html.HiddenFor(m => m.DoctorAssessment.DtHmsentry)
                    @Html.HiddenFor(m => m.NursingAssessment.IntAssessmentId)
                    @* for edit assessment *@
                    @if (Model.DoctorAssessment.IntId != 0)
                    {
                        @Html.HiddenFor(mbox => Model.DoctorAssessment.IntId)
                    }

                    <!-- Submit -->
                    <div class="text-end mt-1 my-1">
                        <button type="button" align="left" id="btnSaveTemplate" class="btn btn-warning btn-sm shadow-sm " data-bs-toggle="modal" data-bs-target="#saveTemplateModal">
                            💾 Save as Template
                        </button> &nbsp;
                        <button type="submit" align="right" class="btn btn-primary btn-sm shadow-sm">
                            @(Model.DoctorAssessment.IntId > 0 ? " 💾 Update Assessment" : " 💾 Save Assessment")
                        </button>
                        <button align="right" class="btn btn-primary btn-sm shadow-sm">
                            💾 Save & Close Call
                        </button>
                    </div>
                    <!-- Nav Tabs -->
                    <ul class="nav nav-pills mb-3 justify-content-center" id="docAssessmentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patient" type="button" role="tab">
                                👤 Initial Assessment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clinical-tab" data-bs-toggle="tab" data-bs-target="#clinical" type="button" role="tab">
                                🩺 Clinical
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medicine-tab" data-bs-toggle="tab" data-bs-target="#medicine" type="button" role="tab">
                                💊 Medicines
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="lab-tab" data-bs-toggle="tab" data-bs-target="#lab" type="button" role="tab">
                                🧪 Lab
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="radiology-tab" data-bs-toggle="tab" data-bs-target="#radiology" type="button" role="tab">
                                🩻 Radiology
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="procedure-tab" data-bs-toggle="tab" data-bs-target="#procedure" type="button" role="tab">
                                💉 Procedure
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="followup-tab" data-bs-toggle="tab" data-bs-target="#followup" type="button" role="tab">
                                📅 Follow Up
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                                📂 Documents
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="docAssessmentContent">
                        <!-- Patient -->
                        <hr />
                        <div class="tab-pane fade show active" id="patient" role="tabpanel">
                            <div class="row g-2">
                                <div class="col-md-6 col-lg-3">
                                    <div class="card shadow-sm border-0 border-top border-3 border-primary rounded-3 h-100">
                                        <div class="card-header bg-transparent border-0 py-1 px-2">
                                            <small class="text-primary fw-bold d-flex align-items-center">
                                                <i class="bi bi-heart-pulse me-2"></i>VITAL SIGNS
                                            </small>
                                        </div>
                                        <div class="card-body p-2 pt-0">
                                            <div class="row g-1 small">
                                                <div class="col-6 border-end border-light-subtle pe-1">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">BP (MMHG)</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.VchBloodPressure</div>
                                                </div>
                                                <div class="col-6 ps-2">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">PULSE</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.VchPulse</div>
                                                </div>
                                                <div class="col-12"><hr class="my-1 opacity-10"></div>

                                                <div class="col-6 border-end border-light-subtle pe-1">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">TEMP (°F)</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecTemperature</div>
                                                </div>
                                                <div class="col-6 ps-2">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">SPO₂ (%)</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecSpO2</div>
                                                </div>
                                                <div class="col-12"><hr class="my-1 opacity-10"></div>

                                                <div class="col-6 border-end border-light-subtle pe-1">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">WEIGHT (KG)</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecWeight</div>
                                                </div>
                                                <div class="col-6 ps-2">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">HEIGHT (CM)</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecHeight</div>
                                                </div>

                                                <div class="col-12"><hr class="my-1 opacity-10"></div>

                                                <div class="col-6 border-end border-light-subtle pe-1">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">RESP RATE</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecRespiratoryRate</div>
                                                </div>
                                                <div class="col-6 ps-2">
                                                    <div class="text-secondary text-uppercase" style="font-size:0.65rem;">O₂ FLOW</div>
                                                    <div class="fw-bold text-body">@Model.NursingAssessment.DecOxygenFlowRate</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3">
                                    <div class="card shadow-sm border-0 border-top border-3 border-danger rounded-3 h-100">
                                        <div class="card-header bg-transparent border-0 py-1 px-2">
                                            <small class="text-danger fw-bold d-flex align-items-center">
                                                <i class="bi bi-clock-history me-2"></i>PAST HISTORY
                                            </small>
                                        </div>
                                        <div class="card-body p-2 pt-0">
                                            <div class="d-flex flex-column gap-1 small">
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Diabetes</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitDiabetes ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitDiabetes ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Heart Disease</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitHeartDisease ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitHeartDisease ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Hypertension</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitHypertension ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitHypertension ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Asthma</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitAsthma ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitAsthma ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Tuberculosis</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitTuberculosis ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitTuberculosis ? "YES" : "NO")
                                                    </span>
                                                </div>

                                                <div class="mt-1 bg-body-secondary rounded p-1">
                                                    <span class="text-secondary d-block" style="font-size:0.65rem;">OTHER:</span>
                                                    <span class="fw-bold text-body d-block text-truncate" style="max-width: 100%;">
                                                        @(string.IsNullOrEmpty(Model.NursingAssessment.VchOtherHistory) ? "-" : Model.NursingAssessment.VchOtherHistory)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3">
                                    <div class="card shadow-sm border-0 border-top border-3 border-success rounded-3 h-100">
                                        <div class="card-header bg-transparent border-0 py-1 px-2">
                                            <small class="text-success fw-bold d-flex align-items-center">
                                                <i class="bi bi-person-check me-2"></i>PERSONAL
                                            </small>
                                        </div>
                                        <div class="card-body p-2 pt-0">
                                            <div class="d-flex flex-column gap-1 small">
                                                <div class="bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded p-1 mb-1">
                                                    <span class="text-danger fw-bold d-block" style="font-size:0.65rem;">ALLERGIES:</span>
                                                    <span class="text-body fw-bold">
                                                        @(Model.NursingAssessment.BitIsAllergical? Model.NursingAssessment.VchAllergicalDrugs : "None")
                                                    </span>
                                                </div>

                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Alcohol</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitIsAlcoholic ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitIsAlcoholic ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">Smoking</span>
                                                    <span class="fw-bold @(Model.NursingAssessment.BitIsSmoking ? "text-danger" : "text-body")">
                                                        @(Model.NursingAssessment.BitIsSmoking ? "YES" : "NO")
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between border-bottom border-light-subtle pb-1">
                                                    <span class="text-secondary" style="font-size:0.75rem;">LMP</span>
                                                    <span class="fw-bold text-body">
                                                        @(string.IsNullOrEmpty(Model.NursingAssessment.VchLmpForFemale) ? "N/A" : Model.NursingAssessment.VchLmpForFemale)
                                                    </span>
                                                </div>

                                                <div class="mt-1">
                                                    <span class="text-secondary" style="font-size:0.65rem;">OCCUPATION:</span>
                                                    <span class="fw-bold text-body ms-1">
                                                        @(string.IsNullOrEmpty(Model.NursingAssessment.VchOccupation) ? "N/A" : Model.NursingAssessment.VchOccupation)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 col-lg-3">
                                    <div class="card shadow-sm border-0 border-top border-3 border-info rounded-3 h-100">
                                        <div class="card-header bg-transparent border-0 py-1 px-2">
                                            <small class="text-info fw-bold d-flex align-items-center">
                                                <i class="bi bi-folder2-open me-2"></i>DOCUMENTS
                                            </small>
                                        </div>
                                        <div class="card-body p-2 pt-0">
                                            <div class="row g-2">
                                                @if (Model.NursingAssessment.TblNassessmentDoc != null && Model.NursingAssessment.TblNassessmentDoc.Any())
                                                {
                                                    @foreach (var document in Model.NursingAssessment.TblNassessmentDoc.Take(4)) // Show max 4 to save space
                                                    {
                                                        <div class="col-6">
                                                            <a href="@Url.Content("~/uploads/NAssessment/" + document.VchFileName)" target="_blank" class="text-decoration-none">
                                                                <div class="border rounded bg-body-tertiary p-1 text-center" title="@document.VchFileName">
                                                                    <i class="fas fa-file-alt text-secondary fs-5 mb-1"></i>
                                                                    <div class="text-truncate small" style="font-size: 0.65rem; max-width: 100%;">
                                                                        @document.VchFileName
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="col-12 text-center text-muted py-3">
                                                        <small>No documents</small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Clinical -->
                        <div class="tab-pane fade" id="clinical" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <div class="row g-3">

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Chief Complaints <span class="text-danger">*</span></label>
                                        <div class="input-group input-group-sm mb-1">
                                            <input type="text" id="searchCC" class="form-control" placeholder="Search (e.g. Fever)...">
                                            <button class="btn btn-primary" type="button" id="btnAddCC" title="Add New">
                                                <i class="bi bi-plus-lg"></i> Add
                                            </button>
                                        </div>
                                        <textarea asp-for="DoctorAssessment.VchChiefcomplaints" id="txtCC" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Medical History <span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchMedicalHistory" class="form-control required-field" rows="3"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Systemic Examination <span class="text-danger">*</span></label>

                                        <div class="input-group input-group-sm mb-1">
                                            <input type="text" id="searchSys" class="form-control" placeholder="Search (e.g. Chest Clear)...">

                                            <button class="btn btn-primary" type="button" id="btnAddSys">
                                                <i class="bi bi-plus-lg"></i> Add
                                            </button>
                                        </div>

                                        <textarea asp-for="DoctorAssessment.VchSystemicexam" id="txtSys" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Diagnosis <span class="text-danger">*</span></label>
                                        <div class="input-group input-group-sm mb-1">
                                            <input type="text" id="searchDiag" class="form-control" placeholder="Search (e.g. Viral Fever)...">
                                            <button class="btn btn-primary" type="button" id="btnAddDiag" title="Add New">
                                                <i class="bi bi-plus-lg"></i> Add
                                            </button>
                                        </div>
                                        <textarea asp-for="DoctorAssessment.VchDiagnosis" id="txtDiag" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label fw-bold">Remarks</label>
                                        <textarea asp-for="DoctorAssessment.VchRemarks" class="form-control" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medicines -->
                        <div class="tab-pane fade" id="medicine" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 25%;">Medicine</th>
                                            <th style="width: 10%;">Quantity</th>
                                            <th style="width: 10%;">Frequency</th>
                                            <th style="width: 10%;">Duration</th>
                                            <th class="text-center" style="width: 25%;">Timings</th>
                                            <th style="width: 10%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicine-list">
                                        @if (Model.Medicines != null && Model.Medicines.Any())
                                        {
                                            for (int i = 0; i < Model.Medicines.Count; i++)
                                            {
                                                <tr class="medicine-item">
                                                    <td class="position-relative">
                                                        <div class="input-group input-group-sm">
                                                            <input type="text"
                                                                   class="form-control medicine-autocomplete"
                                                                   name="Medicines[@i].VchMedicineName"
                                                                   value="@Model.Medicines[i].VchMedicineName"
                                                                   placeholder="Search Medicine" autocomplete="off" />

                                                            <button type="button" class="btn btn-outline-primary btn-add-new-med" title="Add New Medicine to Master">
                                                                <i class="bi bi-plus-lg"></i>
                                                            </button>
                                                        </div>
                                                        <input type="hidden"
                                                               name="Medicines[@i].VchMedicineCode"
                                                               class="medicine-code"
                                                               value="@Model.Medicines[i].VchMedicineCode" />

                                                        <div class="list-group position-absolute w-100 medicine-suggestions"
                                                             style="z-index:999; display:none; top: 100%;"></div>
                                                    </td>

                                                    <td>
                                                        <input type="number" class="form-control form-control-sm"
                                                               name="Medicines[@i].IntQuantity"
                                                               value="@Model.Medicines[i].IntQuantity"
                                                               placeholder="Quantity" min="0" step="1" data-val="false" />
                                                    </td>

                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchFrequency"
                                                               value="@Model.Medicines[i].VchFrequency"
                                                               placeholder="Frequency" />
                                                    </td>

                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchDuration"
                                                               value="@Model.Medicines[i].VchDuration"
                                                               placeholder="Duration" />
                                                    </td>

                                                    <td>
                                                        <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                            <label>
                                                                <input type="radio" class="form-check-input"
                                                                       name="Medicines[@i].BreakfastTiming" value="BBF"
                                                                       @(Model.Medicines[i].BitBbf == true ? "checked" : "") /> BBF
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].BreakfastTiming" value="ABF"
                                                                       @(Model.Medicines[i].BitAbf == true ? "checked" : "") /> ABF
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="BL"
                                                                       @(Model.Medicines[i].BitBl == true ? "checked" : "") /> BL
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="AL"
                                                                       @(Model.Medicines[i].BitAl == true ? "checked" : "") /> AL
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="BD"
                                                                       @(Model.Medicines[i].BitBd == true ? "checked" : "") /> BD
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="AD"
                                                                       @(Model.Medicines[i].BitAd == true ? "checked" : "") /> AD
                                                            </label>
                                                        </div>
                                                    </td>

                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="medicine-item">
                                                <td class="position-relative">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text"
                                                               class="form-control medicine-autocomplete"
                                                               name="Medicines[0].VchMedicineName"
                                                               placeholder="Search Medicine" autocomplete="off">

                                                        <button type="button" class="btn btn-outline-primary btn-add-new-med" title="Add New Medicine to Master">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </div>
                                                    <input type="hidden"
                                                           name="Medicines[0].VchMedicineCode"
                                                           class="medicine-code">

                                                    <div class="list-group position-absolute w-100 medicine-suggestions"
                                                         style="z-index:999; display:none; top: 100%;"></div>
                                                </td>

                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                           name="Medicines[0].IntQuantity" placeholder="Quantity" min="0" step="1">
                                                </td>

                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchFrequency" placeholder="Frequency">
                                                </td>

                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchDuration" placeholder="Duration">
                                                </td>

                                                <td>
                                                    <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="BBF"> BBF
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="ABF"> ABF
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="BL"> BL
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="AL"> AL
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="BD"> BD
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="AD"> AD
                                                        </label>
                                                    </div>
                                                </td>

                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <div class="form-text mt-1" style="font-size: 0.7rem;color:orangered">
                                    <b style="color:red">NOTE:</b> BBF = Before Breakfast, ABF = After Breakfast, BL = Before Lunch,
                                    AL = After Lunch, BD = Before Dinner, AD = After Dinner
                                </div>
                            </div>
                        </div>

                        <!-- Lab -->
                        <div class="tab-pane fade" id="lab" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Lab Test</th>
                                            <th style="width: 30%;">Priority</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lab-list">
                                        @if (Model.Labs != null && Model.Labs.Any())
                                        {
                                            for (int i = 0; i < Model.Labs.Count; i++)
                                            {
                                                <tr class="lab-item">
                                                    <!-- Lab Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                               class="form-control form-control-sm lab-autocomplete"
                                                               name="Labs[@i].VchTestName"
                                                               placeholder="Search Lab Test"
                                                               autocomplete="off"
                                                               value="@Model.Labs[i].VchTestName">
                                                        <input type="hidden"
                                                               name="Labs[@i].VchTestCode"
                                                               class="lab-code"
                                                               value="@Model.Labs[i].VchTestCode">
                                                        <div class="list-group position-absolute w-100 lab-suggestions"
                                                             style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Labs[@i].VchPriority">
                                                            <option value="">-- Priority --</option>
                                                            <option value="Normal" selected="@(Model.Labs[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Labs[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="lab-item">
                                                <!-- Lab Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                           class="form-control form-control-sm lab-autocomplete"
                                                           name="Labs[0].VchTestName"
                                                           placeholder="Search Lab Test" autocomplete="off">
                                                    <input type="hidden"
                                                           name="Labs[0].VchTestCode"
                                                           class="lab-code">
                                                    <div class="list-group position-absolute w-100 lab-suggestions"
                                                         style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Labs[0].VchPriority">
                                                        <option value="">-- Priority --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>
                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Radiology -->
                        <div class="tab-pane fade" id="radiology" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Radiology Test</th>
                                            <th style="width: 30%;">Priority</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="radio-list">
                                        @if (Model.Radiology != null && Model.Radiology.Any())
                                        {
                                            for (int i = 0; i < Model.Radiology.Count; i++)
                                            {
                                                <tr class="radio-item">
                                                    <!-- Radiology Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                               class="form-control form-control-sm radio-autocomplete"
                                                               name="Radiology[@i].VchRadiologyName"
                                                               placeholder="Search Radiology Test"
                                                               autocomplete="off"
                                                               value="@Model.Radiology[i].VchRadiologyName">
                                                        <input type="hidden"
                                                               name="Radiology[@i].VchRadiologyCode"
                                                               class="radio-code"
                                                               value="@Model.Radiology[i].VchRadiologyCode">
                                                        <div class="list-group position-absolute w-100 radio-suggestions"
                                                             style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Radiology[@i].VchPriority">
                                                            <option value="">-- Select --</option>

                                                            <option value="Normal" selected="@(Model.Radiology[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Radiology[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="radio-item">
                                                <!-- Radiology Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                           class="form-control form-control-sm radio-autocomplete"
                                                           name="Radiology[0].VchRadiologyName"
                                                           placeholder="Search Radiology Test" autocomplete="off">
                                                    <input type="hidden"
                                                           name="Radiology[0].VchRadiologyCode"
                                                           class="radio-code">
                                                    <div class="list-group position-absolute w-100 radio-suggestions"
                                                         style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Radiology[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!--Procedure-->
                        <div class="tab-pane fade" id="procedure" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Procedure</th>
                                            <th style="width: 30%;">Priority</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="procedure-list">
                                        @if (Model.Procedures != null && Model.Procedures.Any())
                                        {
                                            for (int i = 0; i < Model.Procedures.Count; i++)
                                            {
                                                <tr class="procedure-item">
                                                    <!-- Procedure Name -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                               class="form-control form-control-sm procedure-autocomplete"
                                                               name="Procedures[@i].VchProcedureName"
                                                               placeholder="Search Procedure"
                                                               autocomplete="off"
                                                               value="@Model.Procedures[i].VchProcedureName">
                                                        <input type="hidden"
                                                               name="Procedures[@i].VchProcedureCode"
                                                               class="procedure-code"
                                                               value="@Model.Procedures[i].VchProcedureCode">
                                                        <div class="list-group position-absolute w-100 procedure-suggestions"
                                                             style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Procedures[@i].VchPriority">
                                                            <option value="">-- Select --</option>
                                                            <option value="Normal" selected="@(Model.Procedures[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Procedures[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="procedure-item">
                                                <!-- Procedure Name -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                           class="form-control form-control-sm procedure-autocomplete"
                                                           name="Procedures[0].VchProcedureName"
                                                           placeholder="Search Procedure" autocomplete="off">
                                                    <input type="hidden"
                                                           name="Procedures[0].VchProcedureCode"
                                                           class="procedure-code">
                                                    <div class="list-group position-absolute w-100 procedure-suggestions"
                                                         style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Procedures[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Follow Up -->
                        <div class="tab-pane fade" id="followup" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Follow-up Date</label>
                                        <input asp-for="DoctorAssessment.DtFollowUpDate" value="@(Model.DoctorAssessment.DtFollowUpDate.HasValue
                                                                                                                                ? Model.DoctorAssessment.DtFollowUpDate.Value.ToString("yyyy-MM-dd"):"")" class="form-control required-field" type="date" />
                                        <span class="text-danger small validation-msg"></span>
                                    </div>
                                    @* value="@Model.DoctorAssessment.DtFollowUpDate" *@
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Follow-up Time</label>
                                        <input asp-for="DoctorAssessment.FollowUpTime" value="@(Model.DoctorAssessment.FollowUpTime.HasValue
                                                                                                                             ? Model.DoctorAssessment.FollowUpTime.Value.ToString(@"hh\:mm"): "")" type="time" class="form-control required-field" />
                                        <span class="text-danger small validation-msg"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--File upload supporting document-->
                        <div class="tab-pane fade" id="files" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <label class="form-label fw-bold fs-5 text-primary mb-3">
                                    <i class="fas fa-paperclip me-2"></i>Upload Supporting Documents
                                </label>

                                <!-- Drop Zone -->
                                <div id="doctor-drop-zone"
                                     class="border border-3 border-dashed border-info p-5 text-center bg-light rounded-4 shadow-sm"
                                     style="cursor: pointer; transition: all 0.2s ease-in-out;">
                                    <p class="mb-3 text-info"><i class="fas fa-cloud-upload-alt fa-4x"></i></p>
                                    <p class="mb-1 fw-bold text-info fs-5">Drag & drop your files here</p>
                                    <p class="small text-info mb-0">or click to browse</p>

                                    <!-- Hidden file input -->
                                    <input type="file"
                                           name="doctorDocs"
                                           id="doctorDocsInput"
                                           class="form-control d-none"
                                           accept=".jpg,.jpeg,.png,.pdf"
                                           multiple />
                                </div>

                                <!-- Info -->
                                <div class="mt-3 text-muted text-center text-white-50" style="font-size: 0.875rem;">
                                    Supported file types: JPG, PNG, PDF. Maximum: 5 documents.
                                </div>

                                <!-- Preview File List -->
                                <div id="doctor-file-list" class="mt-4">
                                    @* Edit mode: show already uploaded files *@
                                    @if (Model.Documents != null && Model.Documents.Any())
                                    {
                                        <ul class="list-group list-group-flush">
                                            @foreach (var file in Model.Documents)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <a href="@Url.Content("~/Uploads/DoctorDocs/" + file.VchFileName)" target="_blank">
                                                        @file.VchFileName
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-danger remove-existing-file" data-file-id="@file.IntId">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
    @*Modal for save template*@
    <!-- Save as Template Modal -->
    <div class="modal fade" id="saveTemplateModal" tabindex="-1" aria-labelledby="saveTemplateLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-sm rounded-3">
                <div class="modal-header bg-light py-2">
                    <h6 class="modal-title fw-semibold" id="saveTemplateLabel">
                        <i class="bi bi-file-earmark-plus me-1"></i> Save Assessment as Template
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="TemplateName" class="form-label small fw-semibold">Template Name</label>
                        <input type="text" id="TemplateName" class="form-control form-control-sm"
                               placeholder="Enter template name (e.g., Fever & Cough Case)" />
                        <div id="templateError" class="text-danger small mt-1" style="display:none;"></div>
                    </div>
                </div>

                <div class="modal-footer bg-light py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                    </button>
                    <button type="button" id="btnSaveTemplateModal" class="btn btn-primary btn-sm">
                        <i class="bi bi-save2 me-1"></i> Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* modal for templete loading *@
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <!-- 🔹 Changed from modal-sm to modal-md -->
            <div class="modal-content shadow-lg border-0 rounded-4">

                <!-- Header -->
                <div class="modal-header bg-primary bg-gradient text-white py-2 px-3">
                    <h6 class="modal-title fw-semibold" id="templateModalLabel" style="font-size: 0.95rem;">
                        <i class="bi bi-layout-text-sidebar-reverse me-1"></i> Choose Template
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body py-3">
                    <label for="" class="form-label fw-semibold small text-secondary">Available Templates</label>
                    <select id="templateDropdown" class="form-select form-select-sm rounded-3 shadow-sm border-primary-subtle">
                        <option value="">-- Select Template --</option>
                    </select>
                </div>

                <!-- Footer -->
                <div class="modal-footer py-2 border-0 d-flex justify-content-between">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary btn-sm px-3" id="applyTemplate">
                        <i class="bi bi-check2-circle me-1"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!--CURENT PATIENT HISTORY MODAL-->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-sm rounded-3">
                <!-- Header -->
                <div class="modal-header bg-primary text-white py-2">
                    <h5 class="modal-title fw-semibold mb-0" id="historyModalLabel">
                        <i class="bi bi-clock-history me-2"></i> Patient History
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Body -->
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table id="historyTable" class="table table-bordered table-striped table-hover table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr class="small text-dark text-center">
                                    <th scope="col">Sr.No.</th>
                                    <th scope="col">Visit.No.</th>
                                    <th scope="col">UHID</th>
                                    <th scope="col">Patient Name</th>
                                    <th scope="col">Diagnosis</th>
                                    <th scope="col">Visit Date</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody class="small text-center">
                                <tr>
                                    <td colspan="6" class="text-muted py-3">
                                        <i class="bi bi-info-circle me-1"></i>No history loaded yet.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Footer -->
                <div class="modal-footer bg-light py-2 d-flex justify-content-between align-items-center">
                    <small class="text-muted">Viewing previous assessments for this patient</small>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
  <br />   
</main>

@section scripts
{
   
  <!-- jQuery (only one version) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/dashboard1.js"></script>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
      <!-- jQuery UI (fixes autocomplete) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- Apexcharts (only if required) -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Bootstrap (only one version) -->
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery Validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <!-- DataTables (optional) -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script> 
  
    <script type="text/javascript">
        // ============================================================
        // 1. EKA SCRIBE EVENT LISTENER (Captures Data)
        // ============================================================
        window.addEventListener("ekascribe-complete-data", function (event) {
            console.log("🔔 EkaScribe Data Received:", event);

            const payload = event.detail;
            if (!payload || !payload.data) return;
            const data = payload.data;

            // --- Helper: Parse Follow Up Date & Time ---
            // Converts "2024-12-25T14:30:00" into "2024-12-25" and "14:30"
            const parseFollowUpData = (rawData) => {
                let result = { date: "", time: "" };
                try {
                    if (!rawData) return result;

                    let dateStr = "";
                    // Handle if Eka sends a string or an object
                    if (typeof rawData === 'string') dateStr = rawData;
                    else if (typeof rawData === 'object' && !Array.isArray(rawData)) dateStr = rawData.date || "";

                    if (dateStr) {
                        const d = new Date(dateStr);
                        if (!isNaN(d.getTime())) {
                            result.date = d.toISOString().split('T')[0]; // YYYY-MM-DD
                            const timePart = d.toTimeString().split(' ')[0];
                            result.time = timePart.substring(0, 5);      // HH:mm
                        }
                    }
                } catch (err) {
                    console.warn("⚠️ Error parsing follow-up date:", err);
                }
                return result;
            };

            // --- Helper: Determine Quantity (Prioritizing DOSE) ---
            function getMedicineQuantity(m) {
                try {
                    // 1. Priority: User said "Quantity stands for Dose"
                    // We look for m.dose.value (e.g., "650" from "650 mg" or "1" from "1 Tablet")
                    // Reference: Eka js file lines 2652-2654
                    if (m.dose && typeof m.dose === 'object' && m.dose.value) {
                        return parseFloat(m.dose.value) || 0;
                    }

                    // 2. Fallback: Check explicit Quantity fields
                    if (m.qty || m.quantity || m.totalQuantity) {
                        return parseFloat(m.qty || m.quantity || m.totalQuantity) || 0;
                    }

                    // 3. Last Resort: Calculate from Frequency * Duration
                    // (Only if Dose is missing)
                    let dailyDose = 0;
                    if (m.frequency && Array.isArray(m.frequency.dose)) {
                        dailyDose = m.frequency.dose.reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                    }
                    else if (m.frequency && typeof m.frequency.value === 'string' && m.frequency.value.includes('-')) {
                        dailyDose = m.frequency.value.split('-').reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                    }

                    let duration = parseFloat(m.duration?.value) || 0;
                    let unit = (m.duration?.unit || "").toLowerCase();
                    if (unit.includes("week")) duration *= 7;
                    if (unit.includes("month")) duration *= 30;

                    if (dailyDose > 0 && duration > 0) {
                        return Math.ceil(dailyDose * duration);
                    }
                } catch (e) { console.log("Qty/Dose Logic Error", e); }

                return 0; // Default
            }
            // --- Helpers to extract text safely ---
            const getNestedValue = (obj, path) => {
                if (!obj || !path) return undefined;
                const keys = path.split('.');
                let result = obj;
                for (const key of keys) {
                    if (result && typeof result === 'object' && key in result) result = result[key];
                    else return undefined;
                }
                return result;
            };

            const parseEkaText = (fieldData) => {
                if (!fieldData) return "";
                if (typeof fieldData === 'string' || typeof fieldData === 'number') return String(fieldData);
                if (Array.isArray(fieldData)) {
                    return fieldData.map(item => {
                        if (typeof item === 'object') return item.name || item.text || item.value || "";
                        return item;
                    }).filter(x => x && x.trim() !== "").join(", ");
                }
                if (typeof fieldData === 'object') return fieldData.name || fieldData.text || fieldData.value || "";
                return "";
            };

                //for both 3 and 4 step
                //  Get ALL items from Eka's "labTests" or "investigations"
                // (This usually contains a mix of Blood Tests + X-Rays)
                const rawMixedList = getNestedValue(data, "labTests") || getNestedValue(data, "investigations.labs") || [];
                const rawRadiology = getNestedValue(data, "radiology") || getNestedValue(data, "investigations.radiology") || [];

                // Combine them into one master list to sort cleanly
                const allItems = [...rawMixedList, ...rawRadiology];

                const sortedLabs = [];
                const sortedRadiology = [];

                // Define keywords that identify "Radiology"
                const radioKeywords = ["x-ray", "xray", "ct scan", "mri", "usg", "ultrasound", "sonography", "doppler", "echo", "ct-PET"];

                // Loop through every item and decide: Is it Lab or Radiology?
                allItems.forEach(item => {
                    // Safely get the name string
                    let name = "";
                    if (typeof item === 'string') name = item;
                    else if (typeof item === 'object') name = item.name || item.testName || item.serviceName || "";

                    const lowerName = name.toLowerCase();

                    // CHECK: Does the name contain "x-ray", "mri", etc?
                    const isRadio = radioKeywords.some(keyword => lowerName.includes(keyword));

                    if (isRadio) {
                        sortedRadiology.push(item); // Put in Radiology Tab
                    } else {
                        sortedLabs.push(item);      // Put in Lab Tab
                    }
                });
            // 5. Extract Follow Up info
            const followUpRaw = getNestedValue(data, "followup") || getNestedValue(data, "appointment.nextVisit");
            const followUpParsed = parseFollowUpData(followUpRaw);
               // --- MAP DATA (Clinical + Medicines) ---
            const appModel = {
                // 1. Clinical Data
                vchChiefcomplaints: parseEkaText(getNestedValue(data, "symptoms") || getNestedValue(data, "patient.complaints") || getNestedValue(data, "clinicalNotes.chiefComplaint")),
                vchMedicalHistory:  parseEkaText(getNestedValue(data, "medicalHistory.patientHistory.patientMedicalConditions") || getNestedValue(data, "kco") || getNestedValue(data, "clinicalNotes.medicalHistory")),
                vchSystemicexam:    parseEkaText(getNestedValue(data, "medicalHistory.examinations") || getNestedValue(data, "general findings") || getNestedValue(data, "clinicalNotes.examination")),
                vchDiagnosis:       parseEkaText(getNestedValue(data, "diagnosis") || getNestedValue(data, "clinicalNotes.diagnosis")),
                vchRemarks:         parseEkaText(getNestedValue(data, "advices") || getNestedValue(data, "prescription.instructions") || getNestedValue(data, "clinicalNotes.remarks")),

                    // 2. Medicine Data
                medicines: (getNestedValue(data, "medications") || getNestedValue(data, "prescription.medications") || []).map(m => {
                    const instr = (m.instruction || "").toLowerCase();
                    let freq = m.frequency;
                    if (typeof freq === 'object' && freq !== null) freq = freq.custom || freq.value || "";
                    let dur = m.duration;
                    if (typeof dur === 'object' && dur !== null) dur = (dur.value || "") + " " + (dur.unit || "");

                    return {
                        vchMedicineName: m.name || m.drugName || "",
                        intQuantity:     getMedicineQuantity(m),                        
                        vchFrequency:    String(freq || ""),
                        vchDuration:     String(dur || "").trim(),
                        bitBbf: instr.includes("before breakfast"),
                        bitAbf: instr.includes("after breakfast"),
                        bitBl:  instr.includes("before lunch"),
                        bitAl:  instr.includes("after lunch"),
                        bitBd:  instr.includes("before dinner"),
                        bitAd:  instr.includes("after dinner") || instr.includes("after food")
                    };
                }),

                //3. Lab Data (New)
                labs: sortedLabs.map(l => ({
                    vchTestName: (typeof l === 'object') ? (l.name || l.testName) : l,
                    vchPriority: (typeof l === 'object' && l.priority) ? l.priority : "Normal",
                    vchTestCode: "000"
                })),

                // 4. Radiology Data (Now Populated!)
                // We use 'sortedRadiology' to ensure we catch X-Rays that were hidden in LabTests
                radiology: sortedRadiology.map(r => ({
                    vchRadiologyName: (typeof r === 'object') ? (r.name || r.serviceName) : r,
                    vchPriority: (typeof r === 'object' && r.priority) ? r.priority : "Normal",
                    vchRadiologyCode: "000"
                })),
                    // 2. Follow Up (New)
                vchFollowUpDate: followUpParsed.date,
                vchFollowUpTime: followUpParsed.time

            
            };


            // --- EXECUTE RENDER FUNCTION ---
            if (typeof window.renderAssessmentData === "function") {
                window.renderAssessmentData(appModel);

                // Automatically switch to Clinical Tab to show user the data
                try {
                    const clinicalTab = document.querySelector('#clinical-tab');
                    if(clinicalTab) { new bootstrap.Tab(clinicalTab).show(); }
                } catch(e) {}

                alert("✅ Clinical Data Populated!");
            } else {
                console.error("❌ renderAssessmentData is missing!");
            }
        });

        // ============================================================
        // 2. YOUR EXISTING JQUERY BLOCK (Keep this for other features)
        // ============================================================
        $(function() {
            // Your existing autocomplete, button clicks, etc. go here...
        });

            // ============================================================
        // 3. GLOBAL RENDER FUNCTION (Clinical + Medicine)
        // ============================================================
        window.renderAssessmentData = function(t) {
            console.log("📝 Rendering Data:", t);

            // --- 1. RENDER CLINICAL ---
                $("#txtCC").val(t.vchChiefcomplaints || "");
            $("textarea[name='DoctorAssessment.VchMedicalHistory']").val(t.vchMedicalHistory || "");
            $("textarea[name='DoctorAssessment.VchSystemicexam']").val(t.vchSystemicexam || "");
            $("textarea[name='DoctorAssessment.VchDiagnosis']").val(t.vchDiagnosis || "");
            $("textarea[name='DoctorAssessment.VchRemarks']").val(t.vchRemarks || "");

            // --- 2. RENDER MEDICINES ---
            const $medList = $("#medicine-list");
            $medList.empty(); // Clear existing rows

            if (t.medicines && t.medicines.length > 0) {
                t.medicines.forEach((m, i) => {
                    // Dynamically build the table row HTML
                    // We use ${i} to generate unique names for MVC Binding: Medicines[0], Medicines[1]...
                    $medList.append(`
                        <tr class="medicine-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm medicine-autocomplete"
                                       name="Medicines[${i}].VchMedicineName" value="${m.vchMedicineName}" autocomplete="off" placeholder="Search Medicine">
                                <input type="hidden" name="Medicines[${i}].VchMedicineCode" class="medicine-code" value="000">
                                <div class="list-group position-absolute w-100 medicine-suggestions" style="z-index:999; display:none;"></div>
                            </td>

                            <td>
                                <input type="number" class="form-control form-control-sm"
                                       name="Medicines[${i}].IntQuantity" value="${m.intQuantity}" placeholder="Qty">
                            </td>

                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       name="Medicines[${i}].VchFrequency" value="${m.vchFrequency}" placeholder="Freq">
                            </td>

                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       name="Medicines[${i}].VchDuration" value="${m.vchDuration}" placeholder="Dur">
                            </td>

                            <td>
                                <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="BBF" ${m.bitBbf ? "checked" : ""}> BBF</label>
                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="ABF" ${m.bitAbf ? "checked" : ""}> ABF</label>

                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="BL" ${m.bitBl ? "checked" : ""}> BL</label>
                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="AL" ${m.bitAl ? "checked" : ""}> AL</label>

                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="BD" ${m.bitBd ? "checked" : ""}> BD</label>
                                   <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="AD" ${m.bitAd ? "checked" : ""}> AD</label>
                                </div>
                            </td>

                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-medicine"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-medicine-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });
            }

            // --- 3. RENDER LABS (New) ---
            const $labList = $("#lab-list");
            $labList.empty(); // Clear existing rows

            if (t.labs && t.labs.length > 0) {
                t.labs.forEach((l, i) => {
                    $labList.append(`
                        <tr class="lab-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm lab-autocomplete"
                                       name="Labs[${i}].VchTestName" value="${l.vchTestName}" autocomplete="off" placeholder="Search Lab Test">

                                <input type="hidden" class="lab-code" name="Labs[${i}].VchTestCode" value="000">

                                <div class="list-group position-absolute w-100 lab-suggestions" style="z-index:999; display:none;"></div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" name="Labs[${i}].VchPriority">
                                    <option value="Normal" ${l.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                    <option value="Urgent" ${l.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-lab"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-lab-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });
            }

            // --- 4. RENDER RADIOLOGY (New) ---
            const $radioList = $("#radio-list");
            $radioList.empty();
            if (t.radiology && t.radiology.length > 0) {
                t.radiology.forEach((r, i) => {
                    $radioList.append(`
                        <tr class="radio-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm radio-autocomplete"
                                       name="Radiology[${i}].VchRadiologyName" value="${r.vchRadiologyName}" autocomplete="off" placeholder="Search Radiology">
                                <input type="hidden" class="radio-code" name="Radiology[${i}].VchRadiologyCode" value="000">
                                <div class="list-group position-absolute w-100 radio-suggestions" style="z-index:999; display:none;"></div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" name="Radiology[${i}].VchPriority">
                                    <option value="Normal" ${r.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                    <option value="Urgent" ${r.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-radio"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-radio-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });
            }

            // 5. Follow Up (New)
            // We use the 'name' attribute from your HTML to target the inputs
            $("input[name='DoctorAssessment.DtFollowUpDate']").val(t.vchFollowUpDate || "");
            $("input[name='DoctorAssessment.FollowUpTime']").val(t.vchFollowUpTime || "");
        };               

        //function for validation follow ups and bye pass it on save as template
        $(document).ready(function () {
            let bypassValidation = false;

            // When Save as Template button is clicked, set the flag
            $("#btnSaveTemplate").on("click", function () {
                bypassValidation = true;
            });

            $("form").on("submit", function (e) {
                // If bypass flag is set, allow submission
                if (bypassValidation) {
                    bypassValidation = false; // reset flag for next submit
                    return true;
                }
               // let isValid = true;

                // Clear previous messages
                $(".validation-msg").text("");

                // Check required textareas
                $(".required-field").each(function () {
                    if ($(this).val().trim() === "") {
                       // isValid = false;
                        $(this).siblings(".validation-msg").text("This field is required.");
                    }
                });

                // if (!isValid) {
                //     e.preventDefault(); // stop form submission
                //     alert("⚠️ Please fill all required fields, check all tabs.");
                // }
            });
        });

        //Save as template modal post method
        // $(document).ready(function () {
        //       $("#btnSaveTemplateModal").on("click", function (e) {
        //         e.preventDefault();

        //         // 1. Get template name from modal
        //         let templateName = $("#TemplateName").val();

        //         if (!templateName || templateName.trim() === "") {
        //             alert("⚠️ Please enter a template name.");
        //             return;
        //         }

        //         // 2. Serialize the main assessment form
        //         let formData = $("#DAssessment").serializeArray();

        //         // Convert form data to key-value object
        //         let assessmentObj = {};
        //         $.each(formData, function (i, field) {
        //             assessmentObj[field.name] = field.value;
        //         });

        //         // 3. Prepare final payload
        //         let payload = {
        //             TemplateName: templateName,
        //             Assessment: assessmentObj
        //         };

        //         console.log("🚀 Payload to server: ", payload);

        //         // 4. Send AJAX to your SaveTemplate action
        //         $.ajax({
        //             url: '/Assessment/SaveAsTemplate',
        //             type: 'POST',
        //             contentType: 'application/json',
        //             data: JSON.stringify(payload),
        //             success: function (response) {
        //                 $("#saveTemplateModal").modal("hide");
        //                 alert("✅ Template saved successfully!");                       
        //             },
        //             error: function (xhr) {
        //                 alert("❌ Failed to save template.");
        //                 console.error(xhr.responseText);
        //             }
        //         });
        //     });
        // });    

        //Medicine searching / adding

        $(document).ready(function () {
            $("#btnSaveTemplateModal").on("click", function (e) {
                e.preventDefault();

                // 1. Get template name
                let templateName = $("#TemplateName").val();

                if (!templateName || templateName.trim() === "") {
                    // Show error inside the modal instead of an alert
                    $("#templateError").text("⚠️ Please enter a template name.").show();
                    return;
                } else {
                    $("#templateError").hide();
                }

                // 2. Visual Feedback: Disable button & show spinner
                let $btn = $(this);
                let originalText = $btn.html();
                $btn.prop("disabled", true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');

                // 3. Serialize the main assessment form
                let formData = $("#DAssessment").serializeArray();
                let assessmentObj = {};
                $.each(formData, function (i, field) {
                    // Filter out RequestVerificationToken
                    if (field.name !== "__RequestVerificationToken") {
                        assessmentObj[field.name] = field.value;
                    }
                });

                // 4. Prepare payload
                let payload = {
                    TemplateName: templateName,
                    Assessment: assessmentObj
                };

                // 5. Send AJAX
                $.ajax({
                    url: '/Assessment/SaveAsTemplate',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        // FIX 1: Close Modal & Force remove the backdrop (Fixes "Disabled Page")
                        $("#saveTemplateModal").modal("hide");
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open').css('overflow', 'auto');

                        // FIX 2: Reset Validation Flag (if you are using the bypass logic)
                        // bypassValidation = false;

                        // FIX 3: Show Dynamic Success Message (Fixes "Message not coming")
                        let successHtml = `
                            <div class="alert alert-success alert-dismissible fade show shadow-sm mt-3" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                                    <strong>Success!</strong>&nbsp; Template saved successfully.
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>`;

                        // Make sure you added <div id="js-alert-container"></div> at the top of your page
                        $("#js-alert-container").html(successHtml);

                        // Auto-hide after 3 seconds
                        setTimeout(function() {
                            $("#js-alert-container .alert").fadeOut();
                        }, 3000);
                    },
                    error: function (xhr) {
                        let errorMsg = "Failed to save template.";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        alert("❌ " + errorMsg); // Fallback alert for error is okay, or use the container
                        console.error(xhr.responseText);
                    },
                    complete: function () {
                        // Re-enable button
                        $btn.prop("disabled", false).html(originalText);
                    }
                });
            });
        });
        $(document).ready(function () {
                let medIndex = 1; // start from 1 since 0 already exists

        // Function to generate new row
        function getNewRow(index) {
            return `
            <tr class="medicine-item">
                <td class="position-relative">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control medicine-autocomplete"
                               name="Medicines[${index}].VchMedicineName"
                               placeholder="Search Medicine" autocomplete="off">
                        <button type="button" class="btn btn-outline-primary btn-add-new-med" title="Add New Medicine to Master">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>

                    <input type="hidden" name="Medicines[${index}].VchMedicineCode" class="medicine-code">
                    <div class="list-group position-absolute w-100 medicine-suggestions"
                         style="z-index:999; display:none; top: 100%;"></div>
                </td>

                <td><input type="number" class="form-control form-control-sm" name="Medicines[${index}].IntQuantity" placeholder="Quantity" min="0" step="1"></td>
                <td><input type="text" class="form-control form-control-sm" name="Medicines[${index}].VchFrequency" placeholder="Frequency"></td>
                <td><input type="text" class="form-control form-control-sm" name="Medicines[${index}].VchDuration" placeholder="Duration"></td>
                <td>
                    <div class="d-flex flex-wrap justify-content-center gap-2 small">
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].BreakfastTiming" value="BBF"> BBF</label>
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].BreakfastTiming" value="ABF"> ABF</label>
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].LunchTiming" value="BL"> BL</label>
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].LunchTiming" value="AL"> AL</label>
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].DinnerTiming" value="BD"> BD</label>
                        <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${index}].DinnerTiming" value="AD"> AD</label>
                    </div>
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm remove-medicine"><i class="bi bi-x-lg text-white"></i></button>
                    <button type="button" class="btn btn-success btn-sm add-medicine-row"><i class="bi bi-plus-lg"></i></button>
                </td>
            </tr>`;
        }

        // --- LOGIC TO ADD NEW MEDICINE TO MASTER ---
        $(document).on('click', '.btn-add-new-med', function () {
            // 1. Identify elements in this specific row
            const $btn = $(this);
            const $inputGroup = $btn.closest('.input-group');
            const $input = $inputGroup.find('.medicine-autocomplete');
            const $hiddenCode = $inputGroup.siblings('.medicine-code'); // The hidden field for Icode

            // 2. Get the typed name
            const medName = $input.val().trim();

            if (medName === "") {
                alert("⚠️ Please type a medicine name first.");
                return;
            }

            // 3. Visual Feedback (Loading)
            const originalIcon = $btn.html();
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            // 4. Send to Server
            $.ajax({
                url: '@Url.Action("AddMedicineMaster", "Assessment")', // Call the new controller method
                type: 'POST',
                data: { name: medName },
                success: function (response) {
                    if (response.success) {
                        // ✅ Success: Update the input and the HIDDEN CODE
                        $input.val(response.name);       // Ensure correct casing
                        $hiddenCode.val(response.code);  // SAVE THE GENERATED KEY (Icode)

                        // Optional: Green border to indicate success
                        $input.addClass('is-valid');
                        setTimeout(() => $input.removeClass('is-valid'), 2000);

                        // Close any suggestions that might be open
                        $inputGroup.siblings('.medicine-suggestions').hide();
                    } else {
                        alert("❌ Error: " + response.message);
                    }
                },
                error: function () {
                    alert("❌ Server Error: Could not save medicine.");
                },
                complete: function () {
                    // Reset button
                    $btn.prop('disabled', false).html(originalIcon);
                }
            });
        });

        // Optional: Allow "Enter" key in medicine input to trigger the Add button
        $(document).on('keypress', '.medicine-autocomplete', function (e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                const $suggestions = $(this).closest('td').find('.medicine-suggestions');

                // Only trigger Add if suggestions are NOT visible (otherwise Enter selects a suggestion)
                if (!$suggestions.is(':visible')) {
                    $(this).siblings('.btn-add-new-med').click();
                }
            }
        });
                 // Global add button
                 $("#addMedicine").click(function () {
                     $("#medicine-list").append(getNewRow(medIndex));
                     reIndexMedicineRows();
                 });
                 // Add row beside
                 $(document).on("click", ".add-medicine-row", function () {
                     $(this).closest(".medicine-item").after(getNewRow(medIndex));
                     reIndexMedicineRows();
                 });
                 // Remove row
                 $(document).on("click", ".remove-medicine", function () {
                      if ($(".medicine-item").length > 1) {
                     $(this).closest(".medicine-item").remove();
                     reIndexMedicineRows();
                     }
                 });
                 //renumbering of row after deletion and addations
                 function reIndexMedicineRows() {
                 $("#medicine-list tr.medicine-item").each(function (i, row) {
                     $(row).find("input").each(function () {
                         let name = $(this).attr("name");
                         if (name) {
                             let newName = name.replace(/\[\d+\]/, `[${i}]`);
                             $(this).attr("name", newName);
                         }
                     });
                 });
                 medIndex = $("#medicine-list tr.medicine-item").length; // reset counter
             }
                 // ============================================================
        //  MEDICINE SEARCH LOGIC (Updated for New HTML Structure)
        // ============================================================

        // 1. Autocomplete Search (Keyup)
        $(document).on("keyup", ".medicine-autocomplete", function (e) {
            let $input = $(this);
            let query = $input.val().trim();

            // FIX: Traverse up to the cell (td) to find elements, because Input is now inside a Group div
            let $container = $input.closest('td');
            let $suggestionBox = $container.find(".medicine-suggestions");
            let $hiddenCode = $container.find(".medicine-code");

            // Reset hidden code if typing
            if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                $hiddenCode.val("");
            }

            if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

            if (query.length >= 1) {
                $.ajax({
                    url: "/Assessment/SearchMedicine", // Ensure this matches your Controller Route
                    type: "GET",
                    data: { term: query },
                    success: function (data) {
                        let list = (data && data.$values) ? data.$values : data; // Handle .NET wrapper
                        $suggestionBox.empty();

                        if (list && list.length > 0) {
                            // Limit to 10 items for performance
                            list.slice(0, 10).forEach(item => {
                                $suggestionBox.append(
                                    `<a href="#" class="list-group-item list-group-item-action"
                                      data-name="${item.descript}"
                                      data-code="${item.icode}">
                                      ${item.descript} <small class="text-muted">(${item.icode})</small>
                                    </a>`
                                );
                            });
                            $suggestionBox.show();
                        } else {
                            $suggestionBox.hide();
                        }
                    },
                    error: function() {
                        $suggestionBox.hide();
                    }
                });
            } else {
                $suggestionBox.hide();
            }
        });

        // 2. Select Medicine from List (Click)
        $(document).on("click", ".medicine-suggestions a", function (e) {
            e.preventDefault();

            let $selectedItem = $(this);
            let name = $selectedItem.data("name");
            let code = $selectedItem.data("code");

            // FIX: Find input/hidden relative to the Container (td)
            let $container = $selectedItem.closest('td');
            let $input = $container.find(".medicine-autocomplete");
            let $hidden = $container.find(".medicine-code");
            let $suggestionBox = $container.find(".medicine-suggestions");

            // Prevent duplicate selection
            let isDuplicate = false;
            $(".medicine-code").each(function () {
                if ($(this).val() === code && $(this)[0] !== $hidden[0]) {
                    isDuplicate = true;
                    return false;
                }
            });

            if (isDuplicate) {
                alert("⚠️ This medicine is already selected.");
                return;
            }

            $input.val(name);
            $hidden.val(code);
            $suggestionBox.hide();
        });

        // 3. Keyboard Navigation (Arrows & Enter)
        $(document).on("keydown", ".medicine-autocomplete", function (e) {
            let $input = $(this);
            let $container = $input.closest('td');
            let $box = $container.find(".medicine-suggestions");
            let $items = $box.find(".list-group-item-action");
            let $active = $items.filter(".active");

            if (e.key === "ArrowDown") {
                e.preventDefault();
                if ($active.length === 0) $items.first().addClass("active");
                else {
                    let $next = $active.removeClass("active").next();
                    if ($next.length) $next.addClass("active");
                    else $items.first().addClass("active");
                }
            }
            else if (e.key === "ArrowUp") {
                e.preventDefault();
                if ($active.length === 0) $items.last().addClass("active");
                else {
                    let $prev = $active.removeClass("active").prev();
                    if ($prev.length) $prev.addClass("active");
                    else $items.last().addClass("active");
                }
            }
            else if (e.key === "Enter") {
                // If dropdown is visible and item selected, choose it
                if ($box.is(":visible") && $active.length) {
                    e.preventDefault();
                    $active.click(); // Trigger the click logic defined above
                }
                // Note: If box is NOT visible, your other script handles the "Add New" button
            }
        });

        // 4. Hide suggestions if clicked outside
        $(document).click(function (e) {
            if (!$(e.target).closest(".medicine-autocomplete, .medicine-suggestions").length) {
                $(".medicine-suggestions").hide();
            }
        });
             });

        //for medicine check boxes select unselect
        $(document).on("click", "input[type=radio]", function () {
                 let $radio = $(this);

                 // If already checked, uncheck it
                 if ($radio.data("waschecked") === true) {
                     $radio.prop("checked", false);
                     $radio.data("waschecked", false);
                 } else {
                     // Unset all in group, set this one
                     $("input[name='" + $radio.attr("name") + "']").data("waschecked", false);
                     $radio.data("waschecked", true);
                 }
             });

        //Code for Lab
        $(document).ready(function () {
                let labIndex = 1; // start from 1 since [0] already exists

                // Generate new Lab row
                function getNewLabRow(index) {
                    return `
                <tr class="lab-item">
                <td class="position-relative">
                <input type="text"
                       class="form-control form-control-sm lab-autocomplete"
                       name="Labs[${index}].VchTestName"
                       placeholder="Search Lab Test" autocomplete="off">
                <input type="hidden"
                       name="Labs[${index}].VchTestCode"
                       class="lab-code">
                <div class="list-group position-absolute w-100 lab-suggestions"
                     style="z-index:999; display:none;"></div>
                </td>
                <td>
                <select class="form-select form-select-sm"
                        name="Labs[${index}].VchPriority">
                    <option value="">-- Select --</option>
                    <option value="Normal">Normal</option>
                    <option value="Urgent">Urgent</option>
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm remove-lab">
                    <i class="bi bi-x-lg text-white"></i>
                </button>
                <button type="button" class="btn btn-success btn-sm add-lab-row">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </td>
        </tr>`;
                }

                // Add row beside
                $(document).on("click", ".add-lab-row", function () {
                    $(this).closest(".lab-item").after(getNewLabRow(labIndex));
                    reIndexLabRows();
                });

                // Remove row
                $(document).on("click", ".remove-lab", function () {
                    if ($(".lab-item").length > 1) {
                        $(this).closest(".lab-item").remove();
                        reIndexLabRows();
                    }
                });

                // Re-index rows
                function reIndexLabRows() {
                    $("#lab-list tr.lab-item").each(function (i, row) {
                        $(row).find("input, select").each(function () {
                            let name = $(this).attr("name");
                            if (name) {
                                $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                            }
                        });
                    });
                    labIndex = $("#lab-list tr.lab-item").length;
                }

                // Prevent duplicates
                function isLabDuplicate(code, name, currentRow) {
                    let duplicate = false;
                    $("#lab-list tr.lab-item").not(currentRow).each(function () {
                        let lCode = $(this).find(".lab-code").val();
                        let lName = $(this).find(".lab-autocomplete").val();
                        if (lCode === code || lName === name) {
                            duplicate = true;
                            return false;
                        }
                    });
                    return duplicate;
                }

                // Autocomplete (search Lab tests)
                $(document).on("keyup", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let query = $input.val().trim();
                    let $box = $input.siblings(".lab-suggestions");
                    let $hidden = $input.siblings(".lab-code");

                    if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");
                    if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                    if (query.length >= 1) {
                        $.ajax({
                            url: "/Assessment/SearchLab",
                            type: "GET",
                            data: { term: query },
                            success: function (data) {
                                let list = data?.$values || data; // 👈 Use $values if present, else fallback                            
                                $box.empty();
                                    if (data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                        $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                     data-name="${item.descript}" data-code="${item.tcode}">
                                                     ${item.descript} <small class="text-muted">(${item.tcode})</small>
                                                     </a>`);
                                    });
                                    $box.show();
                                } else $box.hide();
                            }
                        });
                    } else $box.hide();
                });

                // Keyboard navigation
                $(document).on("keydown", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let $items = $input.siblings(".lab-suggestions").find(".list-group-item-action");
                    let $active = $items.filter(".active");

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        if ($active.length === 0) $items.first().addClass("active");
                        else { $active.removeClass("active").next().addClass("active"); }
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        if ($active.length === 0) $items.last().addClass("active");
                        else { $active.removeClass("active").prev().addClass("active"); }
                    } else if (e.key === "Enter") {
                        if ($active.length) {
                            e.preventDefault();
                            let name = $active.data("name");
                            let code = $active.data("code");
                            let $row = $input.closest("tr");

                            if (isLabDuplicate(code, name, $row)) {
                                alert("⚠️ This lab test is already selected!");
                                return;
                            }

                            $input.val(name);
                            $input.siblings(".lab-code").val(code);
                            $input.siblings(".lab-suggestions").hide();
                        }
                    }
                });

                // Select from mouse click
                $(document).on("click", ".lab-suggestions a", function (e) {
                    e.preventDefault();
                    let $input = $(this).closest(".position-relative").find(".lab-autocomplete");
                    let name = $(this).data("name");
                    let code = $(this).data("code");
                    let $row = $input.closest("tr");

                    if (isLabDuplicate(code, name, $row)) {
                        alert("⚠️ This lab test is already selected!");
                        return;
                    }

                    $input.val(name);
                    $input.siblings(".lab-code").val(code);
                    $(this).parent().hide();
                });

                // Hide suggestions on outside click
                $(document).click(function (e) {
                    if (!$(e.target).closest(".lab-autocomplete, .lab-suggestions").length) {
                        $(".lab-suggestions").hide();
                    }
                });

                // On blur clear invalid text
                $(document).on("blur", ".lab-autocomplete", function () {
                    let $input = $(this);
                    let $hidden = $input.siblings(".lab-code");
                    if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
                });              
            });

        //Radiology code
        $(document).ready(function () {
            let radioIndex = 1; // start from 1 since 0 already exists

            function getNewRadioRow(index) {
                return `
                <tr class="radio-item">
                    <td class="position-relative">
                        <input type="text"
                               class="form-control form-control-sm radio-autocomplete"
                               name="Radiology[${index}].VchRadiologyName"
                               placeholder="Search Radiology Test" autocomplete="off">
                        <input type="hidden"
                               name="Radiology[${index}].VchRadiologyCode"
                               class="radio-code">
                        <div class="list-group position-absolute w-100 radio-suggestions"
                             style="z-index:999; display:none;"></div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm"
                                name="Radiology[${index}].VchPriority">
                            <option value="">-- Select --</option>
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                            <i class="bi bi-x-lg text-white"></i>
                        </button>
                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </td>
                </tr>`;
            }

            $(document).on("click", ".add-radio-row", function () {
                $(this).closest(".radio-item").after(getNewRadioRow(radioIndex));
                reIndexRadioRows();
            });

            $(document).on("click", ".remove-radio", function () {
                if ($(".radio-item").length > 1) {
                    $(this).closest(".radio-item").remove();
                    reIndexRadioRows();
                }
            });

            function reIndexRadioRows() {
                $("#radio-list tr.radio-item").each(function (i, row) {
                    $(row).find("input, select").each(function () {
                        let name = $(this).attr("name");
                        if (name) {
                            $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                        }
                    });
                });
                radioIndex = $("#radio-list tr.radio-item").length;
            }

            function isRadiologyDuplicate(code, name, currentRow) {
                let duplicate = false;
                $("#radio-list tr.radio-item").not(currentRow).each(function () {
                    let rCode = $(this).find(".radio-code").val();
                    let rName = $(this).find(".radio-autocomplete").val();
                    if (rCode === code || rName === name) {
                        duplicate = true;
                        return false;
                    }
                });
                return duplicate;
            }

            $(document).on("keyup", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let query = $input.val().trim();
                let $box = $input.siblings(".radio-suggestions");
                let $hidden = $input.siblings(".radio-code");

                if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");

                if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                if (query.length >= 1) {
                    $.ajax({
                        url: "/Assessment/SearchRadiology",
                        type: "GET",
                        data: { term: query, type: "Radio" },
                        success: function (data) {
                           let list = data?.$values || data; // 👈 Use $values if present, else fallback
                            $box.empty();
                                if(data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                    $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                 data-name="${item.service}" data-code="${item.scode}">
                                                 ${item.service} <small class="text-muted">(${item.scode})</small>
                                                 </a>`);
                                });
                                $box.show();
                            } else $box.hide();
                        }
                    });
                } else $box.hide();
            });

            $(document).on("keydown", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let $items = $input.siblings(".radio-suggestions").find(".list-group-item-action");
                let $active = $items.filter(".active");

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if ($active.length === 0) $items.first().addClass("active");
                    else { $active.removeClass("active").next().addClass("active"); }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if ($active.length === 0) $items.last().addClass("active");
                    else { $active.removeClass("active").prev().addClass("active"); }
                } else if (e.key === "Enter") {
                    if ($active.length) {
                        e.preventDefault();
                        let name = $active.data("name");
                        let code = $active.data("code");
                        let $row = $input.closest("tr");

                        if (isRadiologyDuplicate(code, name, $row)) {
                            alert("⚠️ This radiology is already selected!");
                            return;
                        }

                        $input.val(name);
                        $input.siblings(".radio-code").val(code);
                        $input.siblings(".radio-suggestions").hide();
                    }
                }
            });

            $(document).on("click", ".radio-suggestions a", function (e) {
                e.preventDefault();
                let $input = $(this).closest(".position-relative").find(".radio-autocomplete");
                let name = $(this).data("name");
                let code = $(this).data("code");
                let $row = $input.closest("tr");

                if (isRadiologyDuplicate(code, name, $row)) {
                    alert("⚠️ This radiology is already selected!");
                    return;
                }

                $input.val(name);
                $input.siblings(".radio-code").val(code);
                $(this).parent().hide();
            });

            $(document).click(function (e) {
                if (!$(e.target).closest(".radio-autocomplete, .radio-suggestions").length) {
                    $(".radio-suggestions").hide();
                }
            });

            $(document).on("blur", ".radio-autocomplete", function () {
                let $input = $(this);
                let $hidden = $input.siblings(".radio-code");
                if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
            });
                
            // if (!isValid) {
            //     e.preventDefault(); // stop form submission
            //     return;
            // }

          //Remove empty rows before submit (to set count 0 on post if empty)
           $("form").on("submit", function () {
            // Remove empty radiology rows
            $("#radio-list tr.radio-item").filter(function () {
                let code = $(this).find(".radio-code").val();
                return !code || code.trim() === "";
              }).remove();

            // Reindex remaining rows
               reIndexRadioRows();
           });
           });
   

        //Procedure
        $(document).ready(function () {
             let procIndex = 1; // start from 1 since [0] already exists

             // Function to generate new Procedure row
             function getNewProcedureRow(index) {
                 return `
                 <tr class="procedure-item">
                     <!-- Procedure -->
                     <td class="position-relative">
                         <input type="text"
                                class="form-control form-control-sm procedure-autocomplete"
                                name="Procedures[${index}].VchProcedureName"
                                placeholder="Search Procedure" autocomplete="off">
                         <input type="hidden"
                                name="Procedures[${index}].VchProcedureCode"
                                class="procedure-code">
                         <div class="list-group position-absolute w-100 procedure-suggestions"
                              style="z-index:999; display:none;"></div>
                     </td>

                     <!-- Priority -->
                     <td>
                         <select class="form-select form-select-sm" name="Procedures[${index}].VchPriority">
                             <option value="">-- Select --</option>
                             <option value="Normal">Normal</option>
                             <option value="Urgent">Urgent</option>
                         </select>
                     </td>
                     <!-- Action -->
                     <td class="text-center">
                         <button type="button" class="btn btn-danger btn-sm remove-procedure">
                             <i class="bi bi-x-lg text-white"></i>
                         </button>
                         <button type="button" class="btn btn-success btn-sm add-procedure-row">
                             <i class="bi bi-plus-lg"></i>
                         </button>
                     </td>
                 </tr>`;
             }

             // Add row beside
             $(document).on("click", ".add-procedure-row", function () {
                 $(this).closest(".procedure-item").after(getNewProcedureRow(procIndex));
                 reIndexProcedureRows();
             });

             // Remove row (keep at least 1 row)
             $(document).on("click", ".remove-procedure", function () {
                 if ($(".procedure-item").length > 1) {
                     $(this).closest(".procedure-item").remove();
                     reIndexProcedureRows();
                 }
             });

             // Re-index rows after add/remove
             function reIndexProcedureRows() {
                 $("#procedure-list tr.procedure-item").each(function (i, row) {
                     $(row).find("input, select").each(function () {
                         let name = $(this).attr("name");
                         if (name) {
                             let newName = name.replace(/\[\d+\]/, `[${i}]`);
                             $(this).attr("name", newName);
                         }
                     });
                 });
                 procIndex = $("#procedure-list tr.procedure-item").length;
             }

             // Autocomplete Procedure search
             $(document).on("keyup", ".procedure-autocomplete", function (e) {
                 let input = $(this);
                 let query = input.val().trim();
                 let suggestionBox = input.siblings(".procedure-suggestions");
                 let hidden = input.siblings(".procedure-code");

                 if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                     hidden.val(""); // reset hidden if typing
                 }

                 if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                 if (query.length >= 1) {
                     $.ajax({
                         url: "/Assessment/SearchRadiology", // 🔹 your controller method
                         type: "GET",
                         data: { term: query, type:"Procedure" },
                         success: function (data) {
                             let list = data?.$values || data; // 👈 Use $values if present, else fallback
                                 suggestionBox.empty();
                                if(data.$values && data.$values.length > 0) {
                                    data.$values.forEach(item => {
                                     suggestionBox.append(
                                         `<a href="#" class="list-group-item list-group-item-action"
                                             data-name="${item.service}"
                                             data-code="${item.scode}">
                                             ${item.service} <small class="text-muted">(${item.scode})</small>
                                         </a>`
                                     );
                                 });
                                 suggestionBox.show();
                             } else {
                                 suggestionBox.hide();
                             }
                         }
                     });
                 } else {
                     suggestionBox.hide();
                 }
             });


             // Keyboard navigation
             $(document).on("keydown", ".procedure-autocomplete", function (e) {
                 let $input = $(this);
                 let $box = $input.siblings(".procedure-suggestions");
                 let $items = $box.find(".list-group-item-action");
                 let $active = $items.filter(".active");

                 if (e.key === "ArrowDown") {
                     e.preventDefault();
                     if ($active.length === 0) $items.first().addClass("active");
                     else {
                         let $next = $active.removeClass("active").next();
                         ($next.length ? $next : $items.first()).addClass("active");
                     }
                 }
                 else if (e.key === "ArrowUp") {
                     e.preventDefault();
                     if ($active.length === 0) $items.last().addClass("active");
                     else {
                         let $prev = $active.removeClass("active").prev();
                         ($prev.length ? $prev : $items.last()).addClass("active");
                     }
                 }
                 else if (e.key === "Enter") {
                     e.preventDefault();
                     e.stopPropagation();

                     if ($active.length) {
                         let name = $active.data("name");
                         let code = $active.data("code");

                         $input.val(name);
                         $input.siblings(".procedure-code").val(code);
                         $box.hide();
                     }
                 }
             });

             // Select from mouse click
             $(document).on("click", ".procedure-suggestions a", function (e) {
                 e.preventDefault();
                 let name = $(this).data("name");
                 let code = $(this).data("code");

                 let $container = $(this).closest(".position-relative");
                 let $input = $container.find(".procedure-autocomplete");
                 let $hidden = $container.find(".procedure-code");

                 // Prevent duplicate
                 let isDuplicate = false;
                 $(".procedure-autocomplete").each(function () {
                     let n = $(this).val();
                     let c = $(this).closest(".position-relative").find(".procedure-code").val();
                     if (n === name || c === code) {
                         isDuplicate = true;
                         return false;
                     }
                 });

                 if (isDuplicate) {
                     alert("⚠️ This procedure is already selected.");
                     return;
                 }

                 $input.val(name);
                 $hidden.val(code);
                 $(this).closest(".procedure-suggestions").hide();
             });

             // Hide suggestions if clicked outside
             $(document).click(function (e) {
                 if (!$(e.target).closest(".procedure-autocomplete, .procedure-suggestions").length) {
                     $(".procedure-suggestions").hide();
                 }
             });
         });

         //For supporting document
         const doctorDropZone = document.getElementById("doctor-drop-zone");
         const doctorFileInput = document.getElementById("doctorDocsInput");
         const doctorFileList = document.getElementById("doctor-file-list");

         doctorDropZone.addEventListener("click", () => doctorFileInput.click());

         doctorDropZone.addEventListener("dragover", (e) => {
             e.preventDefault();
             doctorDropZone.classList.add("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("dragleave", () => {
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("drop", (e) => {
             e.preventDefault();
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
             doctorFileInput.files = e.dataTransfer.files;
             displayDoctorFiles();
         });

         doctorFileInput.addEventListener("change", displayDoctorFiles);

         function displayDoctorFiles() {
             doctorFileList.innerHTML = "";
             let files = Array.from(doctorFileInput.files);

             if (files.length > 5) {
                 alert("❌ Maximum 5 files allowed.");
                 doctorFileInput.value = "";
                 return;
             }

             files.forEach((file, index) => {
                 const div = document.createElement("div");
                 div.className = "d-flex align-items-center mb-2 border p-2 rounded bg-light shadow-sm";
                 div.innerHTML = `
                     <i class="fas fa-file-alt text-primary me-2"></i>
                     <span class="text-truncate" style="max-width: 160px;">${file.name}</span>
                     <span class="badge bg-secondary ms-auto">${(file.size / 1024).toFixed(1)} KB</span>
                     <button type="button" class="btn btn-sm btn-outline-danger ms-auto remove-file" data-index="${index}">❌</button>
                 `;
                 doctorFileList.appendChild(div);
             });
         }

         doctorFileList.addEventListener("click", function(e){
             if(e.target.classList.contains("remove-file")){
                 const idx = e.target.getAttribute("data-index");
                 const dt = new DataTransfer();
                 Array.from(doctorFileInput.files).forEach((file, i) => {
                     if(i != idx) dt.items.add(file);
                 });
                 doctorFileInput.files = dt.files;
                 displayDoctorFiles();
             }
         });


        //Global modal reference
        const modalEl = document.getElementById('templateModal');
       
        //Top button actions
        $(function () {
                    $(function () {
            // 1️⃣ DEFINITION REQUIRED HERE (Fixes ReferenceError)
            const modalEl = document.getElementById('templateModal');

            // --- Load dropdown dynamically ---
            function loadTemplatesDropdown() {
                const dropdown = $("#templateDropdown");
                dropdown.empty().append('<option value="">-- Loading Templates... --</option>');

                $.ajax({
                    url: "/Assessment/GetAllTemplates",
                    type: "GET",
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        dropdown.empty().append('<option value="">-- Select Template --</option>');

                        // 2️⃣ ROBUST DATA EXTRACTION
                        // Checks for multiple possible JSON formats (.NET wrapper vs Standard Array)
                        let list = [];
                        if (data) {
                            if (data.templates && data.templates.$values) {
                                list = data.templates.$values;
                            } else if (data.$values) {
                                list = data.$values;
                            } else if (Array.isArray(data)) {
                                list = data;
                            } else if (data.templates && Array.isArray(data.templates)) {
                                list = data.templates;
                            }
                        }

                        if (list.length > 0) {
                            list.forEach(item => {
                                if (item && item.value && item.text) {
                                    dropdown.append(`<option value="${item.value}">${item.text}</option>`);
                                }
                            });
                        } else {
                            dropdown.append('<option value="">No templates found</option>');
                        }
                    },
                    error: function () {
                        dropdown.empty().append('<option value="">⚠️ Error loading templates</option>');
                    }
                });
            }

            // --- Safe modal open (for templates) ---
            function openTemplateModal(e) {
                e.preventDefault();
                document.activeElement?.blur();

                // Cleanup stuck state
                // (Safe to use here because modalEl is now defined)
                const existingInstance = bootstrap.Modal.getInstance(modalEl);
                if (existingInstance) {
                    existingInstance.hide();
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('overflow', 'auto');
                }

                // Reload dropdown before showing
                loadTemplatesDropdown();

                // Open modal
                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
                modalInstance.show();
            }

            // --- Close modal with success message ---
            // Make this global so other scripts can call it if needed
            window.closeTemplateModalWithSuccess = function(message = "✅ Data loaded successfully!") {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (!modalInstance) return;

                modalEl.addEventListener('hidden.bs.modal', function handleHidden() {
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open').css('overflow', 'auto');
                    modalEl.removeEventListener('hidden.bs.modal', handleHidden);

                    // Use the Alert Container if available, fallback to alert()
                    if($("#js-alert-container").length) {
                         let successHtml = `
                            <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                                <i class="bi bi-check-circle-fill me-2"></i> ${message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>`;
                        $("#js-alert-container").html(successHtml);
                        setTimeout(() => $("#js-alert-container .alert").fadeOut(), 3000);
                    } else {
                        setTimeout(() => alert(message), 200);
                    }
                });

                modalInstance.hide();
            }

            // --- Render Function ---
            function renderAssessmentData(t) {
                // Clear existing data
                $("textarea[name^='DoctorAssessment.']").val("");
                $("#medicine-list, #lab-list, #radio-list, #procedure-list").empty();

                // Clinical text fields
                const setOrClearField = (selector, value) => {
                    $(selector).val(value && value.trim() !== "" ? value : "");
                };

                setOrClearField("textarea[name='DoctorAssessment.VchChiefcomplaints']", t.vchChiefcomplaints);
                setOrClearField("textarea[name='DoctorAssessment.VchMedicalHistory']", t.vchMedicalHistory);
                setOrClearField("textarea[name='DoctorAssessment.VchSystemicexam']", t.vchSystemicexam);
                setOrClearField("textarea[name='DoctorAssessment.VchDiagnosis']", t.vchDiagnosis);
                setOrClearField("textarea[name='DoctorAssessment.VchRemarks']", t.vchRemarks);

                // --- Medicines ---
                const meds = t.medicines?.$values || t.medicines || [];
                meds.forEach((m, i) => {
                    $("#medicine-list").append(`
                        <tr class="medicine-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm medicine-autocomplete"
                                       name="Medicines[${i}].VchMedicineName" value="${m.vchMedicineName || ''}" autocomplete="off">
                                <input type="hidden" name="Medicines[${i}].VchMedicineCode" class="medicine-code" value="${m.vchMedicineCode || ''}">
                                <div class="list-group position-absolute w-100 medicine-suggestions" style="z-index:999; display:none;"></div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm" name="Medicines[${i}].IntQuantity" value="${m.intQuantity || ''}"></td>
                            <td><input type="text" class="form-control form-control-sm" name="Medicines[${i}].VchFrequency" value="${m.vchFrequency || ''}"></td>
                            <td><input type="text" class="form-control form-control-sm" name="Medicines[${i}].VchDuration" value="${m.vchDuration || ''}"></td>
                            <td>
                                <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="BBF" ${m.bitBbf ? 'checked' : ''}> BBF</label>
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="ABF" ${m.bitAbf ? 'checked' : ''}> ABF</label>
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="BL" ${m.bitBl ? 'checked' : ''}> BL</label>
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="AL" ${m.bitAl ? 'checked' : ''}> AL</label>
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="BD" ${m.bitBd ? 'checked' : ''}> BD</label>
                                    <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="AD" ${m.bitAd ? 'checked' : ''}> AD</label>
                                </div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-medicine"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-medicine-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });

                // --- Labs ---
                const labs = t.labs?.$values || t.labs || [];
                labs.forEach((l, i) => {
                    $("#lab-list").append(`
                        <tr class="lab-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm lab-autocomplete"
                                       name="Labs[${i}].VchTestName" value="${l.vchTestName || ''}" autocomplete="off">
                                <input type="hidden" class="lab-code" name="Labs[${i}].VchTestCode" value="${l.vchTestCode || ''}">
                                <div class="list-group position-absolute w-100 lab-suggestions" style="z-index:999;display:none;"></div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" name="Labs[${i}].VchPriority">
                                    <option value="">-- Priority --</option>
                                    <option value="Normal" ${l.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                    <option value="Urgent" ${l.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-lab"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-lab-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });

                // --- Radiology ---
                const radios = t.radiology?.$values || t.radiology || [];
                radios.forEach((r, i) => {
                    $("#radio-list").append(`
                        <tr class="radio-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm radio-autocomplete"
                                       name="Radiology[${i}].VchRadiologyName" value="${r.vchRadiologyName || ''}" autocomplete="off">
                                <input type="hidden" class="radio-code" name="Radiology[${i}].VchRadiologyCode" value="${r.vchRadiologyCode || ''}">
                                <div class="list-group position-absolute w-100 radio-suggestions" style="z-index:999;display:none;"></div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" name="Radiology[${i}].VchPriority">
                                    <option value="">-- Priority --</option>
                                    <option value="Normal" ${r.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                    <option value="Urgent" ${r.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-radio"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-radio-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });

                // --- Procedures ---
                const procs = t.procedures?.$values || t.procedures || [];
                procs.forEach((p, i) => {
                    $("#procedure-list").append(`
                        <tr class="procedure-item">
                            <td class="position-relative">
                                <input type="text" class="form-control form-control-sm procedure-autocomplete"
                                       name="Procedures[${i}].VchProcedureName" value="${p.vchProcedureName || ''}" autocomplete="off">
                                <input type="hidden" class="procedure-code" name="Procedures[${i}].VchProcedureCode" value="${p.vchProcedureCode || ''}">
                                <div class="list-group position-absolute w-100 procedure-suggestions" style="z-index:999;display:none;"></div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" name="Procedures[${i}].VchPriority">
                                    <option value="">-- Priority --</option>
                                    <option value="Normal" ${p.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
                                    <option value="Urgent" ${p.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-procedure"><i class="bi bi-x-lg text-white"></i></button>
                                <button type="button" class="btn btn-success btn-sm add-procedure-row"><i class="bi bi-plus-lg"></i></button>
                            </td>
                        </tr>
                    `);
                });
            }

            // 3️⃣ BIND THE CLICK EVENT
            // Ensure your HTML button has id="btnOpenTemplate"
            $(document).off('click', '#btnOpenTemplate').on('click', '#btnOpenTemplate', openTemplateModal);

            // 4️⃣ APPLY TEMPLATE LOGIC (With Button Loading State)
            $("#applyTemplate").off('click').on("click", function () {
                const templateId = $("#templateDropdown").val();
                if (!templateId) {
                    alert("⚠️ Please select a template first!");
                    return;
                }

                // Disable button to prevent double clicks
                const $btn = $(this);
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Applying...');

                $.getJSON(`/Assessment/LoadTemplateData?type=template&id=${templateId}`, function (data) {
                    if (data.success && data.data) {
                        renderAssessmentData(data.data);
                        closeTemplateModalWithSuccess("✅ Template applied successfully!");
                    } else {
                        alert("⚠️ Template data not found!");
                    }
                })
                .fail(function() {
                    alert("❌ Error loading template data.");
                })
                .always(function() {
                    $btn.prop('disabled', false).html(originalText);
                });
            });
        });

           //Function for load template and Last history too
           //  // --- Load dropdown dynamically ---
           //  function loadTemplatesDropdown() {
           //      const dropdown = $("#templateDropdown");
           //      dropdown.empty().append('<option value="">-- Loading Templates... --</option>');
           //      $.ajax({
           //          url: "/Assessment/GetAllTemplates",
           //          type: "GET",
           //          dataType: "json",
           //          cache: false,
           //          success: function (data) {
           //              dropdown.empty().append('<option value="">-- Select Template --</option>');
           //              if (data && data.success && data.templates && data.templates.$values) {
           //                  data.templates.$values.forEach(item => {
           //                      if (item && item.value && item.text) {
           //                          dropdown.append(`<option value="${item.value}">${item.text}</option>`);
           //                      }
           //                  });
           //              } else {
           //                  dropdown.append('<option value="">No templates found</option>');
           //              }
           //          },
           //          error: function () {
           //              dropdown.empty().append('<option value="">⚠️ Error loading templates</option>');
           //          }
           //      });
           //  }

           // // --- Safe modal open (for templates) ---
           // function openTemplateModal(e) {
           //      e.preventDefault();
           //      document.activeElement?.blur();

           //      // Cleanup stuck state
           //      const existingInstance = bootstrap.Modal.getInstance(modalEl);
           //      if (existingInstance) {
           //          existingInstance.hide();
           //          $('.modal-backdrop').remove();
           //          $('body').removeClass('modal-open').css('overflow', 'auto');
           //      }

           //      // Reload dropdown before showing
           //      loadTemplatesDropdown();

           //      // Open modal
           //      const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
           //      modalInstance.show();
           //  }

           // // --- Close modal with success message ---
           // function closeTemplateModalWithSuccess(message = "✅ Data loaded successfully!") {
           //      const modalInstance = bootstrap.Modal.getInstance(modalEl);
           //      if (!modalInstance) return;

           //      modalEl.addEventListener('hidden.bs.modal', function handleHidden() {
           //          $('.modal-backdrop').remove();
           //          $('body').removeClass('modal-open').css('overflow', 'auto');
           //          modalEl.removeEventListener('hidden.bs.modal', handleHidden);
           //          setTimeout(() => alert(message), 200);
           //      });

           //      modalInstance.hide();
           //  }

           // function renderAssessmentData(t) {
           //  // Clear existing data
           //  $("textarea[name^='DoctorAssessment.']").val("");
           //  $("#medicine-list, #lab-list, #radio-list, #procedure-list").empty();

           //  // Clinical text fields
           //  const setOrClearField = (selector, value) => {
           //      $(selector).val(value && value.trim() !== "" ? value : "");
           //  };
           //     setOrClearField("textarea[name='DoctorAssessment.VchChiefcomplaints']", t.vchChiefcomplaints);
           //                  setOrClearField("textarea[name='DoctorAssessment.VchMedicalHistory']", t.vchMedicalHistory);
           //                  setOrClearField("textarea[name='DoctorAssessment.VchSystemicexam']", t.vchSystemicexam);
           //                  setOrClearField("textarea[name='DoctorAssessment.VchDiagnosis']", t.vchDiagnosis);
           //                  setOrClearField("textarea[name='DoctorAssessment.VchRemarks']", t.vchRemarks);

           //                  // --- Medicines ---
           //                  const meds = t.medicines?.$values || t.medicines || [];
           //                  meds.forEach((m, i) => {
           //                      $("#medicine-list").append(`
           //                          <tr class="medicine-item">
           //                              <td class="position-relative">
           //                                  <input type="text" class="form-control form-control-sm medicine-autocomplete"
           //                                      name="Medicines[${i}].VchMedicineName"
           //                                      value="${m.vchMedicineName || ''}" autocomplete="off">
           //                                  <input type="hidden" name="Medicines[${i}].VchMedicineCode"
           //                                      class="medicine-code" value="${m.vchMedicineCode || ''}">
           //                                  <div class="list-group position-absolute w-100 medicine-suggestions"
           //                                      style="z-index:999; display:none;"></div>
           //                              </td>
           //                              <td><input type="number" class="form-control form-control-sm"
           //                                  name="Medicines[${i}].IntQuantity" value="${m.intQuantity || ''}"></td>
           //                              <td><input type="text" class="form-control form-control-sm"
           //                                  name="Medicines[${i}].VchFrequency" value="${m.vchFrequency || ''}"></td>
           //                              <td><input type="text" class="form-control form-control-sm"
           //                                  name="Medicines[${i}].VchDuration" value="${m.vchDuration || ''}"></td>
           //                                      <td>
           //                              <div class="d-flex flex-wrap justify-content-center gap-2 small">
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="BBF" ${m.bitBbf ? 'checked' : ''}> BBF</label>
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].BreakfastTiming" value="ABF" ${m.bitAbf ? 'checked' : ''}> ABF</label>
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="BL" ${m.bitBl ? 'checked' : ''}> BL</label>
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].LunchTiming" value="AL" ${m.bitAl ? 'checked' : ''}> AL</label>
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="BD" ${m.bitBd ? 'checked' : ''}> BD</label>
           //                                  <label><input type="radio" class="form-check-input scale-radio" name="Medicines[${i}].DinnerTiming" value="AD" ${m.bitAd ? 'checked' : ''}> AD</label>
           //                              </div>
           //                              <td class="text-center">
           //                                  <button type="button" class="btn btn-danger btn-sm remove-medicine"><i class="bi bi-x-lg text-white"></i></button>
           //                                  <button type="button" class="btn btn-success btn-sm add-medicine-row"><i class="bi bi-plus-lg"></i></button>
           //                              </td>
           //                                   <!-- Timings -->

           //                          </tr>
           //                      `);
           //                  });
           //                  // --- Labs ---
           //                  const labs = t.labs?.$values || t.labs || [];
           //                  labs.forEach((l, i) => {
           //                      $("#lab-list").append(`
           //                          <tr class="lab-item">
           //                              <td class="position-relative">
           //                                  <input type="text" class="form-control form-control-sm lab-autocomplete"
           //                                      name="Labs[${i}].VchTestName" value="${l.vchTestName || ''}" autocomplete="off">
           //                                  <input type="hidden" class="lab-code" name="Labs[${i}].VchTestCode"
           //                                      value="${l.vchTestCode || ''}">
           //                                  <div class="list-group position-absolute w-100 lab-suggestions" style="z-index:999;display:none;"></div>
           //                              </td>
           //                              <td>
           //                                  <select class="form-select form-select-sm" name="Labs[${i}].VchPriority">
           //                                      <option value="">-- Priority --</option>
           //                                      <option value="Normal" ${l.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
           //                                      <option value="Urgent" ${l.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
           //                                  </select>
           //                              </td>
           //                              <td class="text-center">
           //                                  <button type="button" class="btn btn-danger btn-sm remove-lab"><i class="bi bi-x-lg text-white"></i></button>
           //                                  <button type="button" class="btn btn-success btn-sm add-lab-row"><i class="bi bi-plus-lg"></i></button>
           //                              </td>
           //                          </tr>
           //                      `);
           //                  });

           //                  // --- Radiology ---
           //                  const radios = t.radiology?.$values || t.radiology || [];
           //                  radios.forEach((r, i) => {
           //                      $("#radio-list").append(`
           //                          <tr class="radio-item">
           //                              <td class="position-relative">
           //                                  <input type="text" class="form-control form-control-sm radio-autocomplete"
           //                                      name="Radiology[${i}].VchRadiologyName" value="${r.vchRadiologyName || ''}" autocomplete="off">
           //                                  <input type="hidden" class="radio-code" name="Radiology[${i}].VchRadiologyCode"
           //                                      value="${r.vchRadiologyCode || ''}">
           //                                  <div class="list-group position-absolute w-100 radio-suggestions" style="z-index:999;display:none;"></div>
           //                              </td>
           //                              <td>
           //                                  <select class="form-select form-select-sm" name="Radiology[${i}].VchPriority">
           //                                      <option value="">-- Priority --</option>
           //                                      <option value="Normal" ${r.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
           //                                      <option value="Urgent" ${r.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
           //                                  </select>
           //                              </td>
           //                              <td class="text-center">
           //                                  <button type="button" class="btn btn-danger btn-sm remove-radio"><i class="bi bi-x-lg text-white"></i></button>
           //                                  <button type="button" class="btn btn-success btn-sm add-radio-row"><i class="bi bi-plus-lg"></i></button>
           //                              </td>
           //                          </tr>
           //                      `);
           //                  });

           //                  // --- Procedures ---
           //                  const procs = t.procedures?.$values || t.procedures || [];
           //                  procs.forEach((p, i) => {
           //                      $("#procedure-list").append(`
           //                          <tr class="procedure-item">
           //                              <td class="position-relative">
           //                                  <input type="text" class="form-control form-control-sm procedure-autocomplete"
           //                                      name="Procedures[${i}].VchProcedureName" value="${p.vchProcedureName || ''}" autocomplete="off">
           //                                  <input type="hidden" class="procedure-code" name="Procedures[${i}].VchProcedureCode"
           //                                      value="${p.vchProcedureCode || ''}">
           //                                  <div class="list-group position-absolute w-100 procedure-suggestions" style="z-index:999;display:none;"></div>
           //                              </td>
           //                              <td>
           //                                  <select class="form-select form-select-sm" name="Procedures[${i}].VchPriority">
           //                                      <option value="">-- Priority --</option>
           //                                      <option value="Normal" ${p.vchPriority === "Normal" ? "selected" : ""}>Normal</option>
           //                                      <option value="Urgent" ${p.vchPriority === "Urgent" ? "selected" : ""}>Urgent</option>
           //                                  </select>
           //                              </td>
           //                              <td class="text-center">
           //                                  <button type="button" class="btn btn-danger btn-sm remove-procedure"><i class="bi bi-x-lg text-white"></i></button>
           //                                  <button type="button" class="btn btn-success btn-sm add-procedure-row"><i class="bi bi-plus-lg"></i></button>
           //                              </td>
           //                          </tr>
           //                      `);
           //                  });
           // }              
        
        // APPLY TEMPLATE button click      
        $("#applyTemplate").on("click", function () {
            const templateId = $("#templateDropdown").val();
            if (!templateId) {
                alert("⚠️ Please select a template first!");
                return;
            }

            $.getJSON(`/Assessment/LoadTemplateData?type=template&id=${templateId}`, function (data) {
                if (data.success && data.data) {
                    renderAssessmentData(data.data);
                        closeTemplateModalWithSuccess("✅ Template loaded successfully!");
                } else {
                    alert("⚠️ Template data not found!");
                }
            });
        });
      
       // --- Load History Button ---
       $("#btnLoadHistory").on("click", function () {
                    const uhid = $("#PatientId").val();
                if (!uhid) {
                    alert("⚠️ Please select a patient first!");
                    return;
                }

                $.getJSON(`/Assessment/LoadTemplateData?type=history&uhid=${uhid}`, function (data) {
                    if (data.success && data.data) {
                        renderAssessmentData(data.data);
                       alert("✅ Last history loaded successfully!");
                    } else {
                        alert(data.message || "⚠️ No previous assessment found!");
                    }
                });
            });

            // --- Bind open modal ---         
          $(document).off('click', '#btnOpenTemplate').on('click', '#btnOpenTemplate', openTemplateModal);
             // .off('click.useTemplate')
             // .on('click.useTemplate', '[data-bs-target="#templateModal"]', openTemplateModal);
            // Make close function globally available
            window.closeTemplateModalWithSuccess = closeTemplateModalWithSuccess;

                   // --- 2. View All History (Robust) ---
        $(document).off('click', '#btnViewHistory').on('click', '#btnViewHistory', function (e) {
            e.preventDefault();

            const uhid = '@Model.NursingAssessment.VchUhidNo';
            if (!uhid) {
                alert("⚠️ Please select a patient first!");
                return;
            }

            const tbody = $("#historyTable tbody");
            tbody.html('<tr><td colspan="7" class="text-center text-muted">⏳ Loading history...</td></tr>');

            // Open Modal First
            const modalEl = document.getElementById('historyModal');
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalInstance.show();

            $.getJSON(`/Assessment/AllHistory?uhid=${uhid}`, function (response) {
                if (response.success && response.data && response.data.$values.length > 0) {
                    tbody.empty();
                    response.data.$values.forEach((a, index) => {
                        tbody.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td>${a.visitno}</td>
                                <td>${a.uhid}</td>
                                <td>${a.hmsPatientName || 'N/A'}</td>
                                <td>${a.vchDiagnosis || 'N/A'}</td>
                                <td>${a.createdDate || ''}</td>
                                <td class="text-center">
                                    <button class="btn btn-outline-primary btn-sm load-history-item" data-id="${a.intId}">
                                        <i class="bi bi-download"></i> Load
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    tbody.html(`<tr><td colspan="7" class="text-center text-danger fw-semibold py-4">⚠️ No previous history found.</td></tr>`);
                }
            }).fail(() => {
                tbody.html(`<tr><td colspan="7" class="text-center text-danger fw-semibold py-4">❌ Error loading history.</td></tr>`);
            });
        });

              // --- Load Selected History into Current Assessment ---
                    // --- Load Selected History into Current Assessment ---
           $(document).on("click", ".load-history-item", function () {
                const id = $(this).data("id");
                const uhid = '@Model.NursingAssessment.VchUhidNo';

                if (!id || !uhid) {
                    alert("⚠️ Missing patient or record ID!");
                    return;
                }

                // Disable button while loading
                const btn = $(this);
                const originalHtml = btn.html();
                btn.prop("disabled", true).html('<span class="spinner-border spinner-border-sm me-1"></span>Loading...');

                $.getJSON(`/Assessment/LoadTemplateData?type=selectedHistory&uhid=${uhid}&id=${id}`, function (data) {
                    if (data.success && data.data) {
                        // ✅ Populate assessment data
                        renderAssessmentData(data.data);

                        // ✅ Close modal safely and remove backdrop
                        const modalEl = document.getElementById('historyModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();

                        // 🕒 Wait until modal is hidden before showing alert
                        modalEl.addEventListener('hidden.bs.modal', function handleHidden() {
                            modalEl.removeEventListener('hidden.bs.modal', handleHidden);
                            setTimeout(() => alert("✅ Selected history loaded successfully!"), 200);
                        });

                    } else {
                        alert("⚠️ Unable to load this record. Please try again!");
                    }
                })
                .fail(() => {
                    alert("❌ Failed to fetch history record from server.");
                })
                .always(() => {
                    btn.prop("disabled", false).html(originalHtml);
                });
            });

    });

    //for clinical tab       
        $(document).ready(function () {
            console.log("✅ Clinical Master Script Loaded");
            // Generate correct URLs using Razor (Server-side)
            const searchUrl = '@Url.Action("SearchMaster", "Assessment")';
            const addUrl = '@Url.Action("AddMasterItem", "Assessment")';

             function setupClinicalMaster(config) {
                const $searchBox = $(config.searchId);
                const $addBtn = $(config.addBtnId);
                const $targetArea = $(config.targetId);

                $searchBox.autocomplete({
                    appendTo: "body",
                    minLength: 0,
                    source: function (request, response) {
                        $.ajax({
                            url: searchUrl,
                            type: 'GET',
                            data: { term: request.term, type: config.type },
                            success: function (data) {
                                // 1. Get the list safely
                                let list = (data && data.$values) ? data.$values : data;
                                if (!Array.isArray(list)) list = [];

                                // 2. DEBUG: Log the first item to see exactly what Property Name is coming
                                if (list.length > 0) {
                                    console.log(`First item for ${config.type}:`, list[0]);
                                }

                                // 3. ROBUST MAPPING (The Fix)
                                let formatted = list.slice(0, 10).map(item => {
                                    // We try every possible property name the server might send
                                    let text = item.label || item.Label ||
                                               item.vchCheifComplaint || item.VchCheifComplaint ||
                                               item.vchDiagnose || item.VchDiagnose ||
                                               item.vchSystemicExamination || item.VchSystemicExamination || // <--- The specific fix
                                               item.value || item.Value;

                                    return {
                                        label: text,
                                        value: text
                                    };
                                });

                                response(formatted);
                            },
                            error: function () { response([]); }
                        });
                    },
                    select: function (event, ui) {
                        event.preventDefault();

                        let current = $targetArea.val().trim();
                        let toAdd = ui.item.value;

                        if (current === "") {
                            $targetArea.val(toAdd);
                        } else if (!current.toLowerCase().includes(toAdd.toLowerCase())) {
                            $targetArea.val(current + ", " + toAdd);
                        }
                        $searchBox.val('');
                    }
                }).on("focus", function () {
                    $(this).autocomplete("search", "");
                });

                // Add Button Logic
                $addBtn.on('click', function () {
                    let val = $searchBox.val().trim();
                    if (!val) { alert("⚠️ Please type a value to add."); return; }

                    $.post(addUrl, { name: val, type: config.type }, function (res) {
                        if (res.success) {
                            let current = $targetArea.val().trim();
                            if (current === "") $targetArea.val(val);
                            else if (!current.toLowerCase().includes(val.toLowerCase())) $targetArea.val(current + ", " + val);
                            $searchBox.val('');
                        } else {
                            alert("❌ Error: " + res.message);
                        }
                    });
                });

                // Enter Key Support
                $searchBox.on('keypress', function(e) {
                    if(e.which === 13) {
                        e.preventDefault();
                        if(!$searchBox.autocomplete("widget").is(":visible")) {
                             $addBtn.click();
                        }
                    }
                });
            }

            // Ensure this line exists and matches the IDs
        setupClinicalMaster({ searchId: '#searchCC', addBtnId: '#btnAddCC', targetId: '#txtCC', type: 'ChiefComplaint' });
            // <--- This string must match 'type == "Systemic"' in Controller
        setupClinicalMaster({searchId: '#searchSys',addBtnId: '#btnAddSys', targetId: '#txtSys', type: 'Systemic'      });
        setupClinicalMaster({ searchId: '#searchDiag', addBtnId: '#btnAddDiag', targetId: '#txtDiag', type: 'Diagnosis' });
        }); 
    
    </script>
    <style>
        /* Force Autocomplete to stay on top and be visible */
        .ui-front {
            z-index: 999999 !important;
        }

        .ui-autocomplete {
            position: absolute;
            cursor: default;
            z-index: 999999 !important;
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            list-style: none;
            padding: 0;
        }

        .ui-menu-item .ui-menu-item-wrapper {
            padding: 8px 12px;
            display: block;
            cursor: pointer;
        }

            .ui-menu-item .ui-menu-item-wrapper:hover, .ui-menu-item .ui-menu-item-wrapper.ui-state-active {
                background-color: #0d6efd;
                color: #ffffff;
                border: none;
            }
    </style>
    }

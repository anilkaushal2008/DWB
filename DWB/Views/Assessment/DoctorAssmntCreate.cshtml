@model DWB.Models.DoctorAssessmentVM
@{ 
    ViewData["Title"] = "DoctorAssessment";
    string formAction = Model.DoctorAssessment.IntId == 0 ? "Create" : "Edit";
}
<style>
    .scale-radio {
        transform: scale(1.2); /* increase radio button size */
        margin-right: 2.9px; /* space between button and label text */
        cursor: pointer;
    }</style>
<main class="main-wrapper py-4">  
   <div class="container-fluid">
        <h4 class="mb-4 fw-bold text-primary">
            @(Model.DoctorAssessment.IntId > 0 ? "Edit Doctor Assessment" : "New Doctor Assessment")
        </h4>
        <div class="card p-2 border-0 shadow-sm rounded-3 mb-2 bg-light">
            <div class="d-flex flex-wrap align-items-center small text-dark fw-semibold">
                <span class="me-3 text-primary" >Selected Patient|UHID: <span class="text-white">@Model.NursingAssessment.VchUhidNo</span></span>
                <span class="me-3 text-primary">Name: <span class="text-white">@Model.NursingAssessment.VchHmsname</span></span>
                <span class="me-3 text-primary">Visit No: <span class="text-white">@Model.NursingAssessment.IntIhmsvisit</span></span>
                <span><a class="btn btn-sm btn-grd-primary">View History</a> </span>&nbsp;
                <span><a class="btn btn-sm btn-grd-danger">Use last history</a> </span>
            </div>
        </div>
        <div class="card shadow-sm rounded-4">           
            <div class="card-body">                
                <form method="post" id="DAssessment" enctype="multipart/form-data"
                      asp-action="@(Model.DoctorAssessment.IntId > 0 ? "DocAssmntEdit" : "DocAssmntCreate")" asp-controller="Assessment">
                      @Html.HiddenFor(m=>m.DoctorAssessment.DtStartTime)
                      @Html.HiddenFor(m => m.DoctorAssessment.FkUhid)
                      @Html.HiddenFor(m => m.DoctorAssessment.FkAssessmentId)                      
                      @Html.HiddenFor(m => m.DoctorAssessment.FkVisitNo)                      
                      @Html.HiddenFor(m => m.DoctorAssessment.DtHmsentry)
                      @Html.HiddenFor(m => m.NursingAssessment.IntAssessmentId)
                    @* for edit assessment *@
                    @if(Model.DoctorAssessment.IntId != 0)
                    {
                        @Html.HiddenFor(mbox=>Model.DoctorAssessment.IntId)
                    }

                    <!-- Submit -->                   
                    <div align="right" class="text-end mt-1 my-1">
                        <button type="submit" class="btn btn-sm btn-primary px-4 py-2 rounded-pill shadow-sm">
                            @(Model.DoctorAssessment.IntId > 0 ? "✅ Update Assessment" : "✅ Save Assessment")
                        </button>
                    </div>
                    <!-- Nav Tabs -->
                    <ul class="nav nav-pills mb-3 justify-content-center" id="docAssessmentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patient" type="button" role="tab">
                                👤 Initial Assessment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="clinical-tab" data-bs-toggle="tab" data-bs-target="#clinical" type="button" role="tab">
                                🩺 Clinical
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medicine-tab" data-bs-toggle="tab" data-bs-target="#medicine" type="button" role="tab">
                                💊 Medicines
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="lab-tab" data-bs-toggle="tab" data-bs-target="#lab" type="button" role="tab">
                                🧪 Lab
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="radiology-tab" data-bs-toggle="tab" data-bs-target="#radiology" type="button" role="tab">
                                🩻 Radiology
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="procedure-tab" data-bs-toggle="tab" data-bs-target="#procedure" type="button" role="tab">
                                💉 Procedure
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="followup-tab" data-bs-toggle="tab" data-bs-target="#followup" type="button" role="tab">
                                📅 Follow Up
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                                📂 Documents
                            </button>
                        </li>
                    </ul>
                   
                        <!-- Tab Content -->
                        <div class="tab-content" id="docAssessmentContent">
                        <!-- Patient -->
                        <hr />
                        <div class="tab-pane fade show active" id="patient" role="tabpanel">                         
                           <div class="row g-3">
                                <!-- VITAL SIGNS -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm  border-top border-primary rounded-3 text-white bg-light h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-primary d-flex align-items-center">
                                                💓 VITAL SIGNS
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">BP (MMHG):</strong> <span>@Model.NursingAssessment.VchBloodPressure</span></div>
                                                <div class="col-6"><strong class="text-secondary">PULSE:</strong> <span>@Model.NursingAssessment.VchPulse</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">TEMP (°F):</strong> <span>@Model.NursingAssessment.DecTemperature</span></div>
                                                <div class="col-6"><strong class="text-secondary">SPO₂ (%):</strong> <span>@Model.NursingAssessment.DecSpO2</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">WEIGHT (KG):</strong> <span>@Model.NursingAssessment.DecWeight</span></div>
                                                <div class="col-6"><strong class="text-secondary">HEIGHT (CM):</strong> <span>@Model.NursingAssessment.DecHeight</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">RESP RATE:</strong> <span>@Model.NursingAssessment.DecRespiratoryRate</span></div>
                                                <div class="col-6"><strong class="text-secondary">O₂ FLOW:</strong> <span>@Model.NursingAssessment.DecOxygenFlowRate</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAST HISTORY -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-danger bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-danger flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>🩺 PAST HISTORY
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">DIABETES:</strong> <span>@(Model.NursingAssessment.BitDiabetes ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">HEART DISEASE:</strong> <span>@(Model.NursingAssessment.BitHeartDisease ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">HYPERTENSION:</strong> <span>@(Model.NursingAssessment.BitHypertension ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">ASTHMA:</strong> <span>@(Model.NursingAssessment.BitAsthma ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">HIGH CHOLESTEROL:</strong> <span>@(Model.NursingAssessment.BitCholesterol ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">TUBERCULOSIS:</strong> <span>@(Model.NursingAssessment.BitTuberculosis ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-6"><strong class="text-secondary">SURGERY:</strong> <span>@(Model.NursingAssessment.BitSurgery ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">HOSPITALIZED (LAST 3 MO):</strong> <span>@(Model.NursingAssessment.BitHospitalization ? "YES" : "NO")</span></div>
                                            </div>
                                            <div class="row g-2">
                                                <div class="col-12"><strong class="text-secondary">OTHER HISTORY:</strong> <span>@Model.NursingAssessment.VchOtherHistory</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div class="row g-3">
                                <!-- PERSONAL HISTORY -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-success bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-success d-flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>🧬 PERSONAL HISTORY
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2">
                                                <div class="col-6"><strong class="text-secondary">ALLERGIES:</strong> <span>@(Model.NursingAssessment.BitIsAllergical? Model.NursingAssessment.VchAllergicalDrugs : "N/A")</span></div>
                                                <div class="col-6"><strong class="text-secondary">ALCOHOL:</strong> <span>@(Model.NursingAssessment.BitIsAlcoholic ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">SMOKING:</strong> <span>@(Model.NursingAssessment.BitIsSmoking ? "YES" : "NO")</span></div>
                                                <div class="col-6"><strong class="text-secondary">LMP (FEMALES):</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchLmpForFemale) ? "N/A" : Model.NursingAssessment.VchLmpForFemale)</span></div>
                                                <div class="col-6"><strong class="text-secondary">OCCUPATION:</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchOccupation) ? "N/A" : Model.NursingAssessment.VchOccupation)</span></div>
                                                <div class="col-6"><strong class="text-secondary">PSYCHOLOGICAL STATUS:</strong> <span>@(string.IsNullOrEmpty(Model.NursingAssessment.VchSocialEconomicStatus) ? "N/A" : Model.NursingAssessment.VchSocialEconomicStatus)</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Support Document -->
                                <div class="col-md-6">
                                    <div class="card shadow-sm rounded-3 border-top border-info bg-light text-white h-100">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0 text-info d-flex align-items-center">
                                                <i class="fa-solid fa-dna me-2"></i>📂 SUPPORTING DOCUMENTS
                                            </h6>
                                        </div>
                                        <div class="card-body p-3 small">
                                            <div class="row g-2">
                                        <!-- Supporting Documents -->
                                        @if (Model.NursingAssessment.TblNassessmentDoc != null && Model.NursingAssessment.TblNassessmentDoc.Any())
                                            {
                                                @foreach (var document in Model.NursingAssessment.TblNassessmentDoc)
                                                {
                                                    <div class="col-auto text-center">
                                                        <a href="@Url.Content("~/uploads/NAssessment/" + document.VchFileName)" target="_blank" title="@document.VchFileName">
                                                            <div class="border rounded bg-white p-2 shadow-sm" style="width:70px; height:70px; display:flex; align-items:center; justify-content:center;">
                                                                <i class="fas fa-file-alt fa-2x text-info"></i>
                                                            </div>
                                                            <small class="d-block text-truncate" style="max-width:70px;">@document.VchFileName</small>
                                                        </a>
                                                    </div>
                                                }
                                            }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> 

                        <!-- Clinical -->
                        <div class="tab-pane fade" id="clinical" role="tabpanel">
                        <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                            <div class="row g-3">
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Chief Complaints<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchChiefcomplaints" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Medical History<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchMedicalHistory" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Systemic Examination<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchSystemicexam" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-md-6">
                                        <label class="form-label fw-bold">Diagnosis<span class="text-danger">*</span></label>
                                        <textarea asp-for="DoctorAssessment.VchDiagnosis" class="form-control required-field" rows="2"></textarea>
                                        <span class="text-danger small validation-msg"></span>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Remarks</label>
                                    <textarea asp-for="DoctorAssessment.VchRemarks" class="form-control" rows="3"></textarea>                                       
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- Medicines -->
                        <div class="tab-pane fade" id="medicine" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 25%;">Medicine</th>
                                            <th style="width: 10%;">Dosage</th>
                                            <th style="width: 10%;">Frequency</th>
                                            <th style="width: 10%;">Duration</th>
                                            <th class="text-center" style="width: 25%;">Timings</th>
                                            <th style="width: 10%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicine-list">
                                        @if (Model.Medicines != null && Model.Medicines.Any())
                                        {
                                            for (int i = 0; i < Model.Medicines.Count; i++)
                                            {
                                                <tr class="medicine-item">
                                                    <!-- Medicine -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                               class="form-control form-control-sm medicine-autocomplete"
                                                               name="Medicines[@i].VchMedicineName"
                                                               value="@Model.Medicines[i].VchMedicineName"
                                                               placeholder="Search Medicine" autocomplete="off" />
                                                        <input type="hidden"
                                                               name="Medicines[@i].VchMedicineCode"
                                                               class="medicine-code"
                                                               value="@Model.Medicines[i].VchMedicineCode" />
                                                        <div class="list-group position-absolute w-100 medicine-suggestions"
                                                             style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Dosage -->
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchDosage"
                                                               value="@Model.Medicines[i].VchDosage"
                                                               placeholder="Dosage" />
                                                    </td>

                                                    <!-- Frequency -->
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchFrequency"
                                                               value="@Model.Medicines[i].VchFrequency"
                                                               placeholder="Frequency" />
                                                    </td>

                                                    <!-- Duration -->
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="Medicines[@i].VchDuration"
                                                               value="@Model.Medicines[i].VchDuration"
                                                               placeholder="Duration" />
                                                    </td>

                                                    <!-- Timings -->
                                                    <td>
                                                        <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                            <!-- Breakfast -->
                                                                <label>
                                                                    <input type="radio" class="form-check-input"
                                                                           name="Medicines[@i].BreakfastTiming" value="BBF"
                                                                           @(Model.Medicines[i].BitBbf == true ? "checked" : "") /> BBF
                                                                </label>
                                                                <label>
                                                                    <input type="radio" class="form-check-input scale-radio"
                                                                           name="Medicines[@i].BreakfastTiming" value="ABF"
                                                                           @(Model.Medicines[i].BitAbf == true ? "checked" : "") /> ABF
                                                                </label>

                                                            <!-- Lunch -->
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="BL"
                                                                       @(Model.Medicines[i].BitBl == true ? "checked" : "") /> BL
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].LunchTiming" value="AL"
                                                                       @(Model.Medicines[i].BitAl == true ? "checked" : "") /> AL
                                                            </label>

                                                            <!-- Dinner -->
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="BD"
                                                                       @(Model.Medicines[i].BitBd == true ? "checked" : "") /> BD
                                                            </label>
                                                            <label>
                                                                <input type="radio" class="form-check-input scale-radio"
                                                                       name="Medicines[@i].DinnerTiming" value="AD"
                                                                       @(Model.Medicines[i].BitAd == true ? "checked" : "") /> AD
                                                            </label>
                                                        </div>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="medicine-item">
                                                <!-- Medicine -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                           class="form-control form-control-sm medicine-autocomplete"
                                                           name="Medicines[0].VchMedicineName"
                                                           placeholder="Search Medicine" autocomplete="off">
                                                    <input type="hidden"
                                                           name="Medicines[0].VchMedicineCode"
                                                           class="medicine-code">
                                                    <div class="list-group position-absolute w-100 medicine-suggestions"
                                                         style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Dosage -->
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchDosage" placeholder="Dosage">
                                                </td>

                                                <!-- Frequency -->
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchFrequency" placeholder="Frequency">
                                                </td>

                                                <!-- Duration -->
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           name="Medicines[0].VchDuration" placeholder="Duration">
                                                </td>

                                                <!-- Timings -->
                                                <td>
                                                    <div class="d-flex flex-wrap justify-content-center gap-2 small">
                                                        <!-- Breakfast -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="BBF"> BBF
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].BreakfastTiming" value="ABF"> ABF
                                                        </label>
                                                        <!-- Lunch -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="BL"> BL
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].LunchTiming" value="AL"> AL
                                                        </label>
                                                        <!-- Dinner -->
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="BD"> BD
                                                        </label>
                                                        <label>
                                                            <input type="radio" class="form-check-input scale-radio"
                                                                   name="Medicines[0].DinnerTiming" value="AD"> AD
                                                        </label>
                                                    </div>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-medicine">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-medicine-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <!-- Note -->
                                <div class="form-text mt-1" style="font-size: 0.7rem;color:orangered">
                                    <b style="color:red">NOTE:</b> BBF = Before Breakfast, ABF = After Breakfast, BL = Before Lunch,
                                    AL = After Lunch, BD = Before Dinner, AD = After Dinner
                                </div>
                            </div>

                          
                        </div>

                        <!-- Lab -->
                        <div class="tab-pane fade" id="lab" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Lab Test</th>
                                            <th style="width: 30%;">Priority</th>                                            
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lab-list">
                                     @if (Model.Labs != null && Model.Labs.Any())
                                        {
                                            for (int i = 0; i < Model.Labs.Count; i++)
                                            {
                                                <tr class="lab-item">
                                                    <!-- Lab Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm lab-autocomplete"
                                                        name="Labs[@i].VchTestName"
                                                        placeholder="Search Lab Test"
                                                        autocomplete="off"
                                                        value="@Model.Labs[i].VchTestName">
                                                        <input type="hidden"
                                                        name="Labs[@i].VchTestCode"
                                                        class="lab-code"
                                                        value="@Model.Labs[i].VchTestCode">
                                                        <div class="list-group position-absolute w-100 lab-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Labs[@i].VchPriority">
                                                            <option value="">-- Priority --</option>
                                                            <option value="Normal" selected="@(Model.Labs[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Labs[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="lab-item">
                                                <!-- Lab Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm lab-autocomplete"
                                                    name="Labs[0].VchTestName"
                                                    placeholder="Search Lab Test" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Labs[0].VchTestCode"
                                                    class="lab-code">
                                                    <div class="list-group position-absolute w-100 lab-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Labs[0].VchPriority">
                                                        <option value="">-- Priority --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>
                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-lab">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-lab-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                       
                        <!-- Radiology -->
                        <div class="tab-pane fade" id="radiology" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Radiology Test</th>
                                            <th style="width: 30%;">Priority</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="radio-list">
                                          @if (Model.Radiology != null && Model.Radiology.Any())
                                        {
                                            for (int i = 0; i < Model.Radiology.Count; i++)
                                            {
                                                <tr class="radio-item">
                                                    <!-- Radiology Test -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm radio-autocomplete"
                                                        name="Radiology[@i].VchRadiologyName"
                                                        placeholder="Search Radiology Test"
                                                        autocomplete="off"
                                                        value="@Model.Radiology[i].VchRadiologyName">
                                                        <input type="hidden"
                                                        name="Radiology[@i].VchRadiologyCode"
                                                        class="radio-code"
                                                        value="@Model.Radiology[i].VchRadiologyCode">
                                                        <div class="list-group position-absolute w-100 radio-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Radiology[@i].VchPriority">
                                                            <option value="">-- Select --</option>
                                                            
                                                            <option value="Normal" selected="@(Model.Radiology[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Radiology[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="radio-item">
                                                <!-- Radiology Test -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm radio-autocomplete"
                                                    name="Radiology[0].VchRadiologyName"
                                                    placeholder="Search Radiology Test" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Radiology[0].VchRadiologyCode"
                                                    class="radio-code">
                                                    <div class="list-group position-absolute w-100 radio-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Radiology[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-radio">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-radio-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!--Procedure-->
                        <div class="tab-pane fade" id="procedure" role="tabpanel">
                            <div class="card p-3 border-top border-primary shadow rounded-3 mb-4">
                                <table class="table table-bordered table-sm align-middle mb-0">
                                    <thead class="table bg-primary text-left small">
                                        <tr>
                                            <th style="width: 50%;">Procedure</th>
                                            <th style="width: 30%;">Priority</th>                                          
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="procedure-list">
                                         @if (Model.Procedures != null && Model.Procedures.Any())
                                        {
                                            for (int i = 0; i < Model.Procedures.Count; i++)
                                            {
                                                <tr class="procedure-item">
                                                    <!-- Procedure Name -->
                                                    <td class="position-relative">
                                                        <input type="text"
                                                        class="form-control form-control-sm procedure-autocomplete"
                                                        name="Procedures[@i].VchProcedureName"
                                                        placeholder="Search Procedure"
                                                        autocomplete="off"
                                                        value="@Model.Procedures[i].VchProcedureName">
                                                        <input type="hidden"
                                                        name="Procedures[@i].VchProcedureCode"
                                                        class="procedure-code"
                                                        value="@Model.Procedures[i].VchProcedureCode">
                                                        <div class="list-group position-absolute w-100 procedure-suggestions"
                                                        style="z-index:999; display:none;"></div>
                                                    </td>

                                                    <!-- Priority -->
                                                    <td>
                                                        <select class="form-select form-select-sm" name="Procedures[@i].VchPriority">
                                                            <option value="">-- Select --</option>                                                            
                                                            <option value="Normal" selected="@(Model.Procedures[i].VchPriority == "Normal" ? "selected" : null)">Normal</option>
                                                            <option value="Urgent" selected="@(Model.Procedures[i].VchPriority == "Urgent" ? "selected" : null)">Urgent</option>
                                                        </select>
                                                    </td>                                          

                                                    <!-- Action -->
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                            <i class="bi bi-x-lg text-white"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr class="procedure-item">
                                                <!-- Procedure Name -->
                                                <td class="position-relative">
                                                    <input type="text"
                                                    class="form-control form-control-sm procedure-autocomplete"
                                                    name="Procedures[0].VchProcedureName"
                                                    placeholder="Search Procedure" autocomplete="off">
                                                    <input type="hidden"
                                                    name="Procedures[0].VchProcedureCode"
                                                    class="procedure-code">
                                                    <div class="list-group position-absolute w-100 procedure-suggestions"
                                                    style="z-index:999; display:none;"></div>
                                                </td>

                                                <!-- Priority -->
                                                <td>
                                                    <select class="form-select form-select-sm" name="Procedures[0].VchPriority">
                                                        <option value="">-- Select --</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </td>                                          

                                                <!-- Action -->
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm remove-procedure">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm add-procedure-row">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Follow Up -->
                        <div class="tab-pane fade" id="followup" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Follow-up Date</label>
                                        <input asp-for="DoctorAssessment.DtFollowUpDate" value="@(Model.DoctorAssessment.DtFollowUpDate.HasValue
                                    ? Model.DoctorAssessment.DtFollowUpDate.Value.ToString("yyyy-MM-dd"):"")" class="form-control" type="date" />
                                        <span asp-validation-for="DoctorAssessment.DtFollowUpDate" class="text-danger"></span>
                                    </div>
                                   @* value="@Model.DoctorAssessment.DtFollowUpDate" *@
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Follow-up Time</label>
                                        <input asp-for="DoctorAssessment.FollowUpTime" value="@(Model.DoctorAssessment.FollowUpTime.HasValue
                                ? Model.DoctorAssessment.FollowUpTime.Value.ToString(@"hh\:mm"): "")" type="time" class="form-control" />
                                <span asp-validation-for="DoctorAssessment.FollowUpTime" class="text-danger"></span>
                                </div>
                            </div>
                        </div>  
                        </div>  

                        <!--File upload supporting document-->
                        <div class="tab-pane fade" id="files" role="tabpanel">
                            <div class="card p-4 border-top border-primary shadow rounded-3 mb-4 bg-light">
                                <label class="form-label fw-bold fs-5 text-primary mb-3">
                                    <i class="fas fa-paperclip me-2"></i>Upload Supporting Documents
                                </label>

                                <!-- Drop Zone -->
                                <div id="doctor-drop-zone"
                                     class="border border-3 border-dashed border-info p-5 text-center bg-light rounded-4 shadow-sm"
                                     style="cursor: pointer; transition: all 0.2s ease-in-out;">
                                    <p class="mb-3 text-info"><i class="fas fa-cloud-upload-alt fa-4x"></i></p>
                                    <p class="mb-1 fw-bold text-info fs-5">Drag & drop your files here</p>
                                    <p class="small text-info mb-0">or click to browse</p>

                                    <!-- Hidden file input -->
                                    <input type="file"
                                           name="doctorDocs"
                                           id="doctorDocsInput"
                                           class="form-control d-none"
                                           accept=".jpg,.jpeg,.png,.pdf"
                                           multiple />
                                </div>

                                <!-- Info -->
                                <div class="mt-3 text-muted text-center text-white-50" style="font-size: 0.875rem;">
                                    Supported file types: JPG, PNG, PDF. Maximum: 5 documents.
                                </div>

                                <!-- Preview File List -->
                                <div id="doctor-file-list" class="mt-4">
                                    @* Edit mode: show already uploaded files *@
                                    @if (Model.Documents != null && Model.Documents.Any())
                                    {
                                        <ul class="list-group list-group-flush">
                                            @foreach (var file in Model.Documents)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <a href="@Url.Content("~/Uploads/DoctorDocs/" + file.VchFileName)" target="_blank">
                                                        @file.VchFileName
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-danger remove-existing-file" data-file-id="@file.IntId">
                                                        <i class="bi bi-x-lg text-white"></i>
                                                    </button>
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>
                        </div>                       
                    </div>
                    
                </form>
            </div>
        </div>
     </div>
</main>

@section scripts{
    <script src="/assets/js/dashboard1.js"></script>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        //Validations for second tab clinical
        $(document).ready(function () {
            $("form").on("submit", function (e) {
                let isValid = true;

                // Clear previous messages
                $(".validation-msg").text("");

                // Check required textareas
                $(".required-field").each(function () {
                    if ($(this).val().trim() === "") {
                        isValid = false;
                        $(this).siblings(".validation-msg").text("This field is required.");
                    }
                });

                if (!isValid) {
                    e.preventDefault(); // stop form submission
                    alert("⚠️ Please fill all required fields.");
                }
            });
        });    

         //Medicine searching / adding
         $(document).ready(function () {
             let medIndex = 1; // start from 1 since 0 already exists

             // Function to generate new row
             function getNewRow(index) {
                         return `
             <tr class="medicine-item">
                 <!-- Medicine -->
                 <td class="position-relative">
                     <input type="text"
                            class="form-control form-control-sm medicine-autocomplete"
                            name="Medicines[${index}].VchMedicineName"
                            placeholder="Search Medicine" autocomplete="off">
                     <input type="hidden"
                            name="Medicines[${index}].VchMedicineCode"
                            class="medicine-code">
                     <div class="list-group position-absolute w-100 medicine-suggestions"
                          style="z-index:999; display:none;"></div>
                 </td>

                 <!-- Dosage -->
                 <td>
                     <input type="text" class="form-control form-control-sm"
                            name="Medicines[${index}].VchDosage" placeholder="Dosage">
                 </td>

                 <!-- Frequency -->
                 <td>
                     <input type="text" class="form-control form-control-sm"
                            name="Medicines[${index}].VchFrequency" placeholder="Frequency">
                 </td>

                 <!-- Duration -->
                 <td>
                     <input type="text" class="form-control form-control-sm"
                            name="Medicines[${index}].VchDuration" placeholder="Duration">
                 </td>

                 <!-- Timings -->
                 <td>
                     <div class="d-flex flex-wrap justify-content-center gap-2 small">
                         <!-- Breakfast -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].BreakfastTiming" value="BBF"> BBF
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].BreakfastTiming" value="ABF"> ABF
                         </label>
                         <!-- Lunch -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].LunchTiming" value="BL"> BL
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].LunchTiming" value="AL"> AL
                         </label>
                         <!-- Dinner -->
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].DinnerTiming" value="BD"> BD
                         </label>
                         <label>
                             <input type="radio" class="form-check-input scale-radio"
                                    name="Medicines[${index}].DinnerTiming" value="AD"> AD
                         </label>
                     </div>
                 </td>

                 <!-- Action -->
                 <td class="text-center">
                     <button type="button" class="btn btn-danger btn-sm remove-medicine">
                         <i class="bi bi-x-lg text-white"></i>
                     </button>
                     <button type="button" class="btn btn-success btn-sm add-medicine-row">
                         <i class="bi bi-plus-lg"></i>
                     </button>
                 </td>
             </tr>`;
             }

             // Global add button
             $("#addMedicine").click(function () {
                 $("#medicine-list").append(getNewRow(medIndex));
                 reIndexMedicineRows();
             });
             // Add row beside
             $(document).on("click", ".add-medicine-row", function () {
                 $(this).closest(".medicine-item").after(getNewRow(medIndex));
                 reIndexMedicineRows();
             });
             // Remove row
             $(document).on("click", ".remove-medicine", function () {
                  if ($(".medicine-item").length > 1) {
                 $(this).closest(".medicine-item").remove();
                 reIndexMedicineRows();
                 }
             });
             //renumbering of row after deletion and addations
            function reIndexMedicineRows() {
             $("#medicine-list tr.medicine-item").each(function (i, row) {
                 $(row).find("input").each(function () {
                     let name = $(this).attr("name");
                     if (name) {
                         let newName = name.replace(/\[\d+\]/, `[${i}]`);
                         $(this).attr("name", newName);
                     }
                 });
             });
             medIndex = $("#medicine-list tr.medicine-item").length; // reset counter
         }

             // Autocomplete search medicine (same as before, with keyboard support)
             $(document).on("keyup", ".medicine-autocomplete", function (e) {
             let input = $(this);
             let query = input.val().trim();
             let suggestionBox = input.siblings(".medicine-suggestions");
             let hidden = input.siblings(".medicine-code");

             // Reset hidden only if typing (not Enter/Arrow keys)
             if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                 hidden.val("");
             }

             if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

             if (query.length >= 1) {
                 $.ajax({
                     url: "/Assessment/SearchMedicine",
                     type: "GET",
                     data: { term: query },
                     success: function (data) {
                         suggestionBox.empty();
                         if (data.length > 0) {
                             data.forEach(item => {
                                 suggestionBox.append(
                                     `<a href="#" class="list-group-item list-group-item-action"
                                         data-name="${item.descript}"
                                         data-code="${item.icode}">
                                         ${item.descript} <small class="text-muted">(${item.icode})</small>
                                     </a>`
                                 );
                             });
                             suggestionBox.show();
                         } else {
                             suggestionBox.hide();
                         }
                     }
                 });
             } else {
                 suggestionBox.hide();
             }
         });

             // Keyboard navigation
             $(document).on("keydown", ".medicine-autocomplete", function (e) {
             let $input = $(this);
             let $box = $input.siblings(".medicine-suggestions");
             let $items = $box.find(".list-group-item-action");
             let $active = $items.filter(".active");

             if (e.key === "ArrowDown") {
                 e.preventDefault();
                 if ($active.length === 0) $items.first().addClass("active");
                 else {
                     let $next = $active.removeClass("active").next();
                     ($next.length ? $next : $items.first()).addClass("active");
                 }
             }
             else if (e.key === "ArrowUp") {
                 e.preventDefault();
                 if ($active.length === 0) $items.last().addClass("active");
                 else {
                     let $prev = $active.removeClass("active").prev();
                     ($prev.length ? $prev : $items.last()).addClass("active");
                 }
             }
             else if (e.key === "Enter") {
                 e.preventDefault(); // stop form submit
                 e.stopPropagation();

                 if ($active.length) {
                     // ✅ Directly set the text + hidden field
                     let name = $active.data("name");
                     let code = $active.data("code");

                     $input.val(name);
                     $input.siblings(".medicine-code").val(code);

                     $box.hide();
                 }
             }
         });
             // Select medicine
             $(document).on("click", ".medicine-suggestions a", function (e) {
                 e.preventDefault();
                 let name = $(this).data("name");
                 let code = $(this).data("code");

                 let $container = $(this).closest(".position-relative");
                 let $input = $container.find(".medicine-autocomplete");
                 let $hidden = $container.find(".medicine-code");

                 // Prevent duplicate
                 let isDuplicate = false;
                 $(".medicine-autocomplete").each(function () {
                     let n = $(this).val();
                     let c = $(this).closest(".position-relative").find(".medicine-code").val();
                     if (n === name || c === code) {
                         isDuplicate = true;
                         return false;
                     }
                 });

                 if (isDuplicate) {
                     alert("⚠️ This medicine is already selected.");
                     return;
                 }

                 $input.val(name);
                 $hidden.val(code);
                 $(this).closest(".medicine-suggestions").hide();
             });

             // Hide suggestions if click outside
             $(document).click(function (e) {
                 if (!$(e.target).closest(".medicine-autocomplete, .medicine-suggestions").length) {
                     $(".medicine-suggestions").hide();
                 }
             });
         });

         //for medicine check boxes select unselect
         $(document).on("click", "input[type=radio]", function () {
             let $radio = $(this);

             // If already checked, uncheck it
             if ($radio.data("waschecked") === true) {
                 $radio.prop("checked", false);
                 $radio.data("waschecked", false);
             } else {
                 // Unset all in group, set this one
                 $("input[name='" + $radio.attr("name") + "']").data("waschecked", false);
                 $radio.data("waschecked", true);
             }
         });

        //Code for Lab
         $(document).ready(function () {
                let labIndex = 1; // start from 1 since [0] already exists

                // Generate new Lab row
                function getNewLabRow(index) {
                    return `
                        <tr class="lab-item">
            <td class="position-relative">
                <input type="text"
                       class="form-control form-control-sm lab-autocomplete"
                       name="Labs[${index}].VchTestName"
                       placeholder="Search Lab Test" autocomplete="off">
                <input type="hidden"
                       name="Labs[${index}].VchTestCode"
                       class="lab-code">
                <div class="list-group position-absolute w-100 lab-suggestions"
                     style="z-index:999; display:none;"></div>
            </td>
            <td>
                <select class="form-select form-select-sm"
                        name="Labs[${index}].VchPriority">
                    <option value="">-- Select --</option>
                    <option value="Normal">Normal</option>
                    <option value="Urgent">Urgent</option>
                </select>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm remove-lab">
                    <i class="bi bi-x-lg text-white"></i>
                </button>
                <button type="button" class="btn btn-success btn-sm add-lab-row">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </td>
        </tr>`;
                }

                // Add row beside
                $(document).on("click", ".add-lab-row", function () {
                    $(this).closest(".lab-item").after(getNewLabRow(labIndex));
                    reIndexLabRows();
                });

                // Remove row
                $(document).on("click", ".remove-lab", function () {
                    if ($(".lab-item").length > 1) {
                        $(this).closest(".lab-item").remove();
                        reIndexLabRows();
                    }
                });

                // Re-index rows
                function reIndexLabRows() {
                    $("#lab-list tr.lab-item").each(function (i, row) {
                        $(row).find("input, select").each(function () {
                            let name = $(this).attr("name");
                            if (name) {
                                $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                            }
                        });
                    });
                    labIndex = $("#lab-list tr.lab-item").length;
                }

                // Prevent duplicates
                function isLabDuplicate(code, name, currentRow) {
                    let duplicate = false;
                    $("#lab-list tr.lab-item").not(currentRow).each(function () {
                        let lCode = $(this).find(".lab-code").val();
                        let lName = $(this).find(".lab-autocomplete").val();
                        if (lCode === code || lName === name) {
                            duplicate = true;
                            return false;
                        }
                    });
                    return duplicate;
                }

                // Autocomplete (search Lab tests)
                $(document).on("keyup", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let query = $input.val().trim();
                    let $box = $input.siblings(".lab-suggestions");
                    let $hidden = $input.siblings(".lab-code");

                    if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");
                    if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                    if (query.length >= 1) {
                        $.ajax({
                            url: "/Assessment/SearchLab",
                            type: "GET",
                            data: { term: query },
                            success: function (data) {
                                $box.empty();
                                if (data.length > 0) {
                                    data.forEach(item => {
                                        $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                     data-name="${item.descript}" data-code="${item.tcode}">
                                                     ${item.descript} <small class="text-muted">(${item.tcode})</small>
                                                     </a>`);
                                    });
                                    $box.show();
                                } else $box.hide();
                            }
                        });
                    } else $box.hide();
                });

                // Keyboard navigation
                $(document).on("keydown", ".lab-autocomplete", function (e) {
                    let $input = $(this);
                    let $items = $input.siblings(".lab-suggestions").find(".list-group-item-action");
                    let $active = $items.filter(".active");

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        if ($active.length === 0) $items.first().addClass("active");
                        else { $active.removeClass("active").next().addClass("active"); }
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        if ($active.length === 0) $items.last().addClass("active");
                        else { $active.removeClass("active").prev().addClass("active"); }
                    } else if (e.key === "Enter") {
                        if ($active.length) {
                            e.preventDefault();
                            let name = $active.data("name");
                            let code = $active.data("code");
                            let $row = $input.closest("tr");

                            if (isLabDuplicate(code, name, $row)) {
                                alert("⚠️ This lab test is already selected!");
                                return;
                            }

                            $input.val(name);
                            $input.siblings(".lab-code").val(code);
                            $input.siblings(".lab-suggestions").hide();
                        }
                    }
                });

                // Select from mouse click
                $(document).on("click", ".lab-suggestions a", function (e) {
                    e.preventDefault();
                    let $input = $(this).closest(".position-relative").find(".lab-autocomplete");
                    let name = $(this).data("name");
                    let code = $(this).data("code");
                    let $row = $input.closest("tr");

                    if (isLabDuplicate(code, name, $row)) {
                        alert("⚠️ This lab test is already selected!");
                        return;
                    }

                    $input.val(name);
                    $input.siblings(".lab-code").val(code);
                    $(this).parent().hide();
                });

                // Hide suggestions on outside click
                $(document).click(function (e) {
                    if (!$(e.target).closest(".lab-autocomplete, .lab-suggestions").length) {
                        $(".lab-suggestions").hide();
                    }
                });

                // On blur clear invalid text
                $(document).on("blur", ".lab-autocomplete", function () {
                    let $input = $(this);
                    let $hidden = $input.siblings(".lab-code");
                    if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
                });

                // Remove empty Lab rows before submit
                $("form").on("submit", function () {
                    $("#lab-list tr.lab-item").filter(function () {
                        let code = $(this).find(".lab-code").val();
                        return !code || code.trim() === "";
                    }).remove();
                    reIndexLabRows();
                });
            });

        //Radiology code
        $(document).ready(function () {
            let radioIndex = 1; // start from 1 since 0 already exists

            function getNewRadioRow(index) {
                return `
                <tr class="radio-item">
                    <td class="position-relative">
                        <input type="text"
                               class="form-control form-control-sm radio-autocomplete"
                               name="Radiology[${index}].VchRadiologyName"
                               placeholder="Search Radiology Test" autocomplete="off">
                        <input type="hidden"
                               name="Radiology[${index}].VchRadiologyCode"
                               class="radio-code">
                        <div class="list-group position-absolute w-100 radio-suggestions"
                             style="z-index:999; display:none;"></div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm"
                                name="Radiology[${index}].VchPriority">
                            <option value="">-- Select --</option>
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm remove-radio">
                            <i class="bi bi-x-lg text-white"></i>
                        </button>
                        <button type="button" class="btn btn-success btn-sm add-radio-row">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </td>
                </tr>`;
            }

            $(document).on("click", ".add-radio-row", function () {
                $(this).closest(".radio-item").after(getNewRadioRow(radioIndex));
                reIndexRadioRows();
            });

            $(document).on("click", ".remove-radio", function () {
                if ($(".radio-item").length > 1) {
                    $(this).closest(".radio-item").remove();
                    reIndexRadioRows();
                }
            });

            function reIndexRadioRows() {
                $("#radio-list tr.radio-item").each(function (i, row) {
                    $(row).find("input, select").each(function () {
                        let name = $(this).attr("name");
                        if (name) {
                            $(this).attr("name", name.replace(/\[\d+\]/, `[${i}]`));
                        }
                    });
                });
                radioIndex = $("#radio-list tr.radio-item").length;
            }

            function isRadiologyDuplicate(code, name, currentRow) {
                let duplicate = false;
                $("#radio-list tr.radio-item").not(currentRow).each(function () {
                    let rCode = $(this).find(".radio-code").val();
                    let rName = $(this).find(".radio-autocomplete").val();
                    if (rCode === code || rName === name) {
                        duplicate = true;
                        return false;
                    }
                });
                return duplicate;
            }

            $(document).on("keyup", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let query = $input.val().trim();
                let $box = $input.siblings(".radio-suggestions");
                let $hidden = $input.siblings(".radio-code");

                if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) $hidden.val("");

                if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                if (query.length >= 1) {
                    $.ajax({
                        url: "/Assessment/SearchRadiology",
                        type: "GET",
                        data: { term: query, type: "Radio" },
                        success: function (data) {
                            $box.empty();
                            if (data.length > 0) {
                                data.forEach(item => {
                                    $box.append(`<a href="#" class="list-group-item list-group-item-action"
                                                 data-name="${item.service}" data-code="${item.scode}">
                                                 ${item.service} <small class="text-muted">(${item.scode})</small>
                                                 </a>`);
                                });
                                $box.show();
                            } else $box.hide();
                        }
                    });
                } else $box.hide();
            });

            $(document).on("keydown", ".radio-autocomplete", function (e) {
                let $input = $(this);
                let $items = $input.siblings(".radio-suggestions").find(".list-group-item-action");
                let $active = $items.filter(".active");

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if ($active.length === 0) $items.first().addClass("active");
                    else { $active.removeClass("active").next().addClass("active"); }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if ($active.length === 0) $items.last().addClass("active");
                    else { $active.removeClass("active").prev().addClass("active"); }
                } else if (e.key === "Enter") {
                    if ($active.length) {
                        e.preventDefault();
                        let name = $active.data("name");
                        let code = $active.data("code");
                        let $row = $input.closest("tr");

                        if (isRadiologyDuplicate(code, name, $row)) {
                            alert("⚠️ This radiology is already selected!");
                            return;
                        }

                        $input.val(name);
                        $input.siblings(".radio-code").val(code);
                        $input.siblings(".radio-suggestions").hide();
                    }
                }
            });

            $(document).on("click", ".radio-suggestions a", function (e) {
                e.preventDefault();
                let $input = $(this).closest(".position-relative").find(".radio-autocomplete");
                let name = $(this).data("name");
                let code = $(this).data("code");
                let $row = $input.closest("tr");

                if (isRadiologyDuplicate(code, name, $row)) {
                    alert("⚠️ This radiology is already selected!");
                    return;
                }

                $input.val(name);
                $input.siblings(".radio-code").val(code);
                $(this).parent().hide();
            });

            $(document).click(function (e) {
                if (!$(e.target).closest(".radio-autocomplete, .radio-suggestions").length) {
                    $(".radio-suggestions").hide();
                }
            });

            $(document).on("blur", ".radio-autocomplete", function () {
                let $input = $(this);
                let $hidden = $input.siblings(".radio-code");
                if ($input.val().trim() !== "" && !$hidden.val()) $input.val("");
            });
                
            if (!isValid) {
                e.preventDefault(); // stop form submission
                return;
        }

          //Remove empty rows before submit (to set count 0 on post if empty)
           $("form").on("submit", function () {
            // Remove empty radiology rows
            $("#radio-list tr.radio-item").filter(function () {
                let code = $(this).find(".radio-code").val();
                return !code || code.trim() === "";
              }).remove();

            // Reindex remaining rows
               reIndexRadioRows();
           });
    });

        //Procedure
        $(document).ready(function () {
             let procIndex = 1; // start from 1 since [0] already exists

             // Function to generate new Procedure row
             function getNewProcedureRow(index) {
                 return `
                 <tr class="procedure-item">
                     <!-- Procedure -->
                     <td class="position-relative">
                         <input type="text"
                                class="form-control form-control-sm procedure-autocomplete"
                                name="Procedures[${index}].VchProcedureName"
                                placeholder="Search Procedure" autocomplete="off">
                         <input type="hidden"
                                name="Procedures[${index}].VchProcedureCode"
                                class="procedure-code">
                         <div class="list-group position-absolute w-100 procedure-suggestions"
                              style="z-index:999; display:none;"></div>
                     </td>

                     <!-- Priority -->
                     <td>
                         <select class="form-select form-select-sm" name="Procedures[${index}].VchPriority">
                             <option value="">-- Select --</option>
                             <option value="Normal">Normal</option>
                             <option value="Urgent">Urgent</option>
                         </select>
                     </td>
                     <!-- Action -->
                     <td class="text-center">
                         <button type="button" class="btn btn-danger btn-sm remove-procedure">
                             <i class="bi bi-x-lg text-white"></i>
                         </button>
                         <button type="button" class="btn btn-success btn-sm add-procedure-row">
                             <i class="bi bi-plus-lg"></i>
                         </button>
                     </td>
                 </tr>`;
             }

             // Add row beside
             $(document).on("click", ".add-procedure-row", function () {
                 $(this).closest(".procedure-item").after(getNewProcedureRow(procIndex));
                 reIndexProcedureRows();
             });

             // Remove row (keep at least 1 row)
             $(document).on("click", ".remove-procedure", function () {
                 if ($(".procedure-item").length > 1) {
                     $(this).closest(".procedure-item").remove();
                     reIndexProcedureRows();
                 }
             });

             // Re-index rows after add/remove
             function reIndexProcedureRows() {
                 $("#procedure-list tr.procedure-item").each(function (i, row) {
                     $(row).find("input, select").each(function () {
                         let name = $(this).attr("name");
                         if (name) {
                             let newName = name.replace(/\[\d+\]/, `[${i}]`);
                             $(this).attr("name", newName);
                         }
                     });
                 });
                 procIndex = $("#procedure-list tr.procedure-item").length;
             }

             // Autocomplete Procedure search
             $(document).on("keyup", ".procedure-autocomplete", function (e) {
                 let input = $(this);
                 let query = input.val().trim();
                 let suggestionBox = input.siblings(".procedure-suggestions");
                 let hidden = input.siblings(".procedure-code");

                 if (!["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
                     hidden.val(""); // reset hidden if typing
                 }

                 if (["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) return;

                 if (query.length >= 1) {
                     $.ajax({
                         url: "/Assessment/SearchRadiology", // 🔹 your controller method
                         type: "GET",
                         data: { term: query, type:"Procedure" },
                         success: function (data) {
                             suggestionBox.empty();
                             if (data.length > 0) {
                                 data.forEach(item => {
                                     suggestionBox.append(
                                         `<a href="#" class="list-group-item list-group-item-action"
                                             data-name="${item.service}"
                                             data-code="${item.scode}">
                                             ${item.service} <small class="text-muted">(${item.scode})</small>
                                         </a>`
                                     );
                                 });
                                 suggestionBox.show();
                             } else {
                                 suggestionBox.hide();
                             }
                         }
                     });
                 } else {
                     suggestionBox.hide();
                 }
             });

             // Keyboard navigation
             $(document).on("keydown", ".procedure-autocomplete", function (e) {
                 let $input = $(this);
                 let $box = $input.siblings(".procedure-suggestions");
                 let $items = $box.find(".list-group-item-action");
                 let $active = $items.filter(".active");

                 if (e.key === "ArrowDown") {
                     e.preventDefault();
                     if ($active.length === 0) $items.first().addClass("active");
                     else {
                         let $next = $active.removeClass("active").next();
                         ($next.length ? $next : $items.first()).addClass("active");
                     }
                 }
                 else if (e.key === "ArrowUp") {
                     e.preventDefault();
                     if ($active.length === 0) $items.last().addClass("active");
                     else {
                         let $prev = $active.removeClass("active").prev();
                         ($prev.length ? $prev : $items.last()).addClass("active");
                     }
                 }
                 else if (e.key === "Enter") {
                     e.preventDefault();
                     e.stopPropagation();

                     if ($active.length) {
                         let name = $active.data("name");
                         let code = $active.data("code");

                         $input.val(name);
                         $input.siblings(".procedure-code").val(code);
                         $box.hide();
                     }
                 }
             });

             // Select from mouse click
             $(document).on("click", ".procedure-suggestions a", function (e) {
                 e.preventDefault();
                 let name = $(this).data("name");
                 let code = $(this).data("code");

                 let $container = $(this).closest(".position-relative");
                 let $input = $container.find(".procedure-autocomplete");
                 let $hidden = $container.find(".procedure-code");

                 // Prevent duplicate
                 let isDuplicate = false;
                 $(".procedure-autocomplete").each(function () {
                     let n = $(this).val();
                     let c = $(this).closest(".position-relative").find(".procedure-code").val();
                     if (n === name || c === code) {
                         isDuplicate = true;
                         return false;
                     }
                 });

                 if (isDuplicate) {
                     alert("⚠️ This procedure is already selected.");
                     return;
                 }

                 $input.val(name);
                 $hidden.val(code);
                 $(this).closest(".procedure-suggestions").hide();
             });

             // Hide suggestions if clicked outside
             $(document).click(function (e) {
                 if (!$(e.target).closest(".procedure-autocomplete, .procedure-suggestions").length) {
                     $(".procedure-suggestions").hide();
                 }
             });
         });


         //For supporting document
         const doctorDropZone = document.getElementById("doctor-drop-zone");
         const doctorFileInput = document.getElementById("doctorDocsInput");
         const doctorFileList = document.getElementById("doctor-file-list");

         doctorDropZone.addEventListener("click", () => doctorFileInput.click());

         doctorDropZone.addEventListener("dragover", (e) => {
             e.preventDefault();
             doctorDropZone.classList.add("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("dragleave", () => {
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
         });

         doctorDropZone.addEventListener("drop", (e) => {
             e.preventDefault();
             doctorDropZone.classList.remove("bg-info", "bg-opacity-10");
             doctorFileInput.files = e.dataTransfer.files;
             displayDoctorFiles();
         });

         doctorFileInput.addEventListener("change", displayDoctorFiles);

         function displayDoctorFiles() {
             doctorFileList.innerHTML = "";
             let files = Array.from(doctorFileInput.files);

             if (files.length > 5) {
                 alert("❌ Maximum 5 files allowed.");
                 doctorFileInput.value = "";
                 return;
             }

             files.forEach((file, index) => {
                 const div = document.createElement("div");
                 div.className = "d-flex align-items-center mb-2 border p-2 rounded bg-light shadow-sm";
                 div.innerHTML = `
                     <i class="fas fa-file-alt text-primary me-2"></i>
                     <span class="text-truncate" style="max-width: 160px;">${file.name}</span>
                     <span class="badge bg-secondary ms-auto">${(file.size / 1024).toFixed(1)} KB</span>
                     <button type="button" class="btn btn-sm btn-outline-danger ms-auto remove-file" data-index="${index}">❌</button>
                 `;
                 doctorFileList.appendChild(div);
             });
         }

         doctorFileList.addEventListener("click", function(e){
             if(e.target.classList.contains("remove-file")){
                 const idx = e.target.getAttribute("data-index");
                 const dt = new DataTransfer();
                 Array.from(doctorFileInput.files).forEach((file, i) => {
                     if(i != idx) dt.items.add(file);
                 });
                 doctorFileInput.files = dt.files;
                 displayDoctorFiles();
             }
         });
    </script>
}
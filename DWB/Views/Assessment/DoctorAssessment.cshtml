@model List<DWB.APIModel.SP_OPD>
@{
    ViewData["Title"] = "Nursing Assessment";   
}
<style>
   
</style>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
@* for date range *@
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<main class="main-wrapper">
    <div class="main-content">
        <div class="row cols-12">
            <div class="col">
                <h4 class="mb-4">Consultant Assessment - Today's Patients</h4>
                <hr />
                <div class="card">
                    <div class="card-body">
                        @if (TempData["Success"] != null)
                        {
                            <br />
                            <div class="alert alert-success border-0 bg-success alert-dismissible fade show">
                                <div class="text-white align-content-center">@TempData["Success"]</div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }
                        @if (TempData["Error"] != null)
                        {
                            <br />
                            <div class="alert alert-danger border-0 bg-danger alert-dismissible fade show">
                                <div class="text-white align-content-center">@TempData["Error"]</div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }
                        <form method="get" asp-action="DoctorAssessment" asp-controller="Assessment" class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label for="daterange" class="form-label">Select Date Range</label>
                                <input type="text" id="daterange" name="daterange" class="form-control" autocomplete="off"
                                       value="select date range" />
                            </div>
                            <div class="col-md-3 align-self-end">
                                <button type="submit" class="btn btn-success">Filter</button>
                                <a href="@Url.Action("DoctorAssessment", "Assessment")" class="btn btn-secondary">Clear</a>
                            </div>
                        </form>
                        <table id="nursingTable" class="table form-control table-responsive table-striped table-bordered " style="width:100%;font-size:90%">
                            <thead class="bg-primary" style="font-weight:bolder">
                                <tr>
                                    <th>OPD No</th>
                                    <th>Patient Name</th>
                                    <th>OPD Date</th>
                                    <th>Age/Gender</th>
                                    <th>Visit</th>
                                    <th>Patient Category</th>
                                    <th>Consultant</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in Model)
                                {
                                    <tr>
                                        <td>@p.opdno</td>
                                        <td>@p.pname</td>
                                        <td>@p.dtEntry.ToString("dd/MM/yyyy HH:mm tt")</td>
                                        <td>@p.age/@p.sex</td>
                                        <td>@p.visit</td>
                                        <td>@p.Pcategory</td>
                                        <td>@p.descript</td>
                                        <td>
                                            @if (p.bitTempNSAssComplete == false)
                                            {
                                                @* <a class="btn btn-grd btn-grd-primary btn-sm" href="@Url.Action("NAssessmentCreate", "Assessment", new { uhid = p.opdno, pname = p.pname, visit = p.visit, age = p.age, jdate = p.jdate, timein = p.timein, consultant = p.descript, category = p.Pcategory })">&nbsp;Fill&nbsp;</a> *@
                                                <span class="badge rounded-pill bg-grd-primary" >Initial Pending</span>
                                            }
                                            else if (p.bitTempNSAssComplete == true && p.bitTempDOcAssComplete==false)
                                            {
                                                //give option to fill assessment to consultant
                                                <a class="btn btn-grd btn-grd-primary btn-sm" href="@Url.Action("DoctorAssmntCreate", "Assessment", new { uhid = p.opdno, pname = p.pname, visit = p.visit})">&nbsp;Fill&nbsp;</a>
                                            }
                                            else if(p.bitTempDOcAssComplete==true)
                                            {
                                                <div class="d-inline-flex gap-2">
                                                    <a class="btn btn-grd btn-grd-info btn-sm" onclick="loadCompletedAssessment('@p.opdno','@p.visit','@p.jdate.ToString()')">View</a>
                                                    @{
                                                        DateTime today = DateTime.Now.Date;
                                                        // if (p.dtEntry.Date == today)
                                                        // {
                                                            <a class="btn btn-grd btn-grd-info btn-sm" href="@Url.Action("DocAssmntEdit", "Assessment", new { uhid = @p.opdno, visit = @p.visit, date = @p.jdate.ToString() })"> Edit</a>
                                                       // }
                                                    }
                                                </div>
                                            }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div class="modal fade" id="viewAssessmentModal" tabindex="-1" aria-labelledby="viewAssessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewAssessmentModalLabel">Completed Nursing Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewAssessmentContent">
                <!-- Partial View will be loaded here -->
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editAssessmentModal" tabindex="-1" aria-labelledby="editAssessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editAssessmentModalLabel">Edit Nursing Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editAssessmentContent">
                <!-- Edit View will be loaded here -->
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script src="/assets/js/dashboard1.js"></script>
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    @* for date range *@
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
          $('#nursingTable').DataTable({
                   pageLength: 50,
                   lengthChange: true,
                   ordering: true,
                   language: {
                       searchPlaceholder: "Search patient..."
                   }
               });
          // setInterval(function () {
          //       location.reload();
          //   }, 10000); // 10000ms = 10s

        });
        //date range funtcion
            $(function () {
            $('#daterange').daterangepicker({
                locale: {
                    format: 'DD/MM/YYYY'
                },
                autoUpdateInput: false,
                maxDate: moment() // prevents future date selection
            });
            $('#daterange').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });
            $('#daterange').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
            });
        });
        // //For view assessment
        // function loadCompletedAssessment(uhid, visit, jdate) {
        //     $.ajax({
        //         url: '/Assessment/ViewDocAssessment',
        //         data: { uhid: uhid,
        //         visit:visit,
        //         date:jdate},
        //         type: 'GET',
        //         success: function (response) {
        //         $('#viewAssessmentContent').html(response);
        //         var modal = new bootstrap.Modal(document.getElementById('viewAssessmentModal'));
        //         modal.show();
        //     },
        //     error: function () {
        //         alert('Failed to load completed assessment. Please try again.');
        //     }
        //     });
        // }
        //    function loadCompletedAssessment(uhid, visit, jdate) {
        //     var url = '/Assessment/ViewDocAssessment?uhid=' + uhid + '&visit=' + visit + '&date=' + jdate;

        //     var iframe = '<iframe src="' + url + '" width="100%" height="600px" style="border:none;"></iframe>';
        //     $('#viewAssessmentContent').html(iframe);

        //     var modal = new bootstrap.Modal(document.getElementById('viewAssessmentModal'));
        //     modal.show();
        // }
        //open print in new tab

            function loadCompletedAssessment(uhid, visit, jdate) {
            let url = `/Assessment/ViewDocAssessment?uhid=${uhid}&visit=${visit}&date=${jdate}`;
            window.open(url, '_blank');  // Opens in new browser tab
        }
       
    </script>
}
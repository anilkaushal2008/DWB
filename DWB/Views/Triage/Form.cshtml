@model DWB.Models.TriageViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .patient-card-header {
        background: #fff;
        border-left: 5px solid #0dcaf0;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .patient-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        display: block;
    }

    .patient-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #212529;
    }

    .required-star {
        color: red;
        font-weight: bold;
        margin-left: 3px;
    }
</style>

<main class="main-wrapper py-4">
    <div class="container mt-3">

        <h4 class="fw-semibold mb-4 text-dark">
            @(Model.IsEditMode ? "Edit Pre-Triage Assessment" : "New Pre-Triage Assessment")
        </h4>

        <!-- PATIENT CARD -->
        <div class="patient-card-header">
            <div class="row">
                <div class="col-md-4">
                    <span class="patient-label">Patient Name</span>
                    <span class="patient-value">@Model.PatientName</span>
                </div>
                <div class="col-md-4 border-start">
                    <span class="patient-label">UHID</span>
                    <span class="patient-value">@Model.UhidNo</span>
                </div>
                <div class="col-md-4 border-start">
                    <span class="patient-label">Age / Sex</span>
                    <span class="patient-value">@Model.Age / @Model.Sex</span>
                </div>
            </div>
        </div>

        <!-- FORM START -->
        <form asp-action="@(Model.IsEditMode ? "Update" : "Save")" method="post" id="triageForm" novalidate>

            <!-- Hidden / meta fields -->
            @Html.HiddenFor(m => m.AssessmentId)
            @Html.HiddenFor(m => m.VisitId)
            @Html.HiddenFor(m => m.PatientId)
            @Html.HiddenFor(m => m.PatientName)
            @Html.HiddenFor(m => m.UhidNo)
            @Html.HiddenFor(m => m.Age)
            @Html.HiddenFor(m => m.Sex)
            @Html.HiddenFor(m => m.PhoneNo)
            @Html.HiddenFor(m => m.PatientAddress)
            @Html.HiddenFor(m => m.RoomWardNumber)
            @Html.HiddenFor(m => m.BedNumber)
            @Html.HiddenFor(m => m.BitIsCompleted)
            @Html.HiddenFor(m => m.doccode)
            @Html.HiddenFor(m => m.docname)
            @Html.HiddenFor(m => m.CategoryCode)
            @Html.HiddenFor(m => m.Category)

            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <!-- ARRIVAL / VITALS -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Vitals & Arrival Details</div>
                <div class="card-body">
                    <div class="row g-3">

                        <div class="col-md-3">
                            <label asp-for="ArrivalDateTime" class="form-label">
                                Arrival Date & Time <span class="required-star">*</span>
                            </label>
                            <input asp-for="ArrivalDateTime" type="datetime-local" class="form-control" />
                            <span asp-validation-for="ArrivalDateTime" class="text-danger"></span>
                        </div>
                        <div class="col-md-3">
                            <label asp-for="TimeSeenByProvider" class="form-label">
                                Seen By Provider <span class="required-star">*</span>
                            </label>
                           @*  <input asp-for="TimeSeenByProvider" type="datetime-local" class="form-control" /> *@
                            <input asp-for="TimeSeenByProvider" type="datetime-local" class="form-control" />
                            <span asp-validation-for="TimeSeenByProvider" class="text-danger"></span>
                        </div>
                        <div class="col-md-3">
                            <label asp-for="VitalsTime" class="form-label">
                                Vitals Time <span class="required-star">*</span>
                            </label>
                            <input asp-for="VitalsTime" type="datetime-local" class="form-control" />
                            <span asp-validation-for="VitalsTime" class="text-danger"></span>
                        </div>
                       
                      
                        <div class="col-md-3">
                            <label asp-for="HistoryObtainedFrom" class="form-label">
                                History Obtained From <span class="required-star">*</span>
                            </label>
                            <select asp-for="HistoryObtainedFrom" class="form-select">
                                <option value="">-- Select --</option>
                                <option>Patient</option>
                                <option>Relative</option>
                                <option>Paramedic Staff</option>
                                <option>Doctor / Nurse</option>
                                <option>Bystander / Others</option>
                            </select>
                            <span asp-validation-for="HistoryObtainedFrom" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="TransportationMode" class="form-label">Transportation Mode</label>
                            <select asp-for="TransportationMode" class="form-select" id="TransportationMode">
                                <option value="">-- Select --</option>
                                <option>Private Vehicle</option>
                                <option>Ambulance</option>
                                <option>Other</option>
                            </select>
                            <span asp-validation-for="TransportationMode" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="TransportationOther" class="form-label">If Other</label>
                            <input asp-for="TransportationOther" class="form-control" id="TransportationOther" />
                            <span asp-validation-for="TransportationOther" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="Pulse" class="form-label">
                                Pulse (bpm) <span class="required-star">*</span>
                            </label>
                            <input asp-for="Pulse" class="form-control" />
                            <span asp-validation-for="Pulse" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">
                                BP (Sys/Dia) <span class="required-star">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="BPSystolic" class="form-control" placeholder="120" />
                                <span class="input-group-text">/</span>
                                <input asp-for="BPDiastolic" class="form-control" placeholder="80" />
                            </div>
                            <span asp-validation-for="BPSystolic" class="text-danger"></span>
                            <span asp-validation-for="BPDiastolic" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="RespRate" class="form-label">
                                Resp. Rate <span class="required-star">*</span>
                            </label>
                            <input asp-for="RespRate" class="form-control" />
                            <span asp-validation-for="RespRate" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="Temperature" class="form-label">
                                Temperature (°F) <span class="required-star">*</span>
                            </label>
                            <input asp-for="Temperature" class="form-control" />
                            <span asp-validation-for="Temperature" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="Weight" class="form-label">
                                Weight (kg) <span class="required-star">*</span>
                            </label>
                            <input asp-for="Weight" class="form-control" />
                            <span asp-validation-for="Weight" class="text-danger"></span>
                        </div>

                    </div>
                </div>
            </div>

            <!-- CLINICAL ASSESSMENT -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Clinical Assessment</div>
                <div class="card-body">

                    <label asp-for="ChiefComplaint" class="fw-bold">
                        Chief Complaint <span class="required-star">*</span>
                    </label>
                    <textarea asp-for="ChiefComplaint" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="ChiefComplaint" class="text-danger"></span>

                    <label asp-for="CurrentMedication" class="fw-bold mt-3">Current Medication</label>
                    <textarea asp-for="CurrentMedication" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="CurrentMedication" class="text-danger"></span>

                    <label asp-for="Allergies" class="fw-bold mt-3">Allergies</label>
                    <textarea asp-for="Allergies" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="Allergies" class="text-danger"></span>

                    <label asp-for="SubjectiveNotes" class="fw-bold mt-3">Subjective Notes</label>
                    <textarea asp-for="SubjectiveNotes" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="SubjectiveNotes" class="text-danger"></span>

                    <label asp-for="ObjectiveNotes" class="fw-bold mt-3">Objective Notes</label>
                    <textarea asp-for="ObjectiveNotes" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="ObjectiveNotes" class="text-danger"></span>

                    <label asp-for="InvestigationsOrdered" class="fw-bold mt-3">Investigations Ordered</label>
                    <textarea asp-for="InvestigationsOrdered" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="InvestigationsOrdered" class="text-danger"></span>

                    <label asp-for="Diagnosis" class="fw-bold mt-3">Provisional Diagnosis</label>
                    <textarea asp-for="Diagnosis" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="Diagnosis" class="text-danger"></span>

                    <label asp-for="Plan" class="fw-bold mt-3">Treatment Plan</label>
                    <textarea asp-for="Plan" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Plan" class="text-danger"></span>
                </div>
            </div>

            <!-- TRIAGE -->
            <div class="card mb-3 border-primary shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">Triage Classification</div>
                <div class="card-body">

                    <label class="form-label">
                        Select Triage Category <span class="required-star">*</span>
                    </label>

                    <div class="btn-group w-100" role="group">
                        <input type="radio" asp-for="TriageCategory" class="btn-check" id="tg1" value="Emergent" />
                        <label class="btn btn-outline-danger" for="tg1">EMERGENT</label>

                        <input type="radio" asp-for="TriageCategory" class="btn-check" id="tg2" value="Urgent" />
                        <label class="btn btn-outline-warning text-dark" for="tg2">URGENT</label>

                        <input type="radio" asp-for="TriageCategory" class="btn-check" id="tg3" value="Non-Urgent" />
                        <label class="btn btn-outline-success" for="tg3">NON-URGENT</label>
                    </div>
                    <span asp-validation-for="TriageCategory" class="text-danger"></span>
                </div>
            </div>

            <!-- DISPOSITION -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Disposition</div>
                <div class="card-body">

                    <div class="form-check form-switch mb-3">
                        <input asp-for="IsAdmissionAdvised" class="form-check-input" id="chkAdmit" />
                        <label for="chkAdmit" class="form-check-label fw-bold text-danger">Admission Advised</label>
                    </div>

                    <div id="consultantBox" style="display:none;">
                        <label asp-for="ConsultantDoctorId" class="form-label">
                            Select Consultant <span class="required-star">*</span>
                        </label>
                        <select asp-for="ConsultantDoctorId" asp-items="Model.ConsultantList" class="form-select" id="doctorSelect">
                            <option value="">-- Select Consultant --</option>
                        </select>
                        <span asp-validation-for="ConsultantDoctorId" class="text-danger"></span>

                        <div id="otherDoctorBox" style="display:none;" class="mt-3">
                            <label asp-for="OtherDoctorName" class="form-label">
                                Enter Doctor Name <span class="required-star">*</span>
                            </label>
                            <input asp-for="OtherDoctorName" class="form-control" id="OtherDoctorName" />
                            <span asp-validation-for="OtherDoctorName" class="text-danger"></span>
                        </div>
                    </div>

                    <label asp-for="ConditionUponRelease" class="form-label mt-3">Condition Upon Release</label>
                    <select asp-for="ConditionUponRelease" class="form-select">
                        <option value="">-- Select --</option>
                        <option>Improved</option>
                        <option>Unchanged</option>
                        <option>Deteriorated</option>
                    </select>

                    <label asp-for="AdmissionRefusalReason" class="form-label mt-3">
                        If Patient Refuses Admission
                    </label>
                    <textarea asp-for="AdmissionRefusalReason" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="AdmissionRefusalReason" class="text-danger"></span>
                </div>
            </div>

            <!-- CROSS CONSULT -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Cross Consultation</div>
                <div class="card-body">

                    <div class="form-check form-switch mb-2">
                        <!-- Proper model binding -->
                        <input type="checkbox"
                               class="form-check-input"
                               id="chkCross"
                               name="IsCrossConsultRequired"
                               value="true"
                               @(Model.IsCrossConsultRequired == true ? "checked" : "") />

                        <!-- Hidden false value so MVC binds correctly -->
                        <input type="hidden" name="IsCrossConsultRequired" value="false" />

                        <label class="form-check-label" for="chkCross">
                            Cross Consult Required
                        </label>
                    </div>

                    <!-- Hidden fields box -->
                    <div id="crossConsultBox" style="display:none;">

                        <label asp-for="SpecialistName" class="form-label">
                            Specialist Name <span class="required-star">*</span>
                        </label>
                        <input asp-for="SpecialistName" class="form-control" id="SpecialistName" />
                        <span asp-validation-for="SpecialistName" class="text-danger"></span>

                        <label asp-for="ReferredTo" class="form-label mt-3">
                            Referred To <span class="required-star">*</span>
                        </label>
                        <input asp-for="ReferredTo" class="form-control" id="ReferredTo" />
                        <span asp-validation-for="ReferredTo" class="text-danger"></span>

                    </div>

                </div>
            </div>


            <!-- FOLLOW UP -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Follow Up</div>
                <div class="card-body">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="FollowUpDate" class="form-label">Follow Up Date</label>
                            <input asp-for="FollowUpDate" type="date" class="form-control" id="FollowUpDate" />
                            <span asp-validation-for="FollowUpDate" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="FollowUpTime" class="form-label">Follow Up Time</label>
                            <input asp-for="FollowUpTime" type="time" class="form-control" id="FollowUpTime" />
                            <span asp-validation-for="FollowUpTime" class="text-danger"></span>
                        </div>
                    </div>

                    <label asp-for="PatientInstructions" class="form-label mt-3">Patient Instructions</label>
                    <textarea asp-for="PatientInstructions" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="PatientInstructions" class="text-danger"></span>

                    <label asp-for="Remarks" class="form-label mt-3">Remarks</label>
                    <textarea asp-for="Remarks" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="Remarks" class="text-danger"></span>
                </div>
            </div>

            <!-- SUBMIT BUTTON -->
            <div class="d-grid mb-5">
                <button type="submit" class="btn btn-dark btn-lg">
                    <i class="fas fa-print"></i> Save & Print Assessment
                </button>
            </div>

        </form>
    </div>
</main>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {

            // helper functions for dynamic validation
            function addRequired(selector, message) {
                $(selector).attr("data-val", "true")
                           .attr("data-val-required", message);
            }

            function removeRequired(selector) {
                $(selector).removeAttr("data-val")
                           .removeAttr("data-val-required");
            }

            // 1) Auto-focus first validation error on submit
            $("#triageForm").submit(function () {
                if (!$(this).valid()) {
                    setTimeout(function () {
                        var el = $(".input-validation-error").first();
                        if (el.length) {
                            $('html, body').animate({
                                scrollTop: el.offset().top - 120
                            }, 400);
                            el.focus();
                        }
                    }, 100);
                }
            });

            // 2) Transportation: if Other selected, require TransportationOther
            $('#TransportationMode').change(function () {
                if ($(this).val() === "Other") {
                    addRequired('#TransportationOther', 'Please specify transportation mode.');
                } else {
                    removeRequired('#TransportationOther');
                    $('#TransportationOther').val('');
                }
                $.validator.unobtrusive.parse('#triageForm');
            });

            // ==========================
            // 3) CROSS CONSULTATION LOGIC
            // ==========================

            function toggleCrossConsult() {
                if ($('#chkCross').is(':checked')) {

                    // Show Cross Consult Fields
                    $('#crossConsultBox').show();

                    // Add required attributes
                    addRequired('#SpecialistName', 'Please enter specialist name.');
                    addRequired('#ReferredTo', 'Please enter referred-to department/doctor.');

                } else {

                    // Hide fields
                    $('#crossConsultBox').hide();

                    // Clear values
                    $('#SpecialistName').val('');
                    $('#ReferredTo').val('');

                    // Remove required attributes
                    removeRequired('#SpecialistName');
                    removeRequired('#ReferredTo');
                }

                $.validator.unobtrusive.parse('#triageForm');
            }

            // Checkbox click event
            $('#chkCross').change(toggleCrossConsult);

            // Initialize state on page load
            toggleCrossConsult();

            // 4) Follow-up: if date selected → require time
            $('#FollowUpDate').change(function () {
                if ($(this).val()) {
                    addRequired('#FollowUpTime', 'Please select follow-up time.');
                } else {
                    removeRequired('#FollowUpTime');
                    $('#FollowUpTime').val('');
                }
                $.validator.unobtrusive.parse('#triageForm');
            });

            // 5) Admission advised -> show consultant box
            function refreshConsultantVisibility() {
                if ($('#chkAdmit').is(':checked')) {
                    $('#consultantBox').show();
                    addRequired('#ConsultantDoctorId', 'Please select a consultant or choose Other.');

                } else {
                    $('#consultantBox').hide();
                    $('#otherDoctorBox').hide();
                    $('#ConsultantDoctorId').val('');
                    $('#OtherDoctorName').val('');
                    removeRequired('#ConsultantDoctorId');
                    removeRequired('#OtherDoctorName');
                }

                $.validator.unobtrusive.parse('#triageForm');
            }

            $('#chkAdmit').change(function () {
                refreshConsultantVisibility();
            });

            // 6) Consultant select -> show other box if "0" (Other)
            $('#doctorSelect').change(function () {
                var val = $(this).val();
                if (val === "0") {
                    $('#otherDoctorBox').show();
                    addRequired('#OtherDoctorName', 'Please enter doctor name.');
                } else {
                    $('#otherDoctorBox').hide();
                    $('#OtherDoctorName').val('');
                    removeRequired('#OtherDoctorName');
                }
                $.validator.unobtrusive.parse('#triageForm');
            });

            // 7) On page load: initialize everything

            // Transportation Mode
            if ($('#TransportationMode').val() === 'Other') {
                addRequired('#TransportationOther', 'Please specify transportation mode.');
            }

            // Follow-up existing values
            if ($('#FollowUpDate').val()) {
                addRequired('#FollowUpTime', 'Please select follow-up time.');
            }

            // Admission / Consultant
            refreshConsultantVisibility();

            var selectedDoctor = $('#doctorSelect').val();
            if (selectedDoctor === "0") {
                $('#otherDoctorBox').show();
                addRequired('#OtherDoctorName', 'Please enter doctor name.');
            }

            // Re-parse all dynamic validation attributes
            $.validator.unobtrusive.parse('#triageForm');
        });
    </script>

}

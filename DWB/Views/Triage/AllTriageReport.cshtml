@model List<DWB.Models.EmergencyTriageAssessment>

@{
    ViewData["Title"] = "Master Triage Register";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string companyName = User.FindFirst("CompName")?.Value ?? "INDUS HEALTHCARE";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" rel="stylesheet" />

<main class="main-wrapper">
    <div class="main-content">

        <!-- PAGE HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-dark mb-0">
                <i class="fas fa-clipboard-list me-2"></i> Master Triage Register
            </h4>
        </div>

        <!-- DASHBOARD CARDS -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white shadow-sm border-0">
                    <div class="card-body p-3">
                        <h6 class="mb-1">Total Assessed</h6>
                        <h3 class="mb-0 fw-bold">@ViewBag.TotalPatients</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white shadow-sm border-0">
                    <div class="card-body p-3">
                        <h6 class="mb-1">Critical (Emergent)</h6>
                        <h3 class="mb-0 fw-bold">@ViewBag.TotalEmergent</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white shadow-sm border-0">
                    <div class="card-body p-3">
                        <h6 class="mb-1">Advised to IPD</h6>
                        <h3 class="mb-0 fw-bold">@ViewBag.TotalAdmissions</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTER CARD -->
        <div class="card shadow-sm rounded-4 border-0 mb-3">
            <div class="card-body">

                <form method="get" asp-action="AllTriageReport"
                      class="row g-3 align-items-end bg-light p-3 rounded">

                    <!-- DATE RANGE -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">DATE RANGE</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="fas fa-calendar-alt"></i>
                            </span>
                            <input type="text"
                                   id="daterange"
                                   name="dateRange"
                                   class="form-control"
                                   value="@ViewBag.DateRange"
                                   autocomplete="off" />
                        </div>
                    </div>

                    <!-- DOCTOR FILTER (ADMIN ONLY) -->
                    @if (User.IsInRole("Admin"))
                    {
                        @* <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">DOCTOR</label>
                            <select name="doctorCode" class="form-select">
                                <option value="">-- All Doctors --</option>
                                @foreach (var doc in ViewBag.DoctorList)
                                {
                                    <option value="@doc.VchDoctorCode"
                                            selected="@(ViewBag.SelectedDoctor == doc.VchDoctorCode)">
                                        @doc.VchCreatedByDoctorName
                                    </option>
                                }
                            </select>
                        </div> *@
                    }

                    <!-- SEARCH BUTTON -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-dark w-100">
                            <i class="fas fa-search me-1"></i> Search
                        </button>
                    </div>
                </form>

            </div>
        </div>

        <!-- TABLE -->
        <div class="card shadow-sm rounded-4 border-0">
            <div class="card-body">

                <div class="table-responsive">
                    <table id="masterTable" class="table table-hover table-bordered align-middle small">
                        <thead class="table-light">
                            <tr>
                                <th>Date / Time</th>
                                <th>UHID</th>
                                <th>Patient Name</th>
                                <th>Age / Sex</th>
                                <th>Category</th>
                                @* <th>Diagnosis</th> *@
                                <th>Outcome</th>
                                <th>Doctor</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    <tr>
                                        <td data-sort="@item.DtArrivalDateTime.ToString("yyyyMMddHHmm")">
                                            @item.DtArrivalDateTime.ToString("dd-MMM-yyyy")<br />
                                            <span class="text-muted">
                                                @item.DtArrivalDateTime.ToString("hh:mm tt")
                                            </span>
                                        </td>
                                        <td>@item.VchUhidNo</td>
                                        <td class="fw-bold">@item.VchPatientName</td>
                                        <td>@item.VchAge / @item.VchSex</td>

                                        <td>
                                            @if (item.VchTriageCategory == "Emergent")
                                            {
                                                <span class="badge bg-danger">Emergent</span>
                                            }
                                            else if (item.VchTriageCategory == "Urgent")
                                            {
                                                <span class="badge bg-warning text-dark">Urgent</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Non-Urgent</span>
                                            }
                                        </td>

                                       @*  <td class="text-truncate"
                                            style="max-width:180px;"
                                            title="@item.VchProvisionalDiagnosis">
                                            @item.VchProvisionalDiagnosis
                                        </td> *@

                                        <td>
                                            @if (item.BitIsAdmissionAdvised == true)
                                            {
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-bed me-1"></i> Admission
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Discharge / Stable</span>
                                            }
                                        </td>

                                        <td>@item.VchCreatedByDoctorName</td>

                                        <td>
                                            <a href="@Url.Action("Print", "Triage", new { id = item.BigintAssessmentId })"
                                               target="_blank"
                                               class="btn btn-sm btn-outline-dark"
                                               title="Print Triage">
                                                <i class="fas fa-print"></i>View
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

    </div>
</main>

@section Scripts {

    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script>
        $(document).ready(function () {

            // DATE RANGE PICKER
            $("#daterange").daterangepicker({
                locale: { format: "DD/MM/YYYY" },
                autoUpdateInput: true
            });

            // DATATABLE
            $('#masterTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Export Excel',
                        className: 'btn btn-success btn-sm',
                        title: 'Master Triage Register - @ViewBag.DateRange'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Print List',
                        className: 'btn btn-secondary btn-sm',
                        title: '@companyName',
                        messageTop:
                            '<div style="text-align:center;font-size:13px;font-weight:bold;margin-bottom:10px;">Triage Report</div>'
                    }
                ],
                pageLength: 50,
                order: [[0, 'desc']],
                language: {
                    search: "Search Records:"
                }
            });

        });
    </script>
}

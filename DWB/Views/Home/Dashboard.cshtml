@{
    Layout = "_Layout";
}
<main class="main-wrapper">
    <div class="main-content">
        <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
            <div class="breadcrumb-title">Welcome @User.Identity.Name</div>

            @*Use for session changes according to company*@
            <div class="ms-auto">
                <div class="btn-group">
                    <button type="button" class="btn btn-primary">Settings</button>
                    <button type="button" class="btn btn-primary split-bg-primary dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-end">
                        <a class="dropdown-item" href="javascript:;">Action</a>
                        <a class="dropdown-item" href="javascript:;">Another action</a>
                        <a class="dropdown-item" href="javascript:;">Something else here</a>
                        <div class="dropdown-divider"></div><a class="dropdown-item" href="javascript:;">Separated link</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-xl-3">
            @* --- NURSING / ADMIN CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("Nursing")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="">
                                    @* Use ?? 0 to handle nulls *@
                                    <h4 class="mb-0">@(ViewBag.OPDCount ?? 0)</h4>
                                </div>
                            </div>
                            <p class="mb-0">Today's OPD patients</p>
                            <div class="mt-3">
                                <a href="@Url.Action("NursingAssessment", "Assessment")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                            </div>
                            <div class="mt-4">
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    Assessed:@(ViewBag.NSAssessment ?? 0)<span class="">Total:@(ViewBag.OPDCount ?? 0)</span>
                                </p>
                                @{
                                    // Safe conversion for calculations
                                    int totalOPDCount = Convert.ToInt32(ViewBag.OPDCount ?? 0);
                                    int totalNSACount = Convert.ToInt32(ViewBag.NSAssessment ?? 0);
                                    double percentage = totalOPDCount > 0
                                    ? (totalNSACount * 100.0) / totalOPDCount : 0;
                                }
                                <div class="progress w-100" style="height:6px;">
                                    <div class="progress-bar bg-grd-purple" style="width: @percentage%">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* --- CONSULTANT / ADMIN CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("Consultant")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="">
                                    @* Use ?? 0 to handle nulls *@
                                    <h4 class="mb-0">@(ViewBag.OPDCount ?? 0)</h4>
                                </div>
                            </div>
                            <p class="mb-0">Today's OPD patients</p>
                            <div class="mt-3">
                                <a href="@Url.Action("DoctorAssessment", "Assessment")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                            </div>
                            <div class="mt-4">
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    Assessed:@(ViewBag.DocAssessment ?? 0)<span class="">@(ViewBag.OPDCount ?? 0)</span>
                                </p>
                                @{
                                    int totalOPDCount = Convert.ToInt32(ViewBag.OPDCount ?? 0);
                                    int totalDocCount = Convert.ToInt32(ViewBag.DocAssessment ?? 0);
                                    double Docpercentage = totalOPDCount > 0
                                    ? (totalDocCount * 100.0) / totalOPDCount : 0;
                                }
                                <div class="progress w-100" style="height: 6px;">
                                    <div class="progress-bar bg-grd-purple" style="width: @Docpercentage%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* --- EMERGENCY OPD PATIENTS (New) --- *@
            <div class="col">
                <div class="card rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="">
                                @* If EmergencyCount is null, it shows 0 *@
                                <h4 class="mb-0">@(ViewBag.EmergencyCount ?? 0)</h4>
                            </div>
                        </div>
                        <p class="mb-0">Emergency OPD Patients</p>
                        <div class="mt-3">
                            <a href="@Url.Action("EmergencyPatient", "Triage")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                        </div>
                        <div class="mt-4">
                            <p class="mb-2 d-flex align-items-center justify-content-between">
                                @* If counts are null, they show 0 *@
                                Assessed:@(ViewBag.EmergencyAssessed ?? 0)<span class="">Total:@(ViewBag.EmergencyCount ?? 0)</span>
                            </p>
                            @{
                                // Safe calculation logic
                                int totalEmgCount = Convert.ToInt32(ViewBag.EmergencyCount ?? 0);
                                int totalEmgAssessed = Convert.ToInt32(ViewBag.EmergencyAssessed ?? 0);
                                double emgPercentage = totalEmgCount > 0
                                ? (totalEmgAssessed * 100.0) / totalEmgCount : 0;
                            }
                            <div class="progress w-100" style="height: 6px;">
                                <div class="progress-bar bg-grd-purple" style="width: @emgPercentage%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* --- COUNSELING CARD --- *@
            <div class="col">
                <div class="card rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="">
                                @* If Coun is null, it shows 0 *@
                                <h4 class="mb-0">@(ViewBag.Coun ?? 0)</h4>
                            </div>
                        </div>
                        <p class="mb-0">Counseling's</p>
                        <div class="mt-3">
                            <a href="@Url.Action("GetCounseling", "Counseling")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                        </div>
                        <div class="mt-4">
                            <p class="mb-2 d-flex align-items-center justify-content-between">
                                #AppCount<span class="">#total2day</span>
                            </p>
                            <div class="progress w-100" style="height: 6px;">
                                <div class="progress-bar bg-grd-purple" style="width: 65%"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    @* For password update *@
    <div class="modal fade" id="passwordUpdate" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="modal-content-placeholder"></div>
                </div>
            </div>
        </div>
    </div>
</main>
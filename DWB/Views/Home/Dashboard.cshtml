@{
    Layout = "_Layout";
}
<main class="main-wrapper">
    <div class="main-content">
        <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
            <div class="breadcrumb-title">Welcome @User.Identity.Name</div>

            @*Use for session changes according to company*@
            <div class="ms-auto">
                <div class="btn-group">
                    <button type="button" class="btn btn-primary">Settings</button>
                    <button type="button" class="btn btn-primary split-bg-primary dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-end">
                        <a class="dropdown-item" href="javascript:;">Action</a>
                        <a class="dropdown-item" href="javascript:;">Another action</a>
                        <a class="dropdown-item" href="javascript:;">Something else here</a>
                        <div class="dropdown-divider"></div><a class="dropdown-item" href="javascript:;">Separated link</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-xl-3">

            @* --- NURSING / ADMIN CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("Nursing")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                @* Added ID: opd-count *@
                                <h4 class="mb-0" id="opd-count"><span class="spinner-border spinner-border-sm"></span></h4>
                            </div>
                            <p class="mb-0">Today's OPD patients</p>

                            <div class="mt-3">
                                <a href="@Url.Action("NursingAssessment", "Assessment")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4">View Detail</a>
                            </div>

                            <div class="mt-4">
                                @* Added IDs for Assessed and Total *@
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    <span>Assessed: <span id="ns-assessed">0</span></span>
                                    <span>Total: <span id="ns-total">0</span></span>
                                </p>
                                <div class="progress w-100" style="height:6px;">
                                    @* Added ID for Progress Bar *@
                                    <div id="ns-progress" class="progress-bar bg-grd-purple" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* --- CONSULTANT / ADMIN CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("Consultant")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                @* Reuse ID opd-count-doc to ensure we can update distinct elements if needed, 
                                but usually we can use a class or just repeat the ID if careful. 
                                Better: use unique IDs. *@
                                <h4 class="mb-0" id="doc-opd-count"><span class="spinner-border spinner-border-sm"></span></h4>
                            </div>
                            <p class="mb-0">Today's OPD patients</p>
                            <div class="mt-3">
                                <a href="@Url.Action("DoctorAssessment", "Assessment")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4">View Detail</a>
                            </div>
                            <div class="mt-4">
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    <span>Assessed: <span id="doc-assessed">0</span></span>
                                    <span><span id="doc-total">0</span></span>
                                </p>
                                <div class="progress w-100" style="height: 6px;">
                                    <div id="doc-progress" class="progress-bar bg-grd-purple" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            @* --- EMERGENCY OPD PATIENTS CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("EMO")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="">
                                    @* ID: emg-count *@
                                    <h4 class="mb-0" id="emg-count">
                                        <span class="spinner-border spinner-border-sm"></span>
                                    </h4>
                                </div>
                            </div>
                            <p class="mb-0">Emergency OPD Patients</p>

                            <div class="mt-3">
                                <a href="@Url.Action("EmergencyPatient", "Triage")" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                            </div>

                            <div class="mt-4">
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    @* IDs: emg-assessed and emg-total *@
                                    <span>Assessed: <span id="emg-assessed">0</span></span>
                                    <span>Total: <span id="emg-total">0</span></span>
                                </p>

                                <div class="progress w-100" style="height: 6px;">
                                    @* ID: emg-progress *@
                                    <div id="emg-progress" class="progress-bar bg-grd-purple" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* --- COUNSELING CARD --- *@
            @if ((User.IsInRole("Admin")) || (User.IsInRole("Counselor")))
            {
                <div class="col">
                    <div class="card rounded-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="">
                                    @* ID: coun-count *@
                                    <h4 class="mb-0" id="coun-count">
                                        <span class="spinner-border spinner-border-sm"></span>
                                    </h4>
                                </div>
                            </div>
                            <p class="mb-0">Counseling Sessions</p>

                            <div class="mt-3">
                                <a href="@Url.Action("GetCounseling", "Counseling", new { Type = "Counseling"})" class="btn btn-grd btn-grd-primary btn-sm rounded-4 border-0 px-4" style="transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7" onmouseout="this.style.opacity=2">View Detail</a>
                            </div>

                            <div class="mt-4">
                                <p class="mb-2 d-flex align-items-center justify-content-between">
                                    @* IDs: emg-assessed and emg-total *@
                                    <span>Assessed: <span id="council-assessed">0</span></span>
                                    <span>Total: <span id="council-total">0</span></span>
                                </p>
                                <div class="progress w-100" style="height: 6px;">                                  
                                    <div class="progress-bar bg-grd-purple" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
    </div>

    @* For password update *@
    <div class="modal fade" id="passwordUpdate" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="modal-content-placeholder"></div>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        $(document).ready(function () {
            loadDashboardData();
        });

        function loadDashboardData() {
            $.ajax({
                url: '@Url.Action("GetDashboardStats", "Home")',
                type: 'GET',
                 cache: false, 
                success: function (data) {

                    // --- 1. Nursing / Admin ---
                    $('#opd-count').text(data.opdCount);
                    $('#ns-assessed').text(data.nsAssessment);
                    $('#ns-total').text(data.opdCount);
                    let opdTotal = parseInt(data.opdCount) || 0;
                    let nsCount = parseInt(data.nsAssessment) || 0;
                    let nsPercent = opdTotal > 0 ? (nsCount / opdTotal) * 100 : 0;
                    $('#ns-progress').css('width', nsPercent + '%');

                    // --- 2. Consultant ---
                    if ($('#doc-opd-count').length) {
                        $('#doc-opd-count').text(data.opdCount);
                        $('#doc-assessed').text(data.docAssessment);
                        $('#doc-total').text(data.opdCount);
                        let docCount = parseInt(data.docAssessment) || 0;
                        let docPercent = opdTotal > 0 ? (docCount / opdTotal) * 100 : 0;
                        $('#doc-progress').css('width', docPercent + '%');
                    }

                    // --- 3. Emergency ---
                    if ($('#emg-count').length) {
                        $('#emg-count').text(data.emergencyCount);
                        $('#emg-assessed').text(data.emergencyAssessed);
                        $('#emg-total').text(data.emergencyCount);
                        let emgTotal = parseInt(data.emergencyCount) || 0;
                        let emgAssessed = parseInt(data.emergencyAssessed) || 0;
                        let emgPercent = emgTotal > 0 ? (emgAssessed / emgTotal) * 100 : 0;
                        $('#emg-progress').css('width', emgPercent + '%');
                    }

                    // --- 4. Counseling (FIXED) ---
                    if ($('#coun-count').length) {
                        // Main Count
                        $('#coun-count').text(data.counselingCount);

                        // Details (Assessed vs Total)
                        // Note: IDs must match your HTML: council-assessed / council-total
                        $('#council-assessed').text(data.counselingAssessed);
                        $('#council-total').text(data.counselingCount);

                        // Progress Bar Logic
                        let counTotal = parseInt(data.counselingCount) || 0;
                        let counAssessed = parseInt(data.counselingAssessed) || 0;
                        let counPercent = counTotal > 0 ? (counAssessed / counTotal) * 100 : 0;

                        // Find the progress bar inside the Counseling card
                        // Since you didn't give the progress bar a unique ID in the HTML,
                        // we can find it relative to the count ID, OR you should add id="coun-progress" to HTML.
                        // For now, assuming you added id="coun-progress" to the HTML:
                        $('#coun-progress').css('width', counPercent + '%');
                    }
                },
                error: function (error) {
                    console.log("Error loading dashboard data", error);
                    $('#opd-count').text("0");
                }
            });
        }
    </script>
}